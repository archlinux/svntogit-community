# Maintainer: Felix Yan <felixonmars@archlinux.org>
# Contributor: maz-1 <loveayawaka@gmail.com>

pkgname=ndiswrapper-arch
pkgver=1.62
pkgrel=2
pkgdesc="Module for NDIS (Windows Network Drivers) drivers supplied by vendors, kernel module for Arch kernel"
arch=('x86_64')
url="https://sourceforge.net/projects/ndiswrapper/"
license=('GPL')
makedepends=('linux-headers')
provides=('NDISWRAPPER-MODULE')
replaces=('ndiswrapper-module')
source=("https://sourceforge.net/projects/ndiswrapper/files/stable/ndiswrapper-$pkgver.tar.gz"
        'linux-5.3.patch')
sha512sums=('a6e111bc699572642e44d6d31cc2f06374648a01b8dd7dd4e74d6ad5e187e39f99faee38f792c83a94d4618ae4d8866914fb3f60b1d80e838a753285ea7cf783'
            'c404f35280534b172235c5c578657d7a30ac2253c7c2abedd65a183d09390e95e7c3030cb409accb4d198ff0411482f8029f8664418c99d5672f92e9c733801d')

prepare() {
  cd ndiswrapper-$pkgver
  patch --no-backup-if-mismatch -p2 -i "$srcdir"/linux-5.3.patch
}

build() {
  _kernver="$(</usr/src/linux/version)"

  cd ndiswrapper-$pkgver
  make -C driver KVERS_UNAME="$_kernver"
}

package() {
  depends=('linux')

  _extradir="/usr/lib/modules/$(</usr/src/linux/version)/extramodules"
  cd ndiswrapper-$pkgver
  install -Dt "$pkgdir$_extradir" -m644 driver/*.ko
  find "$pkgdir" -name '*.ko' -exec xz {} +
}
