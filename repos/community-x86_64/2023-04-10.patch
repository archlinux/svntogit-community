diff --git a/.devcontainer/build.sh b/.devcontainer/build.sh
new file mode 100755
index 0000000..cf64d35
--- /dev/null
+++ b/.devcontainer/build.sh
@@ -0,0 +1,15 @@
+#!/bin/bash
+
+set -e
+
+DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
+IMAGE="haxe/neko_devcontainer"
+TAG="$IMAGE:$(date +%Y%m%d%H%M%S)"
+
+set -x
+
+docker login
+docker buildx use neko || docker buildx create --use --name neko
+docker buildx build --pull --platform linux/amd64,linux/arm64 --tag "$TAG" --push "$DIR"
+
+sed -i -e "s#$IMAGE:[0-9]*#$TAG#g" "$DIR/docker-compose.yml"
diff --git a/.devcontainer/devcontainer.json b/.devcontainer/devcontainer.json
new file mode 100644
index 0000000..9e4c8d4
--- /dev/null
+++ b/.devcontainer/devcontainer.json
@@ -0,0 +1,27 @@
+// For format details, see https://aka.ms/devcontainer.json. For config options, see the README at:
+// https://github.com/microsoft/vscode-dev-containers/tree/v0.202.5/containers/docker-from-docker-compose
+{
+	"name": "neko",
+	"dockerComposeFile": "docker-compose.yml",
+	"service": "workspace",
+	"workspaceFolder": "/workspace",
+
+	// Use this environment variable if you need to bind mount your local source code into a new container.
+	"remoteEnv": {
+		"LOCAL_WORKSPACE_FOLDER": "${localWorkspaceFolder}"
+	},
+	
+	// Set *default* container specific settings.json values on container create.
+	"settings": {},
+
+	"extensions": [
+		"ms-azuretools.vscode-docker",
+		"twxs.cmake",
+		"ms-vscode.cpptools",
+		"ms-vscode.cpptools-themes",
+		"jeff-hykin.better-cpp-syntax",
+		"earthly.earthfile-syntax-highlighting",
+	],
+
+	"remoteUser": "vscode"
+}
\ No newline at end of file
diff --git a/.devcontainer/direnv.toml b/.devcontainer/direnv.toml
new file mode 100644
index 0000000..16f67cd
--- /dev/null
+++ b/.devcontainer/direnv.toml
@@ -0,0 +1,2 @@
+[whitelist]
+prefix = [ "/workspace" ]
\ No newline at end of file
diff --git a/.devcontainer/docker-compose.yml b/.devcontainer/docker-compose.yml
new file mode 100644
index 0000000..c3abb57
--- /dev/null
+++ b/.devcontainer/docker-compose.yml
@@ -0,0 +1,32 @@
+version: '3'
+
+services:
+  workspace:
+    # To update, use `earthly --push +devcontainer-rebuild`
+    image: haxe/neko_devcontainer:20221124162640
+    init: true
+    volumes:
+      - ..:/workspace:cached
+      # Forwards the local Docker socket to the container.
+      - /var/run/docker.sock:/var/run/docker-host.sock
+    environment:
+      - EARTHLY_BUILDKIT_HOST=tcp://earthly:8372
+      # - EARTHLY_SECRET_FILES=.envrc=/workspace/.envrc
+      - EARTHLY_USE_INLINE_CACHE=true
+      - EARTHLY_SAVE_INLINE_CACHE=true
+    entrypoint: /usr/local/share/docker-init.sh
+    command: sleep infinity
+    user: vscode
+  earthly:
+    image: earthly/buildkitd:v0.6.30
+    privileged: true
+    environment:
+      - BUILDKIT_TCP_TRANSPORT_ENABLED=true
+    expose:
+      - 8372
+    volumes:
+      # https://docs.earthly.dev/docs/guides/using-the-earthly-docker-images/buildkit-standalone#earthly_tmp_dir
+      - earthly-tmp:/tmp/earthly:rw
+
+volumes:
+  earthly-tmp:
diff --git a/.devcontainer/library-scripts/common-debian.sh b/.devcontainer/library-scripts/common-debian.sh
new file mode 100644
index 0000000..f453a6b
--- /dev/null
+++ b/.devcontainer/library-scripts/common-debian.sh
@@ -0,0 +1,454 @@
+#!/usr/bin/env bash
+#-------------------------------------------------------------------------------------------------------------
+# Copyright (c) Microsoft Corporation. All rights reserved.
+# Licensed under the MIT License. See https://go.microsoft.com/fwlink/?linkid=2090316 for license information.
+#-------------------------------------------------------------------------------------------------------------
+#
+# Docs: https://github.com/microsoft/vscode-dev-containers/blob/main/script-library/docs/common.md
+# Maintainer: The VS Code and Codespaces Teams
+#
+# Syntax: ./common-debian.sh [install zsh flag] [username] [user UID] [user GID] [upgrade packages flag] [install Oh My Zsh! flag] [Add non-free packages]
+
+set -e
+
+INSTALL_ZSH=${1:-"true"}
+USERNAME=${2:-"automatic"}
+USER_UID=${3:-"automatic"}
+USER_GID=${4:-"automatic"}
+UPGRADE_PACKAGES=${5:-"true"}
+INSTALL_OH_MYS=${6:-"true"}
+ADD_NON_FREE_PACKAGES=${7:-"false"}
+SCRIPT_DIR="$(cd $(dirname "${BASH_SOURCE[0]}") && pwd)"
+MARKER_FILE="/usr/local/etc/vscode-dev-containers/common"
+
+if [ "$(id -u)" -ne 0 ]; then
+    echo -e 'Script must be run as root. Use sudo, su, or add "USER root" to your Dockerfile before running this script.'
+    exit 1
+fi
+
+# Ensure that login shells get the correct path if the user updated the PATH using ENV.
+rm -f /etc/profile.d/00-restore-env.sh
+echo "export PATH=${PATH//$(sh -lc 'echo $PATH')/\$PATH}" > /etc/profile.d/00-restore-env.sh
+chmod +x /etc/profile.d/00-restore-env.sh
+
+# If in automatic mode, determine if a user already exists, if not use vscode
+if [ "${USERNAME}" = "auto" ] || [ "${USERNAME}" = "automatic" ]; then
+    USERNAME=""
+    POSSIBLE_USERS=("vscode" "node" "codespace" "$(awk -v val=1000 -F ":" '$3==val{print $1}' /etc/passwd)")
+    for CURRENT_USER in ${POSSIBLE_USERS[@]}; do
+        if id -u ${CURRENT_USER} > /dev/null 2>&1; then
+            USERNAME=${CURRENT_USER}
+            break
+        fi
+    done
+    if [ "${USERNAME}" = "" ]; then
+        USERNAME=vscode
+    fi
+elif [ "${USERNAME}" = "none" ]; then
+    USERNAME=root
+    USER_UID=0
+    USER_GID=0
+fi
+
+# Load markers to see which steps have already run
+if [ -f "${MARKER_FILE}" ]; then
+    echo "Marker file found:"
+    cat "${MARKER_FILE}"
+    source "${MARKER_FILE}"
+fi
+
+# Ensure apt is in non-interactive to avoid prompts
+export DEBIAN_FRONTEND=noninteractive
+
+# Function to call apt-get if needed
+apt_get_update_if_needed()
+{
+    if [ ! -d "/var/lib/apt/lists" ] || [ "$(ls /var/lib/apt/lists/ | wc -l)" = "0" ]; then
+        echo "Running apt-get update..."
+        apt-get update
+    else
+        echo "Skipping apt-get update."
+    fi
+}
+
+# Run install apt-utils to avoid debconf warning then verify presence of other common developer tools and dependencies
+if [ "${PACKAGES_ALREADY_INSTALLED}" != "true" ]; then
+
+    package_list="apt-utils \
+        openssh-client \
+        gnupg2 \
+        dirmngr \
+        iproute2 \
+        procps \
+        lsof \
+        htop \
+        net-tools \
+        psmisc \
+        curl \
+        wget \
+        rsync \
+        ca-certificates \
+        unzip \
+        zip \
+        nano \
+        vim-tiny \
+        less \
+        jq \
+        lsb-release \
+        apt-transport-https \
+        dialog \
+        libc6 \
+        libgcc1 \
+        libkrb5-3 \
+        libgssapi-krb5-2 \
+        libicu[0-9][0-9] \
+        liblttng-ust0 \
+        libstdc++6 \
+        zlib1g \
+        locales \
+        sudo \
+        ncdu \
+        man-db \
+        strace \
+        manpages \
+        manpages-dev \
+        init-system-helpers"
+        
+    # Needed for adding manpages-posix and manpages-posix-dev which are non-free packages in Debian
+    if [ "${ADD_NON_FREE_PACKAGES}" = "true" ]; then
+        # Bring in variables from /etc/os-release like VERSION_CODENAME
+        . /etc/os-release
+        sed -i -E "s/deb http:\/\/(deb|httpredir)\.debian\.org\/debian ${VERSION_CODENAME} main/deb http:\/\/\1\.debian\.org\/debian ${VERSION_CODENAME} main contrib non-free/" /etc/apt/sources.list
+        sed -i -E "s/deb-src http:\/\/(deb|httredir)\.debian\.org\/debian ${VERSION_CODENAME} main/deb http:\/\/\1\.debian\.org\/debian ${VERSION_CODENAME} main contrib non-free/" /etc/apt/sources.list
+        sed -i -E "s/deb http:\/\/(deb|httpredir)\.debian\.org\/debian ${VERSION_CODENAME}-updates main/deb http:\/\/\1\.debian\.org\/debian ${VERSION_CODENAME}-updates main contrib non-free/" /etc/apt/sources.list
+        sed -i -E "s/deb-src http:\/\/(deb|httpredir)\.debian\.org\/debian ${VERSION_CODENAME}-updates main/deb http:\/\/\1\.debian\.org\/debian ${VERSION_CODENAME}-updates main contrib non-free/" /etc/apt/sources.list
+        sed -i "s/deb http:\/\/security\.debian\.org\/debian-security ${VERSION_CODENAME}\/updates main/deb http:\/\/security\.debian\.org\/debian-security ${VERSION_CODENAME}\/updates main contrib non-free/" /etc/apt/sources.list
+        sed -i "s/deb-src http:\/\/security\.debian\.org\/debian-security ${VERSION_CODENAME}\/updates main/deb http:\/\/security\.debian\.org\/debian-security ${VERSION_CODENAME}\/updates main contrib non-free/" /etc/apt/sources.list
+        sed -i "s/deb http:\/\/deb\.debian\.org\/debian ${VERSION_CODENAME}-backports main/deb http:\/\/deb\.debian\.org\/debian ${VERSION_CODENAME}-backports main contrib non-free/" /etc/apt/sources.list 
+        sed -i "s/deb-src http:\/\/deb\.debian\.org\/debian ${VERSION_CODENAME}-backports main/deb http:\/\/deb\.debian\.org\/debian ${VERSION_CODENAME}-backports main contrib non-free/" /etc/apt/sources.list
+        # Handle bullseye location for security https://www.debian.org/releases/bullseye/amd64/release-notes/ch-information.en.html
+        sed -i "s/deb http:\/\/security\.debian\.org\/debian-security ${VERSION_CODENAME}-security main/deb http:\/\/security\.debian\.org\/debian-security ${VERSION_CODENAME}-security main contrib non-free/" /etc/apt/sources.list
+        sed -i "s/deb-src http:\/\/security\.debian\.org\/debian-security ${VERSION_CODENAME}-security main/deb http:\/\/security\.debian\.org\/debian-security ${VERSION_CODENAME}-security main contrib non-free/" /etc/apt/sources.list
+        echo "Running apt-get update..."
+        apt-get update
+        package_list="${package_list} manpages-posix manpages-posix-dev"
+    else
+        apt_get_update_if_needed
+    fi
+
+    # Install libssl1.1 if available
+    if [[ ! -z $(apt-cache --names-only search ^libssl1.1$) ]]; then
+        package_list="${package_list}       libssl1.1"
+    fi
+    
+    # Install appropriate version of libssl1.0.x if available
+    libssl_package=$(dpkg-query -f '${db:Status-Abbrev}\t${binary:Package}\n' -W 'libssl1\.0\.?' 2>&1 || echo '')
+    if [ "$(echo "$LIlibssl_packageBSSL" | grep -o 'libssl1\.0\.[0-9]:' | uniq | sort | wc -l)" -eq 0 ]; then
+        if [[ ! -z $(apt-cache --names-only search ^libssl1.0.2$) ]]; then
+            # Debian 9
+            package_list="${package_list}       libssl1.0.2"
+        elif [[ ! -z $(apt-cache --names-only search ^libssl1.0.0$) ]]; then
+            # Ubuntu 18.04, 16.04, earlier
+            package_list="${package_list}       libssl1.0.0"
+        fi
+    fi
+
+    echo "Packages to verify are installed: ${package_list}"
+    apt-get -y install --no-install-recommends ${package_list} 2> >( grep -v 'debconf: delaying package configuration, since apt-utils is not installed' >&2 )
+        
+    # Install git if not already installed (may be more recent than distro version)
+    if ! type git > /dev/null 2>&1; then
+        apt-get -y install --no-install-recommends git
+    fi
+
+    PACKAGES_ALREADY_INSTALLED="true"
+fi
+
+# Get to latest versions of all packages
+if [ "${UPGRADE_PACKAGES}" = "true" ]; then
+    apt_get_update_if_needed
+    apt-get -y upgrade --no-install-recommends
+    apt-get autoremove -y
+fi
+
+# Ensure at least the en_US.UTF-8 UTF-8 locale is available.
+# Common need for both applications and things like the agnoster ZSH theme.
+if [ "${LOCALE_ALREADY_SET}" != "true" ] && ! grep -o -E '^\s*en_US.UTF-8\s+UTF-8' /etc/locale.gen > /dev/null; then
+    echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen 
+    locale-gen
+    LOCALE_ALREADY_SET="true"
+fi
+
+# Create or update a non-root user to match UID/GID.
+group_name="${USERNAME}"
+if id -u ${USERNAME} > /dev/null 2>&1; then
+    # User exists, update if needed
+    if [ "${USER_GID}" != "automatic" ] && [ "$USER_GID" != "$(id -g $USERNAME)" ]; then 
+        group_name="$(id -gn $USERNAME)"
+        groupmod --gid $USER_GID ${group_name}
+        usermod --gid $USER_GID $USERNAME
+    fi
+    if [ "${USER_UID}" != "automatic" ] && [ "$USER_UID" != "$(id -u $USERNAME)" ]; then 
+        usermod --uid $USER_UID $USERNAME
+    fi
+else
+    # Create user
+    if [ "${USER_GID}" = "automatic" ]; then
+        groupadd $USERNAME
+    else
+        groupadd --gid $USER_GID $USERNAME
+    fi
+    if [ "${USER_UID}" = "automatic" ]; then 
+        useradd -s /bin/bash --gid $USERNAME -m $USERNAME
+    else
+        useradd -s /bin/bash --uid $USER_UID --gid $USERNAME -m $USERNAME
+    fi
+fi
+
+# Add add sudo support for non-root user
+if [ "${USERNAME}" != "root" ] && [ "${EXISTING_NON_ROOT_USER}" != "${USERNAME}" ]; then
+    echo $USERNAME ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/$USERNAME
+    chmod 0440 /etc/sudoers.d/$USERNAME
+    EXISTING_NON_ROOT_USER="${USERNAME}"
+fi
+
+# ** Shell customization section **
+if [ "${USERNAME}" = "root" ]; then 
+    user_rc_path="/root"
+else
+    user_rc_path="/home/${USERNAME}"
+fi
+
+# Restore user .bashrc defaults from skeleton file if it doesn't exist or is empty
+if [ ! -f "${user_rc_path}/.bashrc" ] || [ ! -s "${user_rc_path}/.bashrc" ] ; then
+    cp  /etc/skel/.bashrc "${user_rc_path}/.bashrc"
+fi
+
+# Restore user .profile defaults from skeleton file if it doesn't exist or is empty
+if  [ ! -f "${user_rc_path}/.profile" ] || [ ! -s "${user_rc_path}/.profile" ] ; then
+    cp  /etc/skel/.profile "${user_rc_path}/.profile"
+fi
+
+# .bashrc/.zshrc snippet
+rc_snippet="$(cat << 'EOF'
+
+if [ -z "${USER}" ]; then export USER=$(whoami); fi
+if [[ "${PATH}" != *"$HOME/.local/bin"* ]]; then export PATH="${PATH}:$HOME/.local/bin"; fi
+
+# Display optional first run image specific notice if configured and terminal is interactive
+if [ -t 1 ] && [[ "${TERM_PROGRAM}" = "vscode" || "${TERM_PROGRAM}" = "codespaces" ]] && [ ! -f "$HOME/.config/vscode-dev-containers/first-run-notice-already-displayed" ]; then
+    if [ -f "/usr/local/etc/vscode-dev-containers/first-run-notice.txt" ]; then
+        cat "/usr/local/etc/vscode-dev-containers/first-run-notice.txt"
+    elif [ -f "/workspaces/.codespaces/shared/first-run-notice.txt" ]; then
+        cat "/workspaces/.codespaces/shared/first-run-notice.txt"
+    fi
+    mkdir -p "$HOME/.config/vscode-dev-containers"
+    # Mark first run notice as displayed after 10s to avoid problems with fast terminal refreshes hiding it
+    ((sleep 10s; touch "$HOME/.config/vscode-dev-containers/first-run-notice-already-displayed") &)
+fi
+
+# Set the default git editor if not already set
+if [ -z "$(git config --get core.editor)" ] && [ -z "${GIT_EDITOR}" ]; then
+    if  [ "${TERM_PROGRAM}" = "vscode" ]; then
+        if [[ -n $(command -v code-insiders) &&  -z $(command -v code) ]]; then 
+            export GIT_EDITOR="code-insiders --wait"
+        else 
+            export GIT_EDITOR="code --wait"
+        fi
+    fi
+fi
+
+EOF
+)"
+
+# code shim, it fallbacks to code-insiders if code is not available
+cat << 'EOF' > /usr/local/bin/code
+#!/bin/sh
+
+get_in_path_except_current() {
+    which -a "$1" | grep -A1 "$0" | grep -v "$0"
+}
+
+code="$(get_in_path_except_current code)"
+
+if [ -n "$code" ]; then
+    exec "$code" "$@"
+elif [ "$(command -v code-insiders)" ]; then
+    exec code-insiders "$@"
+else
+    echo "code or code-insiders is not installed" >&2
+    exit 127
+fi
+EOF
+chmod +x /usr/local/bin/code
+
+# systemctl shim - tells people to use 'service' if systemd is not running
+cat << 'EOF' > /usr/local/bin/systemctl
+#!/bin/sh
+set -e
+if [ -d "/run/systemd/system" ]; then
+    exec /bin/systemctl/systemctl "$@"
+else
+    echo '\n"systemd" is not running in this container due to its overhead.\nUse the "service" command to start services intead. e.g.: \n\nservice --status-all'
+fi
+EOF
+chmod +x /usr/local/bin/systemctl
+
+# Codespaces bash and OMZ themes - partly inspired by https://github.com/ohmyzsh/ohmyzsh/blob/master/themes/robbyrussell.zsh-theme
+codespaces_bash="$(cat \
+<<'EOF'
+
+# Codespaces bash prompt theme
+__bash_prompt() {
+    local userpart='`export XIT=$? \
+        && [ ! -z "${GITHUB_USER}" ] && echo -n "\[\033[0;32m\]@${GITHUB_USER} " || echo -n "\[\033[0;32m\]\u " \
+        && [ "$XIT" -ne "0" ] && echo -n "\[\033[1;31m\]➜" || echo -n "\[\033[0m\]➜"`'
+    local gitbranch='`\
+        if [ "$(git config --get codespaces-theme.hide-status 2>/dev/null)" != 1 ]; then \
+            export BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || git rev-parse --short HEAD 2>/dev/null); \
+            if [ "${BRANCH}" != "" ]; then \
+                echo -n "\[\033[0;36m\](\[\033[1;31m\]${BRANCH}" \
+                && if git ls-files --error-unmatch -m --directory --no-empty-directory -o --exclude-standard ":/*" > /dev/null 2>&1; then \
+                        echo -n " \[\033[1;33m\]✗"; \
+                fi \
+                && echo -n "\[\033[0;36m\]) "; \
+            fi; \
+        fi`'
+    local lightblue='\[\033[1;34m\]'
+    local removecolor='\[\033[0m\]'
+    PS1="${userpart} ${lightblue}\w ${gitbranch}${removecolor}\$ "
+    unset -f __bash_prompt
+}
+__bash_prompt
+
+EOF
+)"
+
+codespaces_zsh="$(cat \
+<<'EOF'
+# Codespaces zsh prompt theme
+__zsh_prompt() {
+    local prompt_username
+    if [ ! -z "${GITHUB_USER}" ]; then 
+        prompt_username="@${GITHUB_USER}"
+    else
+        prompt_username="%n"
+    fi
+    PROMPT="%{$fg[green]%}${prompt_username} %(?:%{$reset_color%}➜ :%{$fg_bold[red]%}➜ )" # User/exit code arrow
+    PROMPT+='%{$fg_bold[blue]%}%(5~|%-1~/…/%3~|%4~)%{$reset_color%} ' # cwd
+    PROMPT+='$([ "$(git config --get codespaces-theme.hide-status 2>/dev/null)" != 1 ] && git_prompt_info)' # Git status
+    PROMPT+='%{$fg[white]%}$ %{$reset_color%}'
+    unset -f __zsh_prompt
+}
+ZSH_THEME_GIT_PROMPT_PREFIX="%{$fg_bold[cyan]%}(%{$fg_bold[red]%}"
+ZSH_THEME_GIT_PROMPT_SUFFIX="%{$reset_color%} "
+ZSH_THEME_GIT_PROMPT_DIRTY=" %{$fg_bold[yellow]%}✗%{$fg_bold[cyan]%})"
+ZSH_THEME_GIT_PROMPT_CLEAN="%{$fg_bold[cyan]%})"
+__zsh_prompt
+
+EOF
+)"
+
+# Add RC snippet and custom bash prompt
+if [ "${RC_SNIPPET_ALREADY_ADDED}" != "true" ]; then
+    echo "${rc_snippet}" >> /etc/bash.bashrc
+    echo "${codespaces_bash}" >> "${user_rc_path}/.bashrc"
+    echo 'export PROMPT_DIRTRIM=4' >> "${user_rc_path}/.bashrc"
+    if [ "${USERNAME}" != "root" ]; then
+        echo "${codespaces_bash}" >> "/root/.bashrc"
+        echo 'export PROMPT_DIRTRIM=4' >> "/root/.bashrc"
+    fi
+    chown ${USERNAME}:${group_name} "${user_rc_path}/.bashrc"
+    RC_SNIPPET_ALREADY_ADDED="true"
+fi
+
+# Optionally install and configure zsh and Oh My Zsh!
+if [ "${INSTALL_ZSH}" = "true" ]; then
+    if ! type zsh > /dev/null 2>&1; then
+        apt_get_update_if_needed
+        apt-get install -y zsh
+    fi
+    if [ "${ZSH_ALREADY_INSTALLED}" != "true" ]; then
+        echo "${rc_snippet}" >> /etc/zsh/zshrc
+        ZSH_ALREADY_INSTALLED="true"
+    fi
+
+    # Adapted, simplified inline Oh My Zsh! install steps that adds, defaults to a codespaces theme.
+    # See https://github.com/ohmyzsh/ohmyzsh/blob/master/tools/install.sh for official script.
+    oh_my_install_dir="${user_rc_path}/.oh-my-zsh"
+    if [ ! -d "${oh_my_install_dir}" ] && [ "${INSTALL_OH_MYS}" = "true" ]; then
+        template_path="${oh_my_install_dir}/templates/zshrc.zsh-template"
+        user_rc_file="${user_rc_path}/.zshrc"
+        umask g-w,o-w
+        mkdir -p ${oh_my_install_dir}
+        git clone --depth=1 \
+            -c core.eol=lf \
+            -c core.autocrlf=false \
+            -c fsck.zeroPaddedFilemode=ignore \
+            -c fetch.fsck.zeroPaddedFilemode=ignore \
+            -c receive.fsck.zeroPaddedFilemode=ignore \
+            "https://github.com/ohmyzsh/ohmyzsh" "${oh_my_install_dir}" 2>&1
+        echo -e "$(cat "${template_path}")\nDISABLE_AUTO_UPDATE=true\nDISABLE_UPDATE_PROMPT=true" > ${user_rc_file}
+        sed -i -e 's/ZSH_THEME=.*/ZSH_THEME="codespaces"/g' ${user_rc_file}
+
+        mkdir -p ${oh_my_install_dir}/custom/themes
+        echo "${codespaces_zsh}" > "${oh_my_install_dir}/custom/themes/codespaces.zsh-theme"
+        # Shrink git while still enabling updates
+        cd "${oh_my_install_dir}"
+        git repack -a -d -f --depth=1 --window=1
+        # Copy to non-root user if one is specified
+        if [ "${USERNAME}" != "root" ]; then
+            cp -rf "${user_rc_file}" "${oh_my_install_dir}" /root
+            chown -R ${USERNAME}:${group_name} "${user_rc_path}"
+        fi
+    fi
+fi
+
+# Persist image metadata info, script if meta.env found in same directory
+meta_info_script="$(cat << 'EOF'
+#!/bin/sh
+. /usr/local/etc/vscode-dev-containers/meta.env
+
+# Minimal output
+if [ "$1" = "version" ] || [ "$1" = "image-version" ]; then
+    echo "${VERSION}"
+    exit 0
+elif [ "$1" = "release" ]; then
+    echo "${GIT_REPOSITORY_RELEASE}"
+    exit 0
+elif [ "$1" = "content" ] || [ "$1" = "content-url" ] || [ "$1" = "contents" ] || [ "$1" = "contents-url" ]; then
+    echo "${CONTENTS_URL}"
+    exit 0
+fi
+
+#Full output
+echo
+echo "Development container image information"
+echo
+if [ ! -z "${VERSION}" ]; then echo "- Image version: ${VERSION}"; fi
+if [ ! -z "${DEFINITION_ID}" ]; then echo "- Definition ID: ${DEFINITION_ID}"; fi
+if [ ! -z "${VARIANT}" ]; then echo "- Variant: ${VARIANT}"; fi
+if [ ! -z "${GIT_REPOSITORY}" ]; then echo "- Source code repository: ${GIT_REPOSITORY}"; fi
+if [ ! -z "${GIT_REPOSITORY_RELEASE}" ]; then echo "- Source code release/branch: ${GIT_REPOSITORY_RELEASE}"; fi
+if [ ! -z "${BUILD_TIMESTAMP}" ]; then echo "- Timestamp: ${BUILD_TIMESTAMP}"; fi
+if [ ! -z "${CONTENTS_URL}" ]; then echo && echo "More info: ${CONTENTS_URL}"; fi
+echo
+EOF
+)"
+if [ -f "${SCRIPT_DIR}/meta.env" ]; then
+    mkdir -p /usr/local/etc/vscode-dev-containers/
+    cp -f "${SCRIPT_DIR}/meta.env" /usr/local/etc/vscode-dev-containers/meta.env
+    echo "${meta_info_script}" > /usr/local/bin/devcontainer-info
+    chmod +x /usr/local/bin/devcontainer-info
+fi
+
+# Write marker file
+mkdir -p "$(dirname "${MARKER_FILE}")"
+echo -e "\
+    PACKAGES_ALREADY_INSTALLED=${PACKAGES_ALREADY_INSTALLED}\n\
+    LOCALE_ALREADY_SET=${LOCALE_ALREADY_SET}\n\
+    EXISTING_NON_ROOT_USER=${EXISTING_NON_ROOT_USER}\n\
+    RC_SNIPPET_ALREADY_ADDED=${RC_SNIPPET_ALREADY_ADDED}\n\
+    ZSH_ALREADY_INSTALLED=${ZSH_ALREADY_INSTALLED}" > "${MARKER_FILE}"
+
+echo "Done!"
diff --git a/.devcontainer/library-scripts/docker-debian.sh b/.devcontainer/library-scripts/docker-debian.sh
new file mode 100644
index 0000000..a60e49a
--- /dev/null
+++ b/.devcontainer/library-scripts/docker-debian.sh
@@ -0,0 +1,309 @@
+#!/usr/bin/env bash
+#-------------------------------------------------------------------------------------------------------------
+# Copyright (c) Microsoft Corporation. All rights reserved.
+# Licensed under the MIT License. See https://go.microsoft.com/fwlink/?linkid=2090316 for license information.
+#-------------------------------------------------------------------------------------------------------------
+#
+# Docs: https://github.com/microsoft/vscode-dev-containers/blob/main/script-library/docs/docker.md
+# Maintainer: The VS Code and Codespaces Teams
+#
+# Syntax: ./docker-debian.sh [enable non-root docker socket access flag] [source socket] [target socket] [non-root user] [use moby] [CLI version]
+
+ENABLE_NONROOT_DOCKER=${1:-"true"}
+SOURCE_SOCKET=${2:-"/var/run/docker-host.sock"}
+TARGET_SOCKET=${3:-"/var/run/docker.sock"}
+USERNAME=${4:-"automatic"}
+USE_MOBY=${5:-"true"}
+DOCKER_VERSION=${6:-"latest"}
+MICROSOFT_GPG_KEYS_URI="https://packages.microsoft.com/keys/microsoft.asc"
+DOCKER_DASH_COMPOSE_VERSION="1"
+
+set -e
+
+if [ "$(id -u)" -ne 0 ]; then
+    echo -e 'Script must be run as root. Use sudo, su, or add "USER root" to your Dockerfile before running this script.'
+    exit 1
+fi
+
+# Determine the appropriate non-root user
+if [ "${USERNAME}" = "auto" ] || [ "${USERNAME}" = "automatic" ]; then
+    USERNAME=""
+    POSSIBLE_USERS=("vscode" "node" "codespace" "$(awk -v val=1000 -F ":" '$3==val{print $1}' /etc/passwd)")
+    for CURRENT_USER in ${POSSIBLE_USERS[@]}; do
+        if id -u ${CURRENT_USER} > /dev/null 2>&1; then
+            USERNAME=${CURRENT_USER}
+            break
+        fi
+    done
+    if [ "${USERNAME}" = "" ]; then
+        USERNAME=root
+    fi
+elif [ "${USERNAME}" = "none" ] || ! id -u ${USERNAME} > /dev/null 2>&1; then
+    USERNAME=root
+fi
+
+# Get central common setting
+get_common_setting() {
+    if [ "${common_settings_file_loaded}" != "true" ]; then
+        curl -sfL "https://aka.ms/vscode-dev-containers/script-library/settings.env" 2>/dev/null -o /tmp/vsdc-settings.env || echo "Could not download settings file. Skipping."
+        common_settings_file_loaded=true
+    fi
+    if [ -f "/tmp/vsdc-settings.env" ]; then
+        local multi_line=""
+        if [ "$2" = "true" ]; then multi_line="-z"; fi
+        local result="$(grep ${multi_line} -oP "$1=\"?\K[^\"]+" /tmp/vsdc-settings.env | tr -d '\0')"
+        if [ ! -z "${result}" ]; then declare -g $1="${result}"; fi
+    fi
+    echo "$1=${!1}"
+}
+
+# Function to run apt-get if needed
+apt_get_update_if_needed()
+{
+    if [ ! -d "/var/lib/apt/lists" ] || [ "$(ls /var/lib/apt/lists/ | wc -l)" = "0" ]; then
+        echo "Running apt-get update..."
+        apt-get update
+    else
+        echo "Skipping apt-get update."
+    fi
+}
+
+# Checks if packages are installed and installs them if not
+check_packages() {
+    if ! dpkg -s "$@" > /dev/null 2>&1; then
+        apt_get_update_if_needed
+        apt-get -y install --no-install-recommends "$@"
+    fi
+}
+
+# Figure out correct version of a three part version number is not passed
+find_version_from_git_tags() {
+    local variable_name=$1
+    local requested_version=${!variable_name}
+    if [ "${requested_version}" = "none" ]; then return; fi
+    local repository=$2
+    local prefix=${3:-"tags/v"}
+    local separator=${4:-"."}
+    local last_part_optional=${5:-"false"}    
+    if [ "$(echo "${requested_version}" | grep -o "." | wc -l)" != "2" ]; then
+        local escaped_separator=${separator//./\\.}
+        local last_part
+        if [ "${last_part_optional}" = "true" ]; then
+            last_part="(${escaped_separator}[0-9]+)?"
+        else
+            last_part="${escaped_separator}[0-9]+"
+        fi
+        local regex="${prefix}\\K[0-9]+${escaped_separator}[0-9]+${last_part}$"
+        local version_list="$(git ls-remote --tags ${repository} | grep -oP "${regex}" | tr -d ' ' | tr "${separator}" "." | sort -rV)"
+        if [ "${requested_version}" = "latest" ] || [ "${requested_version}" = "current" ] || [ "${requested_version}" = "lts" ]; then
+            declare -g ${variable_name}="$(echo "${version_list}" | head -n 1)"
+        else
+            set +e
+            declare -g ${variable_name}="$(echo "${version_list}" | grep -E -m 1 "^${requested_version//./\\.}([\\.\\s]|$)")"
+            set -e
+        fi
+    fi
+    if [ -z "${!variable_name}" ] || ! echo "${version_list}" | grep "^${!variable_name//./\\.}$" > /dev/null 2>&1; then
+        echo -e "Invalid ${variable_name} value: ${requested_version}\nValid values:\n${version_list}" >&2
+        exit 1
+    fi
+    echo "${variable_name}=${!variable_name}"
+}
+
+# Ensure apt is in non-interactive to avoid prompts
+export DEBIAN_FRONTEND=noninteractive
+
+# Install dependencies
+check_packages apt-transport-https curl ca-certificates gnupg2 dirmngr
+if ! type git > /dev/null 2>&1; then
+    apt_get_update_if_needed
+    apt-get -y install git
+fi
+
+# Source /etc/os-release to get OS info
+. /etc/os-release
+# Fetch host/container arch.
+architecture="$(dpkg --print-architecture)"
+
+# Set up the necessary apt repos (either Microsoft's or Docker's)
+if [ "${USE_MOBY}" = "true" ]; then
+
+    cli_package_name="moby-cli"
+
+    # Import key safely and import Microsoft apt repo
+    get_common_setting MICROSOFT_GPG_KEYS_URI
+    curl -sSL ${MICROSOFT_GPG_KEYS_URI} | gpg --dearmor > /usr/share/keyrings/microsoft-archive-keyring.gpg
+    echo "deb [arch=${architecture} signed-by=/usr/share/keyrings/microsoft-archive-keyring.gpg] https://packages.microsoft.com/repos/microsoft-${ID}-${VERSION_CODENAME}-prod ${VERSION_CODENAME} main" > /etc/apt/sources.list.d/microsoft.list
+else
+    # Name of proprietary engine package
+    cli_package_name="docker-ce-cli"
+
+    # Import key safely and import Docker apt repo
+    curl -fsSL https://download.docker.com/linux/${ID}/gpg | gpg --dearmor > /usr/share/keyrings/docker-archive-keyring.gpg
+    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/${ID} ${VERSION_CODENAME} stable" > /etc/apt/sources.list.d/docker.list
+fi
+
+# Refresh apt lists
+apt-get update
+
+# Soft version matching for CLI
+if [ "${DOCKER_VERSION}" = "latest" ] || [ "${DOCKER_VERSION}" = "lts" ] || [ "${DOCKER_VERSION}" = "stable" ]; then
+    # Empty, meaning grab whatever "latest" is in apt repo
+    cli_version_suffix=""
+else    
+    # Fetch a valid version from the apt-cache (eg: the Microsoft repo appends +azure, breakfix, etc...)
+    docker_version_dot_escaped="${DOCKER_VERSION//./\\.}"
+    docker_version_dot_plus_escaped="${docker_version_dot_escaped//+/\\+}"
+    # Regex needs to handle debian package version number format: https://www.systutorials.com/docs/linux/man/5-deb-version/
+    docker_version_regex="^(.+:)?${docker_version_dot_plus_escaped}([\\.\\+ ~:-]|$)"
+    set +e # Don't exit if finding version fails - will handle gracefully
+    cli_version_suffix="=$(apt-cache madison ${cli_package_name} | awk -F"|" '{print $2}' | sed -e 's/^[ \t]*//' | grep -E -m 1 "${docker_version_regex}")"
+    set -e
+    if [ -z "${cli_version_suffix}" ] || [ "${cli_version_suffix}" = "=" ]; then
+        echo "(!) No full or partial Docker / Moby version match found for \"${DOCKER_VERSION}\" on OS ${ID} ${VERSION_CODENAME} (${architecture}). Available versions:"
+        apt-cache madison ${cli_package_name} | awk -F"|" '{print $2}' | grep -oP '^(.+:)?\K.+'
+        exit 1
+    fi
+    echo "cli_version_suffix ${cli_version_suffix}"
+fi
+
+# Install Docker / Moby CLI if not already installed
+if type docker > /dev/null 2>&1; then
+    echo "Docker / Moby CLI already installed."
+else
+    if [ "${USE_MOBY}" = "true" ]; then
+        apt-get -y install --no-install-recommends moby-cli${cli_version_suffix} moby-buildx
+        apt-get -y install --no-install-recommends moby-compose || echo "(*) Package moby-compose (Docker Compose v2) not available for OS ${ID} ${VERSION_CODENAME} (${architecture}). Skipping."
+    else
+        apt-get -y install --no-install-recommends docker-ce-cli${cli_version_suffix}
+    fi
+fi
+
+# Install Docker Compose if not already installed  and is on a supported architecture
+if type docker-compose > /dev/null 2>&1; then
+    echo "Docker Compose already installed."
+else
+    TARGET_COMPOSE_ARCH="$(uname -m)"
+    if [ "${TARGET_COMPOSE_ARCH}" = "amd64" ]; then
+        TARGET_COMPOSE_ARCH="x86_64"
+    fi
+    if [ "${TARGET_COMPOSE_ARCH}" != "x86_64" ]; then
+        # Use pip to get a version that runns on this architecture
+        if ! dpkg -s python3-minimal python3-pip libffi-dev python3-venv > /dev/null 2>&1; then
+            apt_get_update_if_needed
+            apt-get -y install python3-minimal python3-pip libffi-dev python3-venv
+        fi
+        export PIPX_HOME=/usr/local/pipx
+        mkdir -p ${PIPX_HOME}
+        export PIPX_BIN_DIR=/usr/local/bin
+        export PYTHONUSERBASE=/tmp/pip-tmp
+        export PIP_CACHE_DIR=/tmp/pip-tmp/cache
+        pipx_bin=pipx
+        if ! type pipx > /dev/null 2>&1; then
+            pip3 install --disable-pip-version-check --no-cache-dir --user pipx
+            pipx_bin=/tmp/pip-tmp/bin/pipx
+        fi
+        ${pipx_bin} install --pip-args '--no-cache-dir --force-reinstall' docker-compose
+        rm -rf /tmp/pip-tmp
+    else 
+        find_version_from_git_tags DOCKER_DASH_COMPOSE_VERSION "https://github.com/docker/compose" "tags/"
+        echo "(*) Installing docker-compose ${DOCKER_DASH_COMPOSE_VERSION}..."
+        curl -fsSL "https://github.com/docker/compose/releases/download/${DOCKER_DASH_COMPOSE_VERSION}/docker-compose-Linux-x86_64" -o /usr/local/bin/docker-compose
+        chmod +x /usr/local/bin/docker-compose
+    fi
+fi
+
+# If init file already exists, exit
+if [ -f "/usr/local/share/docker-init.sh" ]; then
+    exit 0
+fi
+echo "docker-init doesnt exist, adding..."
+
+# By default, make the source and target sockets the same
+if [ "${SOURCE_SOCKET}" != "${TARGET_SOCKET}" ]; then
+    touch "${SOURCE_SOCKET}"
+    ln -s "${SOURCE_SOCKET}" "${TARGET_SOCKET}"
+fi
+
+# Add a stub if not adding non-root user access, user is root
+if [ "${ENABLE_NONROOT_DOCKER}" = "false" ] || [ "${USERNAME}" = "root" ]; then
+    echo '/usr/bin/env bash -c "\$@"' > /usr/local/share/docker-init.sh
+    chmod +x /usr/local/share/docker-init.sh
+    exit 0
+fi
+
+# If enabling non-root access and specified user is found, setup socat and add script
+chown -h "${USERNAME}":root "${TARGET_SOCKET}"        
+if ! dpkg -s socat > /dev/null 2>&1; then
+    apt_get_update_if_needed
+    apt-get -y install socat
+fi
+tee /usr/local/share/docker-init.sh > /dev/null \
+<< EOF 
+#!/usr/bin/env bash
+#-------------------------------------------------------------------------------------------------------------
+# Copyright (c) Microsoft Corporation. All rights reserved.
+# Licensed under the MIT License. See https://go.microsoft.com/fwlink/?linkid=2090316 for license information.
+#-------------------------------------------------------------------------------------------------------------
+
+set -e
+
+SOCAT_PATH_BASE=/tmp/vscr-docker-from-docker
+SOCAT_LOG=\${SOCAT_PATH_BASE}.log
+SOCAT_PID=\${SOCAT_PATH_BASE}.pid
+
+# Wrapper function to only use sudo if not already root
+sudoIf()
+{
+    if [ "\$(id -u)" -ne 0 ]; then
+        sudo "\$@"
+    else
+        "\$@"
+    fi
+}
+
+# Log messages
+log()
+{
+    echo -e "[\$(date)] \$@" | sudoIf tee -a \${SOCAT_LOG} > /dev/null
+}
+
+echo -e "\n** \$(date) **" | sudoIf tee -a \${SOCAT_LOG} > /dev/null
+log "Ensuring ${USERNAME} has access to ${SOURCE_SOCKET} via ${TARGET_SOCKET}"
+
+# If enabled, try to add a docker group with the right GID. If the group is root, 
+# fall back on using socat to forward the docker socket to another unix socket so 
+# that we can set permissions on it without affecting the host.
+if [ "${ENABLE_NONROOT_DOCKER}" = "true" ] && [ "${SOURCE_SOCKET}" != "${TARGET_SOCKET}" ] && [ "${USERNAME}" != "root" ] && [ "${USERNAME}" != "0" ]; then
+    SOCKET_GID=\$(stat -c '%g' ${SOURCE_SOCKET})
+    if [ "\${SOCKET_GID}" != "0" ]; then
+        log "Adding user to group with GID \${SOCKET_GID}."
+        if [ "\$(cat /etc/group | grep :\${SOCKET_GID}:)" = "" ]; then
+            sudoIf groupadd --gid \${SOCKET_GID} docker-host
+        fi
+        # Add user to group if not already in it
+        if [ "\$(id ${USERNAME} | grep -E "groups.*(=|,)\${SOCKET_GID}\(")" = "" ]; then
+            sudoIf usermod -aG \${SOCKET_GID} ${USERNAME}
+        fi
+    else
+        # Enable proxy if not already running
+        if [ ! -f "\${SOCAT_PID}" ] || ! ps -p \$(cat \${SOCAT_PID}) > /dev/null; then
+            log "Enabling socket proxy."
+            log "Proxying ${SOURCE_SOCKET} to ${TARGET_SOCKET} for vscode"
+            sudoIf rm -rf ${TARGET_SOCKET}
+            (sudoIf socat UNIX-LISTEN:${TARGET_SOCKET},fork,mode=660,user=${USERNAME} UNIX-CONNECT:${SOURCE_SOCKET} 2>&1 | sudoIf tee -a \${SOCAT_LOG} > /dev/null & echo "\$!" | sudoIf tee \${SOCAT_PID} > /dev/null)
+        else
+            log "Socket proxy already running."
+        fi
+    fi
+    log "Success"
+fi
+
+# Execute whatever commands were passed in (if any). This allows us 
+# to set this script to ENTRYPOINT while still executing the default CMD.
+set +e
+exec "\$@"
+EOF
+chmod +x /usr/local/share/docker-init.sh
+chown ${USERNAME}:root /usr/local/share/docker-init.sh
+echo "Done!"
\ No newline at end of file
diff --git a/.earthlyignore b/.earthlyignore
new file mode 100644
index 0000000..a19a1de
--- /dev/null
+++ b/.earthlyignore
@@ -0,0 +1,37 @@
+.git
+.github
+azure-pipelines.yml
+Earthfile
+
+
+# cmake
+CMakeCache.txt
+CMakeFiles
+CMakeScripts
+cmake_install.cmake
+install_manifest.txt
+CPackConfig.cmake
+CPackSourceConfig.cmake
+CTestTestfile.cmake
+DartConfiguration.tcl
+/cmake/uninstall.cmake
+
+# build files
+/build*/
+/libs/src
+/libs/tmp
+/libs/download
+*.sln
+*.vcxproj
+*.vcxproj.filters
+*.opensdf
+*.suo
+Win32
+Release
+Debug
+neko.sln
+*.dir
+bin
+/extra/chocolatey/LICENSE
+/extra/chocolatey/*.zip
+/extra/chocolatey/*.nupkg
\ No newline at end of file
diff --git a/.github/ISSUE_TEMPLATE/new-issue.md b/.github/ISSUE_TEMPLATE/new-issue.md
new file mode 100644
index 0000000..c8c1c63
--- /dev/null
+++ b/.github/ISSUE_TEMPLATE/new-issue.md
@@ -0,0 +1,11 @@
+---
+name: New issue
+about: Neko is not actively maintained anymore. You can open an issue anyway, but
+  don't expect to get response from developers.
+title: ''
+labels: ''
+assignees: ''
+
+---
+
+*DEPRECATION NOTICE: Neko is not actively maintained anymore. You can open an issue anyway, but don't expect to get response from developers.*
diff --git a/.github/pull_request_template.md b/.github/pull_request_template.md
new file mode 100644
index 0000000..adc8add
--- /dev/null
+++ b/.github/pull_request_template.md
@@ -0,0 +1 @@
+**DEPRECATION NOTICE: Neko is not actively maintained anymore. You can open a PR anyway, but don't expect it to get merged.**
diff --git a/.gitignore b/.gitignore
index e2a9a72..87dc01b 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1,3 +1,5 @@
+.envrc
+
 /src/**/*.n
 *_sec.gpg
 *_ssh
@@ -30,3 +32,6 @@ Debug
 neko.sln
 *.dir
 bin
+/extra/chocolatey/LICENSE
+/extra/chocolatey/*.zip
+/extra/chocolatey/*.nupkg
\ No newline at end of file
diff --git a/.vscode/settings.json b/.vscode/settings.json
new file mode 100644
index 0000000..b097515
--- /dev/null
+++ b/.vscode/settings.json
@@ -0,0 +1,5 @@
+{
+    "files.associations": {
+        "*.in": "cpp"
+    }
+}
\ No newline at end of file
diff --git a/CHANGES b/CHANGES
index 050ff5c..90c67b4 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,3 +1,11 @@
+????-??-?? : 2.4.0
+	all : deprecated neko (see README)
+	std : fixed put_env when null is passed in (#229 https://github.com/HaxeFoundation/haxe/issues/10395)
+	std : added sys_cpu_arch (#275)
+	std : fix sys_is64 returning false on 64 bit Windows (#276)
+	cmake : updated apr version for Mac
+	all : fixed various build issues on macOS Catalina
+
 2019-10-19 : 2.3.0
 	std : added socket_set_broadcast function (#190)
 	std : fixed sha1_update call (#194)
diff --git a/CMakeLists.txt b/CMakeLists.txt
index 930c1ab..1dec73d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1,4 +1,11 @@
-cmake_minimum_required(VERSION 2.8.12)
+cmake_minimum_required(VERSION 3.10.2)
+
+if (NOT ${CMAKE_VERSION} VERSION_LESS 3.24)
+	cmake_policy(VERSION 3.24)
+elseif (NOT ${CMAKE_VERSION} VERSION_LESS 3.19)
+	cmake_policy(VERSION 3.19)
+endif()
+cmake_policy(SET CMP0068 NEW)
 
 include(GNUInstallDirs)
 include(CheckCCompilerFlag)
@@ -6,7 +13,6 @@ include(CheckIncludeFile)
 include(TestBigEndian)
 project(Neko C)
 
-set(CMAKE_OSX_ARCHITECTURES x86_64)
 set(CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/cmake ${CMAKE_MODULE_PATH})
 
 if (${CMAKE_SYSTEM_NAME} STREQUAL "FreeBSD")
@@ -22,7 +28,7 @@ set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${OUTPUT_DIR})
 set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${OUTPUT_DIR})
 
 # avoid the extra "Debug", "Release" directories
-# http://stackoverflow.com/questions/7747857/in-cmake-how-do-i-work-around-the-debug-and-release-directories-visual-studio-2
+# https://stackoverflow.com/questions/7747857/in-cmake-how-do-i-work-around-the-debug-and-release-directories-visual-studio-2
 foreach( OUTPUTCONFIG ${CMAKE_CONFIGURATION_TYPES} )
 	string( TOUPPER ${OUTPUTCONFIG} OUTPUTCONFIG )
 	set( CMAKE_RUNTIME_OUTPUT_DIRECTORY_${OUTPUTCONFIG} ${OUTPUT_DIR} )
@@ -36,39 +42,33 @@ if(IS_ABSOLUTE ${CMAKE_INSTALL_LIBDIR})
 endif()
 
 set(NEKO_VERSION_MAJOR 2)
-set(NEKO_VERSION_MINOR 3)
+set(NEKO_VERSION_MINOR 4)
 set(NEKO_VERSION_PATCH 0)
-set(NEKO_VERSION ${NEKO_VERSION_MAJOR}.${NEKO_VERSION_MINOR}.${NEKO_VERSION_PATCH})
+
+string(TIMESTAMP NEKO_BUILD_YEAR "%Y")
+
+# NEKO_VERSION is cached such that we can query it by `cmake -L -N -B . | grep NEKO_VERSION`
+set(NEKO_VERSION ${NEKO_VERSION_MAJOR}.${NEKO_VERSION_MINOR}.${NEKO_VERSION_PATCH} CACHE STRING INTERNAL)
 
 # Determine target endianness
 TEST_BIG_ENDIAN(NEKO_BIG_ENDIAN)
 
-option(WITH_REGEXP "Build Perl-compatible regex support." ON)
-option(WITH_UI "Build GTK-2 UI support." ON)
-option(WITH_SSL "Build SSL support." ON)
-option(WITH_MYSQL "Build MySQL support." ON)
-option(WITH_SQLITE "Build Sqlite support." ON)
-option(WITH_APACHE "Build Apach modules." ON)
+option(WITH_REGEXP "Build with Perl-compatible regex support." ON)
+option(WITH_UI "Build with GTK-3 UI support." ON)
+option(WITH_SSL "Build with SSL support." ON)
+option(WITH_MYSQL "Build with MySQL support." ON)
+option(WITH_SQLITE "Build with Sqlite support." ON)
+option(WITH_APACHE "Build with Apache modules." ON)
 option(WITH_NEKOML "Build NekoML." ON)
 
 # Process common headers in libraries
 # TODO libraries should not be built from this file, but rather by traversing the tree using add_subdirectory
 #add_subdirectory(libs)
 
-if (${CMAKE_SYSTEM_NAME} STREQUAL "Darwin")
-	if (${CMAKE_OSX_ARCHITECTURES} STREQUAL "i386")
-		set(arch_64 "")
-	elseif (${CMAKE_OSX_ARCHITECTURES} STREQUAL "x86_64")
-		set(arch_64 "64")
-	else()
-		message( FATAL_ERROR "CMAKE_OSX_ARCHITECTURES should be i386 or x86_64." )
-	endif()
+if(CMAKE_SIZEOF_VOID_P EQUAL 8)
+	set(arch_64 "64")
 else()
-	if(CMAKE_SIZEOF_VOID_P EQUAL 8)
-		set(arch_64 "64")
-	else()
-		set(arch_64 "")
-	endif()
+	set(arch_64 "")
 endif()
 
 if(WIN32)
@@ -101,7 +101,7 @@ set(external_deps
 	Zlib
 	OpenSSL
 	MariaDBConnector
-	PCRE
+	pcre2
 	Sqlite3
 	APR
 	APRutil
@@ -126,19 +126,30 @@ set(STATIC_DEPS ${STATIC_DEPS_DEFAULT} CACHE STRING "${STATIC_DEPS_DOC}")
 
 # Validate STATIC_DEPS
 if (STATIC_DEPS STREQUAL "all")
-	set(STATIC_DEPS ${external_deps} CACHE STRING "${STATIC_DEPS_DOC}" FORCE)
+	set(STATIC_DEPS_ALL ${external_deps})
+	if (WIN32)
+		list(REMOVE_ITEM STATIC_DEPS_ALL BoehmGC)
+	endif()
+	if (APPLE)
+		list(REMOVE_ITEM STATIC_DEPS_ALL APRutil)
+	endif()
+	set(STATIC_DEPS ${STATIC_DEPS_ALL} CACHE STRING "${STATIC_DEPS_DOC}" FORCE)
 elseif (STATIC_DEPS STREQUAL "none")
 	message(STATUS "set STATIC_DEPS to nothing")
 	set(STATIC_DEPS CACHE STRING "${STATIC_DEPS_DOC}" FORCE)
+else()
+	foreach(dep ${STATIC_DEPS})
+		list(FIND external_deps ${dep} idx)
+		if(idx EQUAL -1)
+			message(FATAL_ERROR "Invalid STATIC_DEPS. There is no ${dep} in the list of ${external_deps}")
+		elseif(WIN32 AND dep STREQUAL "BoehmGC")
+			message(FATAL_ERROR "Cannot link ${dep} statically on Windows")
+		elseif(APPLE AND dep STREQUAL "APRutil")
+			message(WARNING "${dep} is redundant as it was merged into APR in version 2.0, which is the version we build with on macOS.")
+		endif()
+	endforeach()
 endif()
 
-foreach(dep ${STATIC_DEPS})
-	list(FIND external_deps ${dep} idx)
-	if(idx EQUAL -1)
-		message(FATAL_ERROR "Invalid STATIC_DEPS. There is no ${dep} in the list of ${external_deps}")
-	endif()
-endforeach()
-
 # Set STATIC_* variables according to STATIC_DEPS.
 foreach(dep ${external_deps})
 	string(TOUPPER ${dep} var)
@@ -208,18 +219,17 @@ set(EP_CONFIGS
 	PREFIX ${CMAKE_BINARY_DIR}/libs
 	DOWNLOAD_DIR ${CMAKE_BINARY_DIR}/libs/download
 )
-if(NOT ${CMAKE_VERSION} VERSION_LESS 3.1)
-	list(APPEND EP_CONFIGS
-		DOWNLOAD_NO_PROGRESS 1
-	)
-endif()
-if(${CMAKE_VERSION} VERSION_LESS 3.2)
+list(APPEND EP_CONFIGS
+	DOWNLOAD_NO_PROGRESS 1
+)
+if (${CMAKE_VERSION} VERSION_LESS 3.19)
 	list(APPEND EP_CONFIGS
-		STEP_TARGETS download
+		INDEPENDENT_STEP_TARGETS download
 	)
 else()
+	# download is independent by default in 3.19
 	list(APPEND EP_CONFIGS
-		INDEPENDENT_STEP_TARGETS download
+		STEP_TARGETS download
 	)
 endif()
 set(EP_PROPS
@@ -260,7 +270,8 @@ add_executable(nekovm
 	vm/main.c
 )
 
-if (STATIC_BOEHMGC)
+# We need to build from source on Windows regardless
+if (STATIC_BOEHMGC OR WIN32)
 	ExternalProject_Add(libatomic_ops
 		${EP_CONFIGS}
 		URL https://github.com/ivmai/libatomic_ops/releases/download/v7.6.0/libatomic_ops-7.6.0.tar.gz
@@ -269,22 +280,23 @@ if (STATIC_BOEHMGC)
 		BUILD_COMMAND echo skip build
 		INSTALL_COMMAND echo skip install
 	)
-
-	set(BoehmGC_URL "http://www.hboehm.info/gc/gc_source/gc-7.6.0.tar.gz")
-	if (NOT ${CMAKE_VERSION} VERSION_LESS 3.7)
-		list(APPEND BoehmGC_URL
-			"https://github.com/ivmai/bdwgc/files/1005477/gc-7.6.0.tar.gz"
-		)
-	endif()
+	set_target_properties(libatomic_ops PROPERTIES ${EP_PROPS})
 
 	set (
 		BoehmGC_CONFIGS
 		DEPENDS libatomic_ops
-		URL ${BoehmGC_URL}
+		URL
+			"https://www.hboehm.info/gc/gc_source/gc-7.6.0.tar.gz"
+			"https://github.com/ivmai/bdwgc/files/1005477/gc-7.6.0.tar.gz"
 		URL_MD5 bf46ccbdaccfa3186c2ab87191c8855a
 	)
 
+	set(GC_INCLUDE_DIR ${CMAKE_BINARY_DIR}/libs/src/BoehmGC-build/include)
+
 	if (WIN32)
+		set(GC_LIBRARIES
+			${CMAKE_BINARY_DIR}/libs/src/BoehmGC-build/${CMAKE_CFG_INTDIR}/gcmt-dll.lib
+		)
 		ExternalProject_Add(BoehmGC
 			${EP_CONFIGS}
 			${BoehmGC_CONFIGS}
@@ -293,16 +305,13 @@ if (STATIC_BOEHMGC)
 				-Denable_threads=ON
 				-Denable_parallel_mark=ON
 				-DCMAKE_USE_WIN32_THREADS_INIT=ON
+				-DCMAKE_CXX_STANDARD=14
 			PATCH_COMMAND ${CMAKE_COMMAND} -E copy_directory ${CMAKE_BINARY_DIR}/libs/src/libatomic_ops ${CMAKE_BINARY_DIR}/libs/src/BoehmGC/libatomic_ops
 			INSTALL_COMMAND
 				${CMAKE_COMMAND} -E copy_directory
 					${CMAKE_BINARY_DIR}/libs/src/BoehmGC/include
 					${CMAKE_BINARY_DIR}/libs/src/BoehmGC-build/include/gc
 		)
-		set(GC_INCLUDE_DIR ${CMAKE_BINARY_DIR}/libs/src/BoehmGC-build/include)
-		set(GC_LIBRARIES
-			${CMAKE_BINARY_DIR}/libs/src/BoehmGC-build/${CMAKE_CFG_INTDIR}/gcmt-dll.lib
-		)
 		add_custom_command(OUTPUT ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/gcmt-dll.dll
 			DEPENDS BoehmGC
 			COMMAND ${CMAKE_COMMAND} -E copy ${CMAKE_BINARY_DIR}/libs/src/BoehmGC-build/${CMAKE_CFG_INTDIR}/gcmt-dll.dll ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}
@@ -318,7 +327,6 @@ if (STATIC_BOEHMGC)
 			set(GC_CFLAGS "-w")
 		endif()
 
-		set(GC_INCLUDE_DIR ${CMAKE_BINARY_DIR}/libs/src/BoehmGC-build/include)
 		set(GC_LIBRARIES
 			${CMAKE_BINARY_DIR}/libs/src/BoehmGC-build/lib/libgc.a
 		)
@@ -343,17 +351,20 @@ if (STATIC_BOEHMGC)
 			BYPRODUCTS
 				${GC_LIBRARIES}
 		)
-
-		# don't want to add libatomic_ops to external_deps,
-		# but want download_static_deps depends on it
-		add_dependencies(BoehmGC-download libatomic_ops-download)
 	endif()
+
 	set_target_properties(BoehmGC PROPERTIES ${EP_PROPS})
 	add_dependencies(libneko BoehmGC)
 else()
 	find_package(BoehmGC REQUIRED)
 endif()
 
+add_custom_target(download_deps)
+if (STATIC_BOEHMGC OR WIN32)
+	add_dependencies(download_deps libatomic_ops-download)
+	add_dependencies(download_deps BoehmGC-download)
+endif()
+
 target_include_directories(libneko PRIVATE ${GC_INCLUDE_DIR})
 
 target_link_libraries(libneko ${GC_LIBRARIES})
@@ -517,13 +528,6 @@ endif()
 
 #######################
 
-add_custom_target(download_static_deps)
-if (STATIC_BOEHMGC)
-	add_dependencies(download_static_deps BoehmGC-download)
-endif()
-
-#######################
-
 # source_archive
 # We create our own source package target instead of using CPack's package_source.
 # One reason is that the CPack VS generator doesn't generate package_source target.
@@ -564,7 +568,7 @@ add_custom_command(OUTPUT ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${source_archive_fat
 		-Dsrc_dir=${CMAKE_SOURCE_DIR}
 		-Dlib_src_dir=libs/src
 		-P ${CMAKE_SOURCE_DIR}/cmake/source_archive_fat.cmake
-	DEPENDS source_archive download_static_deps
+	DEPENDS source_archive download_deps
 	VERBATIM
 )
 
@@ -645,6 +649,7 @@ export(TARGETS
 if (WITH_NEKOML)
 	export(TARGETS
 		nekoml
+		APPEND
 		FILE "${CMAKE_BINARY_DIR}/NekoTargets.cmake")
 endif()
 
@@ -735,22 +740,6 @@ else()
 	set(bin_archive_format tar.gz)
 endif()
 
-if (${CMAKE_SYSTEM_NAME} STREQUAL "Darwin")
-	if (${CMAKE_OSX_ARCHITECTURES} STREQUAL "i386")
-		set(arch_64 "")
-	elseif (${CMAKE_OSX_ARCHITECTURES} STREQUAL "x86_64")
-		set(arch_64 "64")
-	else()
-		message( FATAL_ERROR "CMAKE_OSX_ARCHITECTURES should be i386 or x86_64." )
-	endif()
-else()
-	if(CMAKE_SIZEOF_VOID_P EQUAL 8)
-		set(arch_64 "64")
-	else()
-		set(arch_64 "")
-	endif()
-endif()
-
 if (${CMAKE_SYSTEM_NAME} STREQUAL "Windows")
 	set(OS_NAME "win")
 elseif (${CMAKE_SYSTEM_NAME} STREQUAL "Darwin")
diff --git a/Earthfile b/Earthfile
new file mode 100644
index 0000000..0cb7942
--- /dev/null
+++ b/Earthfile
@@ -0,0 +1,238 @@
+VERSION 0.6
+FROM ubuntu:jammy
+
+ARG DEVCONTAINER_IMAGE_NAME_DEFAULT=haxe/neko_devcontainer
+
+ARG USERNAME=vscode
+ARG USER_UID=1000
+ARG USER_GID=$USER_UID
+
+ARG LINK_TYPE_DEFAULT=static # static or dynamic
+ARG LINK_DYNAMIC_PACKAGES="libgc-dev libpcre2-dev zlib1g-dev apache2-dev libmysqlclient-dev libsqlite3-dev libmbedtls-dev"
+
+vscode-dev-containers-scripts:
+    FROM curlimages/curl:7.80.0
+    WORKDIR /tmp
+    RUN curl -fsSLO https://raw.githubusercontent.com/microsoft/vscode-dev-containers/main/script-library/common-debian.sh
+    RUN curl -fsSLO https://raw.githubusercontent.com/microsoft/vscode-dev-containers/main/script-library/docker-debian.sh
+    SAVE ARTIFACT --keep-ts *.sh AS LOCAL .devcontainer/library-scripts/
+
+devcontainer-base:
+    FROM mcr.microsoft.com/vscode/devcontainers/base:0-jammy
+    ARG --required TARGETARCH
+
+    # Avoid warnings by switching to noninteractive
+    ENV DEBIAN_FRONTEND=noninteractive
+
+    ARG INSTALL_ZSH="false"
+    ARG UPGRADE_PACKAGES="true"
+    ARG ENABLE_NONROOT_DOCKER="true"
+    ARG USE_MOBY="true"
+    COPY .devcontainer/library-scripts/*.sh /tmp/library-scripts/
+    RUN apt-get update \
+        && /bin/bash /tmp/library-scripts/common-debian.sh "${INSTALL_ZSH}" "${USERNAME}" "${USER_UID}" "${USER_GID}" "${UPGRADE_PACKAGES}" "true" "true" \
+        # Use Docker script from script library to set things up
+        && /bin/bash /tmp/library-scripts/docker-debian.sh "${ENABLE_NONROOT_DOCKER}" "/var/run/docker-host.sock" "/var/run/docker.sock" "${USERNAME}" "${USE_MOBY}" \
+        # Clean up
+        && apt-get autoremove -y && apt-get clean -y && rm -rf /var/lib/apt/lists/* /tmp/library-scripts/
+
+    # Configure apt and install packages
+    RUN apt-get update \
+        && apt-get install -y --no-install-recommends apt-utils dialog 2>&1 \
+        && apt-get install -y \
+            iproute2 \
+            procps \
+            sudo \
+            bash-completion \
+            build-essential \
+            curl \
+            wget \
+            software-properties-common \
+            direnv \
+            tzdata \
+            python3-pip \
+            # Neko deps
+            cmake \
+            ninja-build \
+            pkg-config \
+            libgtk-3-dev \
+            $LINK_DYNAMIC_PACKAGES \
+        #
+        # Clean up
+        && apt-get autoremove -y \
+        && apt-get clean -y \
+        && rm -rf /var/lib/apt/lists/*
+
+    # Switch back to dialog for any ad-hoc use of apt-get
+    ENV DEBIAN_FRONTEND=
+
+    # Setting the ENTRYPOINT to docker-init.sh will configure non-root access
+    # to the Docker socket. The script will also execute CMD as needed.
+    ENTRYPOINT [ "/usr/local/share/docker-init.sh" ]
+    CMD [ "sleep", "infinity" ]
+
+    # VS Code workspace
+    RUN mkdir -m 777 "/workspace"
+    WORKDIR /workspace
+
+# Usage:
+# COPY +earthly/earthly /usr/local/bin/
+# RUN earthly bootstrap --no-buildkit --with-autocomplete
+earthly:
+    FROM +devcontainer-base
+    ARG --required TARGETARCH
+    RUN curl -fsSL https://github.com/earthly/earthly/releases/download/v0.6.30/earthly-linux-${TARGETARCH} -o /usr/local/bin/earthly \
+        && chmod +x /usr/local/bin/earthly
+    SAVE ARTIFACT /usr/local/bin/earthly
+
+devcontainer:
+    FROM +devcontainer-base
+
+    # Install earthly
+    COPY +earthly/earthly /usr/local/bin/
+    RUN earthly bootstrap --no-buildkit --with-autocomplete
+
+    USER $USERNAME
+
+    # Config direnv
+    COPY --chown=$USER_UID:$USER_GID .devcontainer/direnv.toml /home/$USERNAME/.config/direnv/config.toml
+
+    # Config bash
+    RUN echo 'eval "$(direnv hook bash)"' >> ~/.bashrc
+
+    USER root
+
+    ARG DEVCONTAINER_IMAGE_NAME="$DEVCONTAINER_IMAGE_NAME_DEFAULT"
+    ARG DEVCONTAINER_IMAGE_TAG=latest
+    SAVE IMAGE --push "$DEVCONTAINER_IMAGE_NAME:$DEVCONTAINER_IMAGE_TAG" "$DEVCONTAINER_IMAGE_NAME:latest"
+
+devcontainer-rebuild:
+    RUN --no-cache date +%Y%m%d%H%M%S | tee buildtime
+    ARG DEVCONTAINER_IMAGE_NAME="$DEVCONTAINER_IMAGE_NAME_DEFAULT"
+    BUILD \
+        --platform=linux/amd64 \
+        --platform=linux/arm64 \
+        +devcontainer \
+        --DEVCONTAINER_IMAGE_NAME="$DEVCONTAINER_IMAGE_NAME" \
+        --DEVCONTAINER_IMAGE_TAG="$(cat buildtime)"
+    BUILD +devcontainer-update-refs \
+        --DEVCONTAINER_IMAGE_NAME="$DEVCONTAINER_IMAGE_NAME" \
+        --DEVCONTAINER_IMAGE_TAG="$(cat buildtime)"
+
+devcontainer-update-refs:
+    ARG --required DEVCONTAINER_IMAGE_NAME
+    ARG --required DEVCONTAINER_IMAGE_TAG
+    BUILD +devcontainer-update-ref \
+        --DEVCONTAINER_IMAGE_NAME="$DEVCONTAINER_IMAGE_NAME" \
+        --DEVCONTAINER_IMAGE_TAG="$DEVCONTAINER_IMAGE_TAG" \
+        --FILE='.devcontainer/docker-compose.yml'
+
+devcontainer-update-ref:
+    ARG --required DEVCONTAINER_IMAGE_NAME
+    ARG --required DEVCONTAINER_IMAGE_TAG
+    ARG --required FILE
+    COPY "$FILE" file.src
+    RUN sed -e "s#$DEVCONTAINER_IMAGE_NAME:[a-z0-9]*#$DEVCONTAINER_IMAGE_NAME:$DEVCONTAINER_IMAGE_TAG#g" file.src > file.out
+    SAVE ARTIFACT --keep-ts file.out $FILE AS LOCAL $FILE
+
+build-env:
+    # We specifically use an old distro to build against an old glibc.
+    # https://repology.org/project/glibc/versions
+    FROM ubuntu:xenial
+    RUN apt-get update \
+        && apt-get install -qqy --no-install-recommends \
+            software-properties-common \
+            curl \
+            build-essential \
+            autoconf \
+            automake \
+            libtool \
+            file \
+            git \
+            ninja-build \
+            pkg-config \
+            libgtk-3-dev \
+        #
+        # Clean up
+        && apt-get autoremove -y \
+        && apt-get clean -y \
+        && rm -rf /var/lib/apt/lists/*
+    # install a recent CMake
+    ARG --required TARGETARCH
+    ARG CMAKE_VERSION=3.25.0
+    RUN case "$TARGETARCH" in \
+            amd64) curl -fsSL "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-linux-x86_64.sh" -o cmake-install.sh;; \
+            arm64) curl -fsSL "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-linux-aarch64.sh" -o cmake-install.sh;; \
+            *) exit 1;; \
+        esac \
+        && sh cmake-install.sh --skip-license --prefix=/usr/local \
+        && rm cmake-install.sh \
+        && cmake --version | grep -q "$CMAKE_VERSION"
+    ARG LINK_TYPE="$LINK_TYPE_DEFAULT" # static or dynamic
+    RUN if [ "$LINK_TYPE" = "dynamic" ]; then \
+        apt-get update && apt-get install -qqy --no-install-recommends $LINK_DYNAMIC_PACKAGES \
+        #
+        # Clean up
+        && apt-get autoremove -y \
+        && apt-get clean -y \
+        && rm -rf /var/lib/apt/lists/* \
+    ; fi
+
+build:
+    ARG LINK_TYPE="$LINK_TYPE_DEFAULT" # static or dynamic
+    FROM +build-env --LINK_TYPE="$LINK_TYPE"
+    WORKDIR /src
+    COPY --dir boot cmake extra libs src vm .
+    COPY CMakeLists.txt CHANGES LICENSE README.md .
+    WORKDIR /src/build
+    RUN case "$LINK_TYPE" in \
+            static)  cmake .. -DSTATIC_DEPS=all  -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo;; \
+            dynamic) cmake .. -DSTATIC_DEPS=none -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo;; \
+            *) exit 1;; \
+        esac
+    RUN if [ "$LINK_TYPE" = "static" ]; then ninja download_deps; fi
+    RUN ninja
+    RUN ninja test
+    SAVE ARTIFACT bin/*
+
+package:
+    ARG LINK_TYPE="$LINK_TYPE_DEFAULT" # static or dynamic
+    FROM +build --LINK_TYPE="$LINK_TYPE"
+    RUN ninja package
+    # ARG --required TARGETOS
+    # ARG --required TARGETARCH
+    # RUN mv bin/neko-*.tar.gz "bin/neko-$(cmake -L -N -B . | awk -F '=' '/NEKO_VERSION/ {print $2}')-${TARGETOS}-${TARGETARCH}.tar.gz"
+    ARG --required TARGETPLATFORM
+    SAVE ARTIFACT --keep-ts bin/neko-*.tar.gz AS LOCAL bin/$LINK_TYPE/$TARGETPLATFORM/
+
+package-all-platforms:
+    BUILD --platform=linux/amd64 --platform=linux/arm64 +package
+
+extract-package:
+    ARG LINK_TYPE="$LINK_TYPE_DEFAULT" # static or dynamic
+    FROM +package --LINK_TYPE="$LINK_TYPE"
+    WORKDIR bin
+    RUN mkdir /tmp/neko && tar xf neko-*.tar.gz --strip-components 1 -C /tmp/neko
+    SAVE ARTIFACT /tmp/neko neko
+
+test-static-package:
+    ARG IMAGE=ubuntu:xenial
+    FROM $IMAGE
+    WORKDIR /tmp/neko
+    COPY +extract-package/neko .
+    ARG PREFIX=/usr/local
+    RUN mkdir -p $PREFIX/bin \
+        && mv neko nekotools nekoc nekoml $PREFIX/bin \
+        && mkdir -p $PREFIX/lib/neko \
+        && mv *.ndll nekoml.std $PREFIX/lib/neko \
+        && mv *.so* $PREFIX/lib \
+        && rm -rf * \
+        && ldconfig
+    RUN neko -version
+    RUN nekoc
+    RUN nekoml
+    RUN nekotools
+
+test-static-package-all-platforms:
+    ARG IMAGE=ubuntu:xenial
+    BUILD --platform=linux/amd64 --platform=linux/arm64 +test-static-package --IMAGE="$IMAGE"
diff --git a/LICENSE b/LICENSE
index 532778f..d42b259 100644
--- a/LICENSE
+++ b/LICENSE
@@ -1,7 +1,7 @@
 Neko Virtual Machine (neko) and Neko Tools (nekotools)
 ======================================================
 
-Copyright (C)2005-2017 Haxe Foundation
+Copyright (C)2005-2022 Haxe Foundation
 
 Permission is hereby granted, free of charge, to any person obtaining a
 copy of this software and associated documentation files (the "Software"),
@@ -46,7 +46,7 @@ Neko Runtime Libraries
 std, sqlite, mysql5, ui
 -----------------------
 
-Copyright (C)2005-2017 Haxe Foundation
+Copyright (C)2005-2022 Haxe Foundation
 
 Permission is hereby granted, free of charge, to any person obtaining a
 copy of this software and associated documentation files (the "Software"),
diff --git a/README.md b/README.md
index 70c16b3..b9106af 100644
--- a/README.md
+++ b/README.md
@@ -2,15 +2,21 @@
 
 [![Build Status](https://dev.azure.com/HaxeFoundation/GitHubPublic/_apis/build/status/HaxeFoundation.neko?branchName=master)](https://dev.azure.com/HaxeFoundation/GitHubPublic/_build/latest?definitionId=2&branchName=master)
 
+# Deprecated as of 2021-09-09
+
+**Neko is not actively maintained anymore.**
+
+We keep it compatible with existing Haxe standard library and Haxe language features. But don't expect any new features in Neko itself and don't expect implementation of any new Haxe standard library API.
+
 # Neko Virtual Machine
 
-See http://nekovm.org/
+See https://nekovm.org/
 
 ## Snapshot Builds
 
 Compiled binaries can be found in the "artifacts" link in the summary section of each [Azure Pipelines build](https://dev.azure.com/HaxeFoundation/GitHubPublic/_build?definitionId=2&_a=summary&repositoryFilter=2&branchFilter=14&statusFilter=succeeded).
 
-For macOS, Neko snapshot of the latest master branch can be built using [homebrew](http://brew.sh/) in a single command: `brew install neko --HEAD`. It will install required dependencies, build, and install Neko to the system. The binaries can be found at `brew --prefix neko`. Use `brew reinstall neko --HEAD` to upgrade in the future.
+For macOS, Neko snapshot of the latest master branch can be built using [homebrew](https://brew.sh/) in a single command: `brew install neko --HEAD`. It will install required dependencies, build, and install Neko to the system. The binaries can be found at `brew --prefix neko`. Use `brew reinstall neko --HEAD` to upgrade in the future.
 
 Ubuntu users can use the [Haxe Foundation snapshots PPA](https://launchpad.net/~haxe/+archive/ubuntu/snapshots) to install a Neko package built from the latest master branch. To do so, run the commands as follows:
 ```
@@ -25,7 +31,7 @@ Users of other Linux/FreeBSD distributions should build Neko from source. See be
 
 Neko can be built using CMake (version 3.x is recommended) and one of the C compilers listed as follows:
 
- * Windows: Visual Studio 2010 / 2013 / 2015 / 2017 
+ * Windows: Visual Studio 2010 / 2013 / 2015 / 2017
  * Mac: XCode (with its "Command line tools")
  * Linux: gcc (can be obtained by installing the "build-essential" Debian/Ubuntu package)
 
@@ -35,15 +41,15 @@ Neko needs to link with various third-party libraries, which are summarized as f
 |-----------------------------------------|-------------|-----------------------------------------------------------|
 | Boehm GC                                | all         | libgc-dev                                                 |
 | OpenSSL                                 | all         | libssl-dev                                                |
-| PCRE                                    | all         | libpcre3-dev                                              |
+| pcre2                                   | all         | libpcre2-dev                                              |
 | zlib                                    | all         | zlib1g-dev                                                |
 | Apache 2.2 / 2.4, with apr and apr-util | all         | apache2-dev                                               |
 | MariaDB / MySQL (Connector/C)           | all         | libmariadb-client-lgpl-dev-compat (or libmysqlclient-dev) |
 | SQLite                                  | all         | libsqlite3-dev                                            |
 | mbed TLS                                | all         | libmbedtls-dev                                            |
-| GTK+2                                   | Linux       | libgtk2.0-dev                                             |
+| GTK+3                                   | Linux       | libgtk-3-dev                                              |
 
-On Windows, CMake will automatically download and build the libraries in the build folder during the build process. However, you need to install [Perl](http://www.activestate.com/activeperl) manually because OpenSSL needs it for configuration. On Mac/Linux, you should install the libraries manually to your system before building Neko, or use the `STATIC_DEPS` CMake option, which will be explained in [CMake options](#cmake-options).
+On Windows, CMake will automatically download and build the libraries in the build folder during the build process. However, you need to install [Perl](https://www.activestate.com/activeperl) manually because OpenSSL needs it for configuration. On Mac/Linux, you should install the libraries manually to your system before building Neko, or use the `STATIC_DEPS` CMake option, which will be explained in [CMake options](#cmake-options).
 
 ### Building on Mac/Linux
 
@@ -73,7 +79,7 @@ You may use the CMake GUI and Visual Studio to build it instead.
 mkdir build
 cd build
 
-# run cmake specifying the visual studio version you need 
+# run cmake specifying the visual studio version you need
 # Visual Studio 12 2013, Visual Studio 14 2015, Visual Studio 15 2017
 # you can additionally specify platform via -A switch (x86, x64)
 cmake -G "Visual Studio 12 2013" ..
@@ -99,7 +105,7 @@ cmake "-Doption=value" ..
 Settings that allow to exclude libraries and their dependencies from the build; available on all platforms. By default all are `ON`:
 
 - `WITH_REGEXP` - Build Perl-compatible regex support
-- `WITH_UI` - Build GTK-2 UI support
+- `WITH_UI` - Build GTK-3 UI support
 - `WITH_SSL` - Build SSL support
 - `WITH_MYSQL` - Build MySQL support
 - `WITH_SQLITE` - Build Sqlite support
@@ -109,11 +115,11 @@ Settings that allow to exclude libraries and their dependencies from the build;
 
 Default value: `all` for Windows, `none` otherwise
 
-It defines the dependencies that should be linked statically. Can be `all`, `none`, or a list of library names (e.g. `BoehmGC;Zlib;OpenSSL;MariaDBConnector;PCRE;Sqlite3;APR;APRutil;Apache;MbedTLS`).
+It defines the dependencies that should be linked statically. Can be `all`, `none`, or a list of library names (e.g. `BoehmGC;Zlib;OpenSSL;MariaDBConnector;pcre2;Sqlite3;APR;APRutil;Apache;MbedTLS`).
 
 CMake will automatically download and build the specified dependencies into the build folder. If a library is not present in this list, it should be installed manually, and it will be linked dynamically.
 
-All third-party libraries, except GTK+2 (Linux), can be linked statically. We do not support statically linking GTK+2 due to the difficulty of building it and its own dependencies.
+All third-party libraries, except GTK+3 (Linux) and BoehmGC on Windows, can be linked statically. We do not support statically linking GTK+3 due to the difficulty of building it and its own dependencies. Additionally, we do not support statically linking the BoehmGC library on Windows systems. Finally, on MacOS, APRutil cannot be linked statically as it has been merged with APR 2.0, which is used on MacOS builds.
 
 #### `RELOCATABLE`
 
diff --git a/azure-pipelines.yml b/azure-pipelines.yml
index 85452cd..98177ca 100644
--- a/azure-pipelines.yml
+++ b/azure-pipelines.yml
@@ -4,6 +4,16 @@ variables:
     value: $(Build.Repository.Uri)
   - name: AZURE_PIPELINES_BRANCH
     value: $(Build.SourceBranchName)
+  - name: NEKO_VERSION
+    value: "2.4.0"
+
+trigger:
+  branches:
+    include:
+      - '*'
+  tags:
+    include:
+      - '*'
 
 stages:
   - stage: StageTest
@@ -11,11 +21,22 @@ stages:
       - template: extra/azure-pipelines/build-linux.yml
         parameters:
           name: LinuxStatic
-          staticDeps: 'true'
+          linkType: static
       - template: extra/azure-pipelines/build-linux.yml
         parameters:
           name: Linux
-          staticDeps: 'false'
+          linkType: dynamic
+
+      - template: extra/azure-pipelines/build-linux.yml
+        parameters:
+          name: LinuxStaticArm64
+          linkType: static
+          arch: arm64
+      - template: extra/azure-pipelines/build-linux.yml
+        parameters:
+          name: LinuxArm64
+          linkType: dynamic
+          arch: arm64
 
       - template: extra/azure-pipelines/build-mac.yml
         parameters:
@@ -28,25 +49,66 @@ stages:
 
       - template: extra/azure-pipelines/build-windows.yml
         parameters:
-          name: WinVS2015
-          vmImage: vs2015-win2012r2
-          cmakeGenerator: Visual Studio 14 2015
+          name: WinVS2017
+          vmImage: windows-2019
+          cmakeGenerator: Visual Studio 15 2017
+          arch: Win32
       - template: extra/azure-pipelines/build-windows.yml
         parameters:
-          name: WinVS2015x64
-          vmImage: vs2015-win2012r2
-          cmakeGenerator: Visual Studio 14 2015 Win64
+          name: WinVS2017x64
+          vmImage: windows-2019
+          cmakeGenerator: Visual Studio 15 2017 Win64
+          arch: x64
 
       - template: extra/azure-pipelines/build-windows.yml
         parameters:
-          name: WinVS2017
-          vmImage: vs2017-win2016
-          cmakeGenerator: Visual Studio 15 2017
+          name: WinVS2019
+          vmImage: windows-2019
+          cmakeGenerator: Visual Studio 16 2019
+          arch: Win32
       - template: extra/azure-pipelines/build-windows.yml
         parameters:
-          name: WinVS2017x64
-          vmImage: vs2017-win2016
-          cmakeGenerator: Visual Studio 15 2017 Win64
+          name: WinVS2019x64
+          vmImage: windows-2019
+          cmakeGenerator: Visual Studio 16 2019
+          arch: x64
+
+      - job: Chocolatey
+        dependsOn:
+          - WinVS2017
+          - WinVS2017x64
+        pool:
+          vmImage: windows-2019
+        steps:
+          - task: DownloadPipelineArtifact@0
+            inputs:
+              artifactName: WinVS2017Binaries
+              targetPath: WinVS2017Binaries
+            displayName: Download WinVS2017Binaries
+          - task: DownloadPipelineArtifact@0
+            inputs:
+              artifactName: WinVS2017x64Binaries
+              targetPath: WinVS2017x64Binaries
+            displayName: Download WinVS2017x64Binaries
+          - powershell: |
+              .\extra\chocolatey\generatePackage.ps1 $(NEKO_VERSION)
+              Get-ChildItem extra\chocolatey\out
+            displayName: Prepare Chocolatey Package
+          - powershell: |
+              $commitSha = git rev-parse --short HEAD
+              $commitTime = git show -s --format=%cI HEAD
+              $commitTime = $commitTime.substring(0,19) -replace '[^0-9]',''
+              $sourceBranch = '$(Build.SourceBranch)'
+              $chocoVersion = If ($sourceBranch.StartsWith('refs/tags/v')) {'$(NEKO_VERSION)'} Else {"$(NEKO_VERSION)-SNAP$commitTime"}
+              echo "##vso[task.setvariable variable=chocoVersion]$chocoVersion"
+            displayName: Format package version string
+          - powershell: choco pack --version $env:chocoVersion
+            workingDirectory: extra/chocolatey/out/
+            displayName: choco pack
+          - task: PublishPipelineArtifact@0
+            inputs:
+              artifactName: Chocolatey
+              targetPath: extra/chocolatey/out/
 
   - stage: StageDeploy
     condition: and(succeeded(), not(variables['System.PullRequest.PullRequestId']))
@@ -54,13 +116,18 @@ stages:
       - job: S3
         condition: and(succeeded(), variables['HXBUILDS_AWS_ACCESS_KEY_ID'], variables['HXBUILDS_S3ADDR'])
         pool:
-          vmImage: 'ubuntu-16.04'
+          vmImage: 'ubuntu-20.04'
         steps:
           - task: DownloadPipelineArtifact@0
             inputs:
               artifactName: LinuxStaticBinaries
               targetPath: LinuxStaticBinaries
             displayName: Download LinuxStaticBinaries
+          - task: DownloadPipelineArtifact@0
+            inputs:
+              artifactName: LinuxStaticArm64Binaries
+              targetPath: LinuxStaticArm64Binaries
+            displayName: Download LinuxStaticArm64Binaries
           - task: DownloadPipelineArtifact@0
             inputs:
               artifactName: MacStaticBinaries
@@ -68,24 +135,19 @@ stages:
             displayName: Download MacStaticBinaries
           - task: DownloadPipelineArtifact@0
             inputs:
-              artifactName: WinVS2015Binaries
-              targetPath: WinVS2015Binaries
-            displayName: Download WinVS2015Binaries
+              artifactName: WinVS2017Binaries
+              targetPath: WinVS2017Binaries
+            displayName: Download WinVS2017Binaries
           - task: DownloadPipelineArtifact@0
             inputs:
-              artifactName: WinVS2015x64Binaries
-              targetPath: WinVS2015x64Binaries
-            displayName: Download WinVS2015x64Binaries
+              artifactName: WinVS2017x64Binaries
+              targetPath: WinVS2017x64Binaries
+            displayName: Download WinVS2017x64Binaries
           - task: DownloadPipelineArtifact@0
             inputs:
-              artifactName: WinVS2015Choco
-              targetPath: WinVS2015Choco
-            displayName: Download WinVS2015Choco
-          - task: DownloadPipelineArtifact@0
-            inputs:
-              artifactName: WinVS2015x64Choco
-              targetPath: WinVS2015x64Choco
-            displayName: Download WinVS2015x64Choco
+              artifactName: Chocolatey
+              targetPath: Chocolatey
+            displayName: Download Chocolatey
           - script: |
               set -ex
               sudo apt-get update -qqy
@@ -98,35 +160,39 @@ stages:
               COMMIT_DATE=`TZ=UTC git show --quiet --date='format-local:%Y-%m-%d' --format="%cd"`
               FILE_NAME=neko_${COMMIT_DATE}_$(Build.SourceBranchName)_${COMMIT_HASH_SHORT}
               aws s3 cp LinuxStaticBinaries/neko-*.tar.gz  $(HXBUILDS_S3ADDR)/neko/linux64/${FILE_NAME}.tar.gz
+              aws s3 cp LinuxStaticArm64Binaries/neko-*.tar.gz  $(HXBUILDS_S3ADDR)/neko/linux-arm64/${FILE_NAME}.tar.gz
               aws s3 cp MacStaticBinaries/neko-*.tar.gz    $(HXBUILDS_S3ADDR)/neko/mac/${FILE_NAME}.tar.gz
-              aws s3 cp WinVS2015Binaries/neko-*.zip       $(HXBUILDS_S3ADDR)/neko/windows/${FILE_NAME}.zip
-              aws s3 cp WinVS2015Choco/*.nupkg             $(HXBUILDS_S3ADDR)/neko/windows-choco/
-              aws s3 cp WinVS2015x64Choco/*.nupkg          $(HXBUILDS_S3ADDR)/neko/windows64-choco/
+              aws s3 cp WinVS2017Binaries/neko-*.zip       $(HXBUILDS_S3ADDR)/neko/windows/${FILE_NAME}.zip
+              aws s3 cp WinVS2017x64Binaries/neko-*.zip    $(HXBUILDS_S3ADDR)/neko/windows64/${FILE_NAME}.zip
+              aws s3 cp Chocolatey/*.nupkg                 $(HXBUILDS_S3ADDR)/neko/windows64-choco/
             env:
               AWS_ACCESS_KEY_ID: $(HXBUILDS_AWS_ACCESS_KEY_ID)
               AWS_SECRET_ACCESS_KEY: $(HXBUILDS_AWS_SECRET_ACCESS_KEY)
+              AWS_EC2_METADATA_DISABLED: true
             displayName: Upload binaries
           - script: |
               set -ex
               aws s3 cp LinuxStaticBinaries/neko-*.tar.gz  $(HXBUILDS_S3ADDR)/neko/linux64/neko_latest.tar.gz
+              aws s3 cp LinuxStaticArm64Binaries/neko-*.tar.gz  $(HXBUILDS_S3ADDR)/neko/linux-arm64/neko_latest.tar.gz
               aws s3 cp MacStaticBinaries/neko-*.tar.gz    $(HXBUILDS_S3ADDR)/neko/mac/neko_latest.tar.gz
-              aws s3 cp WinVS2015Binaries/neko-*.zip       $(HXBUILDS_S3ADDR)/neko/windows/neko_latest.zip
-              aws s3 cp WinVS2015x64Binaries/neko-*.zip    $(HXBUILDS_S3ADDR)/neko/windows64/neko_latest.zip
+              aws s3 cp WinVS2017Binaries/neko-*.zip       $(HXBUILDS_S3ADDR)/neko/windows/neko_latest.zip
+              aws s3 cp WinVS2017x64Binaries/neko-*.zip    $(HXBUILDS_S3ADDR)/neko/windows64/neko_latest.zip
 
               # Chocolatey packages have to be named with version number,
               # so let's use web redirection to keep the original file name.
               [[ "$HXBUILDS_S3ADDR" =~ s3://([^/]+)(.*) ]] && HXBUILDS_S3BUCKET="${BASH_REMATCH[1]}" && HXBUILDS_S3PATH="${BASH_REMATCH[2]}"
-              [[ `echo WinVS2015Choco/*.nupkg` =~ WinVS2015Choco/(.+) ]] && FILE_NAME="${BASH_REMATCH[1]}"
-              aws s3 cp $(HXBUILDS_S3ADDR)/neko/windows-choco/${FILE_NAME}     $(HXBUILDS_S3ADDR)/neko/windows-choco/neko_latest.nupkg     --acl public-read --website-redirect "${HXBUILDS_S3PATH}/neko/windows-choco/${FILE_NAME}"
-              [[ `echo WinVS2015x64Choco/*.nupkg` =~ WinVS2015x64Choco/(.+) ]] && FILE_NAME="${BASH_REMATCH[1]}"
+              [[ `echo Chocolatey/*.nupkg` =~ Chocolatey/(.+) ]] && FILE_NAME="${BASH_REMATCH[1]}"
               aws s3 cp $(HXBUILDS_S3ADDR)/neko/windows64-choco/${FILE_NAME}   $(HXBUILDS_S3ADDR)/neko/windows64-choco/neko_latest.nupkg   --acl public-read --website-redirect "${HXBUILDS_S3PATH}/neko/windows64-choco/${FILE_NAME}"
             env:
               AWS_ACCESS_KEY_ID: $(HXBUILDS_AWS_ACCESS_KEY_ID)
               AWS_SECRET_ACCESS_KEY: $(HXBUILDS_AWS_SECRET_ACCESS_KEY)
+              AWS_EC2_METADATA_DISABLED: true
             condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'master'))
             displayName: Update "latest"
       - job: PPA
         condition: and(succeeded(), variables['PPA'], variables['DEBFULLNAME'], variables['DEBEMAIL'])
+        pool:
+          vmImage: 'ubuntu-20.04'
         steps:
           - task: DownloadSecureFile@1
             inputs:
@@ -148,7 +214,7 @@ stages:
           - script: |
               set -ex
               sudo apt-get update -qqy
-              sudo apt-get install -qqy ninja-build pkg-config libgtk2.0-dev devscripts git-buildpackage ubuntu-dev-tools dh-make dh-apache2
+              sudo apt-get install -qqy ninja-build pkg-config libgtk-3-dev devscripts git-buildpackage ubuntu-dev-tools dh-make dh-apache2
             displayName: Install devscripts
           - script: cmake . -DSTATIC_DEPS=all
             displayName: CMake
diff --git a/cmake/FindGTK2.cmake b/cmake/FindGTK3.cmake
similarity index 56%
rename from cmake/FindGTK2.cmake
rename to cmake/FindGTK3.cmake
index e784692..714f66a 100644
--- a/cmake/FindGTK2.cmake
+++ b/cmake/FindGTK3.cmake
@@ -1,64 +1,64 @@
-FILE(TO_CMAKE_PATH "$ENV{GTK2_DIR}" TRY1_DIR)
-FILE(TO_CMAKE_PATH "${GTK2_DIR}" TRY2_DIR)
+FILE(TO_CMAKE_PATH "$ENV{GTK3_DIR}" TRY1_DIR)
+FILE(TO_CMAKE_PATH "${GTK3_DIR}" TRY2_DIR)
 FILE(GLOB GTK_DIR ${TRY1_DIR} ${TRY2_DIR})
 
-FIND_PATH(GTK_gtk_2_INCLUDE_DIR gtk/gtk.h
+FIND_PATH(GTK_gtk_3_INCLUDE_DIR gtk/gtk.h
                                 ENV INCLUDE DOC "Directory containing gtk/gtk.h include file")
 
-FIND_PATH(GTK_gdk_2_INCLUDE_DIR gdk/gdk.h
+FIND_PATH(GTK_gdk_3_INCLUDE_DIR gdk/gdk.h
                                 ENV INCLUDE DOC "Directory containing gdk/gdk.h include file")
 
-FIND_PATH(GTK_gdkconfig_2_INCLUDE_DIR gdkconfig.h
+FIND_PATH(GTK_gdkconfig_3_INCLUDE_DIR gdkconfig.h
                                       ENV INCLUDE DOC "Directory containing gdkconfig.h include file")
 
-FIND_LIBRARY(GTK_gdk_pixbuf_2_LIBRARY NAMES gdk_pixbuf-2.0
+FIND_LIBRARY(GTK_gdk_pixbuf_3_LIBRARY NAMES gdk_pixbuf-3.0
                                       PATHS ${GTK_DIR}/lib ${GTK_DIR}/bin ${GTK_DIR}/win32/bin ${GTK_DIR}/lib ${GTK_DIR}/win32/lib /usr/local/lib /usr/lib
                                       ENV LIB
                                       DOC "gdk_pixbuf library to link with"
                                       NO_SYSTEM_ENVIRONMENT_PATH)
 
-FIND_LIBRARY(GTK_gdk_2_LIBRARY NAMES gdk-win32-2.0 gdk-x11-2.0
+FIND_LIBRARY(GTK_gdk_3_LIBRARY NAMES gdk-win32-3.0 gdk-x11-3.0
                                      PATHS ${GTK_DIR}/lib ${GTK_DIR}/bin ${GTK_DIR}/win32/bin ${GTK_DIR}/lib ${GTK_DIR}/win32/lib /usr/lib /usr/local/lib
                                      ENV LIB
-                                     DOC "gdk2 library to link with"
+                                     DOC "gdk3 library to link with"
                                      NO_SYSTEM_ENVIRONMENT_PATH)
 
-FIND_LIBRARY(GTK_gtk_2_LIBRARY NAMES gtk-win32-2.0 gtk-x11-2.0
+FIND_LIBRARY(GTK_gtk_3_LIBRARY NAMES gtk-win32-3.0 gtk-x11-3.0
                                      PATHS ${GTK_DIR}/lib ${GTK_DIR}/bin ${GTK_DIR}/win32/bin ${GTK_DIR}/lib ${GTK_DIR}/win32/lib /usr/lib /usr/local/lib
                                      ENV LIB
-                                     DOC "gtk2 library to link with"
+                                     DOC "gtk3 library to link with"
                                      NO_SYSTEM_ENVIRONMENT_PATH)
 
-FIND_LIBRARY(GTK_gdk_pixbuf_2_STATIC_LIBRARY NAMES libgdk_pixbuf-2.0.a
+FIND_LIBRARY(GTK_gdk_pixbuf_3_STATIC_LIBRARY NAMES libgdk_pixbuf-3.0.a
                                       PATHS ${GTK_DIR}/lib ${GTK_DIR}/bin ${GTK_DIR}/win32/bin ${GTK_DIR}/lib ${GTK_DIR}/win32/lib /usr/local/lib /usr/lib
                                       ENV LIB
                                       DOC "gdk_pixbuf library to link with"
                                       NO_SYSTEM_ENVIRONMENT_PATH)
 
-FIND_LIBRARY(GTK_gdk_2_STATIC_LIBRARY NAMES libgdk-x11-2.0.a
+FIND_LIBRARY(GTK_gdk_3_STATIC_LIBRARY NAMES libgdk-x11-3.0.a
                                      PATHS ${GTK_DIR}/lib ${GTK_DIR}/bin ${GTK_DIR}/win32/bin ${GTK_DIR}/lib ${GTK_DIR}/win32/lib /usr/lib /usr/local/lib
                                      ENV LIB
-                                     DOC "gdk2 library to link with"
+                                     DOC "gdk3 library to link with"
                                      NO_SYSTEM_ENVIRONMENT_PATH)
 
-FIND_LIBRARY(GTK_gtk_2_STATIC_LIBRARY NAMES libgtk-x11-2.0.a
+FIND_LIBRARY(GTK_gtk_3_STATIC_LIBRARY NAMES libgtk-x11-3.0.a
                                      PATHS ${GTK_DIR}/lib ${GTK_DIR}/bin ${GTK_DIR}/win32/bin ${GTK_DIR}/lib ${GTK_DIR}/win32/lib /usr/lib /usr/local/lib
                                      ENV LIB
-                                     DOC "gtk2 library to link with"
+                                     DOC "gtk3 library to link with"
                                      NO_SYSTEM_ENVIRONMENT_PATH)
 
 
-IF (GTK_gtk_2_INCLUDE_DIR AND GTK_gdk_2_INCLUDE_DIR AND GTK_gdkconfig_2_INCLUDE_DIR)
-  SET(GTK2_INCLUDE_DIR ${GTK_gtk_2_INCLUDE_DIR} ${GTK_gdk_2_INCLUDE_DIR} ${GTK_gdkconfig_2_INCLUDE_DIR})
-  list(REMOVE_DUPLICATES GTK2_INCLUDE_DIR)
-  SET(GTK2_LIBRARIES ${GTK_gdk_pixbuf_2_LIBRARY} ${GTK_gdk_2_LIBRARY} ${GTK_gtk_2_LIBRARY})
-  list(REMOVE_DUPLICATES GTK2_LIBRARIES)
-  SET(GTK2_STATIC_LIBRARIES ${GTK_gdk_pixbuf_2_STATIC_LIBRARY} ${GTK_gdk_2_STATIC_LIBRARY} ${GTK_gtk_2_STATIC_LIBRARY})
-  list(REMOVE_DUPLICATES GTK2_STATIC_LIBRARIES)
-  SET(GTK2_FOUND TRUE)
+IF (GTK_gtk_3_INCLUDE_DIR AND GTK_gdk_3_INCLUDE_DIR AND GTK_gdkconfig_3_INCLUDE_DIR)
+  SET(GTK3_INCLUDE_DIR ${GTK_gtk_3_INCLUDE_DIR} ${GTK_gdk_3_INCLUDE_DIR} ${GTK_gdkconfig_3_INCLUDE_DIR})
+  list(REMOVE_DUPLICATES GTK3_INCLUDE_DIR)
+  SET(GTK3_LIBRARIES ${GTK_gdk_pixbuf_3_LIBRARY} ${GTK_gdk_3_LIBRARY} ${GTK_gtk_3_LIBRARY})
+  list(REMOVE_DUPLICATES GTK3_LIBRARIES)
+  SET(GTK3_STATIC_LIBRARIES ${GTK_gdk_pixbuf_3_STATIC_LIBRARY} ${GTK_gdk_3_STATIC_LIBRARY} ${GTK_gtk_3_STATIC_LIBRARY})
+  list(REMOVE_DUPLICATES GTK3_STATIC_LIBRARIES)
+  SET(GTK3_FOUND TRUE)
 
 
-  message(STATUS "GTK2_INCLUDE_DIR: ${GTK2_INCLUDE_DIR}")
-  message(STATUS "GTK2_LIBRARIES: ${GTK2_LIBRARIES}")
-  message(STATUS "GTK2_STATIC_LIBRARIES: ${GTK2_STATIC_LIBRARIES}")
-ENDIF ()
\ No newline at end of file
+  message(STATUS "GTK3_INCLUDE_DIR: ${GTK3_INCLUDE_DIR}")
+  message(STATUS "GTK3_LIBRARIES: ${GTK3_LIBRARIES}")
+  message(STATUS "GTK3_STATIC_LIBRARIES: ${GTK3_STATIC_LIBRARIES}")
+ENDIF ()
diff --git a/cmake/FindPCRE.cmake b/cmake/FindPCRE.cmake
deleted file mode 100644
index 329a2a3..0000000
--- a/cmake/FindPCRE.cmake
+++ /dev/null
@@ -1,55 +0,0 @@
-# https://github.com/CBL-ORION/Vaa3D-tools-mirror/blob/filter-large-files/released_plugins/v3d_plugins/neurontracing_neutube/src_neutube/neurolabi/c/cmake_modules/FindPCRE.cmake
-
-# - Try to find PCRE
-# Once done, this will define
-#
-#  PCRE_FOUND - system has PCRE
-#  PCRE_INCLUDE_DIRS - the PCRE include directories
-#  PCRE_LIBRARIES - link these to use PCRE
-#
-# By default, the dynamic libraries will be found. To find the static ones instead,
-# you must set the PCRE_STATIC_LIBRARY variable to TRUE before calling find_package.
-#
-
-include(LibFindMacros)
-
-# Use pkg-config to get hints about paths
-libfind_pkg_check_modules(PCRE_PKGCONF libpcre)
-
-# attempt to find static library first if this is set
-if(PCRE_STATIC_LIBRARY)
-  set(PCRE_POSIX_STATIC libpcreposix.a)
-  set(PCRE_STATIC libpcre.a)
-endif(PCRE_STATIC_LIBRARY)
-
-# additional hints
-if(MINGW)
-  set(CMAKE_PREFIX_PATH ${CMAKE_PREFIX_PATH} C:/Mingw)
-endif(MINGW)
-
-if(MSVC)
-  set(CMAKE_PREFIX_PATH ${CMAKE_PREFIX_PATH} D:/devlib/vc/PCRE)
-endif(MSVC)
-
-# Include dir
-find_path(PCRE_INCLUDE_DIR
-  NAMES pcreposix.h
-  PATHS ${PCRE_PKGCONF_INCLUDE_DIRS}
-)
-
-# Finally the library itself
-find_library(PCRE_POSIX_LIBRARY
-  NAMES ${PCRE_POSIX_STATIC} pcreposix
-  PATHS ${PCRE_PKGCONF_LIBRARY_DIRS}
-)
-find_library(PCRE_LIBRARY
-  NAMES ${PCRE_STATIC} pcre
-  PATHS ${PCRE_PKGCONF_LIBRARY_DIRS}
-)
-set(PCRE_POSIX_LIBRARY ${PCRE_POSIX_LIBRARY} ${PCRE_LIBRARY})
-
-# Set the include dir variables and the libraries and let libfind_process do the rest.
-# NOTE: Singular variables for this library, plural for libraries this this lib depends on.
-set(PCRE_PROCESS_INCLUDES PCRE_INCLUDE_DIR)
-set(PCRE_PROCESS_LIBS PCRE_POSIX_LIBRARY)
-libfind_process(PCRE)
\ No newline at end of file
diff --git a/cmake/FindPCRE2.cmake b/cmake/FindPCRE2.cmake
new file mode 100644
index 0000000..f5409e4
--- /dev/null
+++ b/cmake/FindPCRE2.cmake
@@ -0,0 +1,19 @@
+# https://github.com/refu-lang/rfbase/blob/master/cmake/FindPCRE2.cmake
+
+# This CMake file tries to find the Perl regular expression libraries
+# The following variables are set:
+# PCRE2_FOUND - System has the PCRE library
+# PCRE2_LIBRARIES - The PCRE library file
+# PCRE2_INCLUDE_DIRS - The folder with the PCRE headers
+
+find_library(PCRE2_LIBRARIES NAMES pcre2 pcre2-8)
+find_path(PCRE2_INCLUDE_DIRS pcre2.h)
+if(PCRE2_LIBRARIES AND PCRE2_INCLUDE_DIRS)
+  message(STATUS "PCRE2 libs: ${PCRE2_LIBRARIES}")
+  message(STATUS "PCRE2 include directory: ${PCRE2_INCLUDE_DIRS}")
+  set(PCRE2_FOUND TRUE CACHE BOOL "Found PCRE2 libraries" FORCE)
+  add_custom_target(pcre2)
+else()
+  set(PCRE2_FOUND FALSE CACHE BOOL "Found PCRE2 libraries" FORCE)
+  message(STATUS "PCRE2 library not found.")
+endif()
diff --git a/cmake/flatten.cmake.in b/cmake/flatten.cmake.in
index 32b8a38..fa490b8 100644
--- a/cmake/flatten.cmake.in
+++ b/cmake/flatten.cmake.in
@@ -1,31 +1,16 @@
 # Detect if the install is run by CPack.
 if (${CMAKE_INSTALL_PREFIX} MATCHES "/_CPack_Packages/.*/(TGZ|ZIP)/")
 	# Flatten the directory structure such that everything except the header files is placed in root.
-	if (${CMAKE_VERSION} VERSION_LESS 3.3)
-		file(GLOB bin_files ${CMAKE_INSTALL_PREFIX}/bin/*)
-		file(GLOB lib_files ${CMAKE_INSTALL_PREFIX}/lib/* ${CMAKE_INSTALL_PREFIX}/lib/**/*)
-		foreach(file ${bin_files} ${lib_files})
-			if (NOT IS_DIRECTORY ${file})
-				get_filename_component(file_name ${file} NAME)
-				execute_process(
-					COMMAND ${CMAKE_COMMAND} -E rename
-					${file}
-					${CMAKE_INSTALL_PREFIX}/${file_name}
-				)
-			endif()
-		endforeach()
-	else()
-		file(GLOB bin_files LIST_DIRECTORIES FALSE ${CMAKE_INSTALL_PREFIX}/bin/*)
-		file(GLOB lib_files LIST_DIRECTORIES FALSE ${CMAKE_INSTALL_PREFIX}/lib/* ${CMAKE_INSTALL_PREFIX}/lib/**/*)
-		foreach(file ${bin_files} ${lib_files})
-			get_filename_component(file_name ${file} NAME)
-			execute_process(
-				COMMAND ${CMAKE_COMMAND} -E rename
-				${file}
-				${CMAKE_INSTALL_PREFIX}/${file_name}
-			)
-		endforeach()
-	endif()
+	file(GLOB bin_files LIST_DIRECTORIES FALSE ${CMAKE_INSTALL_PREFIX}/bin/*)
+	file(GLOB lib_files LIST_DIRECTORIES FALSE ${CMAKE_INSTALL_PREFIX}/lib/* ${CMAKE_INSTALL_PREFIX}/lib/**/*)
+	foreach(file ${bin_files} ${lib_files})
+		get_filename_component(file_name ${file} NAME)
+		execute_process(
+			COMMAND ${CMAKE_COMMAND} -E rename
+			${file}
+			${CMAKE_INSTALL_PREFIX}/${file_name}
+		)
+	endforeach()
 	execute_process( COMMAND ${CMAKE_COMMAND} -E remove_directory ${CMAKE_INSTALL_PREFIX}/bin)
 	execute_process( COMMAND ${CMAKE_COMMAND} -E remove_directory ${CMAKE_INSTALL_PREFIX}/lib)
 
diff --git a/cmake/package_choco.cmake b/cmake/package_choco.cmake
index 44c2f86..fbb1950 100644
--- a/cmake/package_choco.cmake
+++ b/cmake/package_choco.cmake
@@ -1,21 +1,25 @@
 find_package(Git REQUIRED)
 
-# format SNAPSHOT_VERSION
-execute_process(
-	COMMAND ${GIT_EXECUTABLE} rev-parse --short HEAD
-	OUTPUT_VARIABLE COMMIT_SHA
-	OUTPUT_STRIP_TRAILING_WHITESPACE
-)
-execute_process(
-	COMMAND ${GIT_EXECUTABLE} show -s --format=%cI HEAD
-	OUTPUT_VARIABLE COMMIT_TIME
-	OUTPUT_STRIP_TRAILING_WHITESPACE
-)
-string(SUBSTRING ${COMMIT_TIME} 0 19 COMMIT_TIME)
-string(REGEX REPLACE [^0-9] "" COMMIT_TIME ${COMMIT_TIME})
-set(SNAPSHOT_VERSION ${NEKO_VERSION}-SNAP${COMMIT_TIME})
+# format CHOCO_VERSION
+if(DEFINED ENV{TAG_RELEASE})
+	set(CHOCO_VERSION ${NEKO_VERSION})
+else()
+	execute_process(
+		COMMAND ${GIT_EXECUTABLE} rev-parse --short HEAD
+		OUTPUT_VARIABLE COMMIT_SHA
+		OUTPUT_STRIP_TRAILING_WHITESPACE
+	)
+	execute_process(
+		COMMAND ${GIT_EXECUTABLE} show -s --format=%cI HEAD
+		OUTPUT_VARIABLE COMMIT_TIME
+		OUTPUT_STRIP_TRAILING_WHITESPACE
+	)
+	string(SUBSTRING ${COMMIT_TIME} 0 19 COMMIT_TIME)
+	string(REGEX REPLACE [^0-9] "" COMMIT_TIME ${COMMIT_TIME})
+	set(CHOCO_VERSION ${NEKO_VERSION}-SNAP${COMMIT_TIME})
+endif()
 
-message(STATUS "building package version ${SNAPSHOT_VERSION} using ${bin_archive}")
+message(STATUS "building package version ${CHOCO_VERSION} using ${bin_archive}")
 
 
 get_filename_component(bin_archive_dir ${bin_archive} DIRECTORY)
@@ -31,15 +35,25 @@ configure_file(
 	@ONLY
 )
 configure_file(
-	${source_dir}/extra/chocolateyInstall.ps1
+	${source_dir}/extra/chocolatey/chocolateyInstall.ps1
 	${bin_archive_dir}/${bin_archive_name_we}/chocolateyInstall.ps1
 	@ONLY
 )
 configure_file(
-	${source_dir}/extra/chocolateyUninstall.ps1
+	${source_dir}/extra/chocolatey/chocolateyUninstall.ps1
 	${bin_archive_dir}/${bin_archive_name_we}/chocolateyUninstall.ps1
 	@ONLY
 )
+configure_file(
+	${source_dir}/LICENSE
+	${bin_archive_dir}/${bin_archive_name_we}/LICENSE
+	@ONLY
+)
+configure_file(
+	${source_dir}/extra/chocolatey/VERIFICATION.txt
+	${bin_archive_dir}/${bin_archive_name_we}/VERIFICATION.txt
+	@ONLY
+)
 execute_process(
 	COMMAND choco pack
 	WORKING_DIRECTORY ${bin_archive_dir}/${bin_archive_name_we}
diff --git a/cmake/patch_mariadb.cmake b/cmake/patch_mariadb.cmake
index 7007623..6d2e150 100644
--- a/cmake/patch_mariadb.cmake
+++ b/cmake/patch_mariadb.cmake
@@ -10,5 +10,17 @@ string(REPLACE
 	content ${content}
 )
 
+file(WRITE ${cmakelists} ${content})
+
+set(cmakelists ${mariadb_source}/cmake/ConnectorName.cmake)
+
+file(READ ${cmakelists} content)
+
+# Fix broken syntax on newer CMake
+string(REPLACE
+	"  END()"
+	"  ENDIF()"
+	content ${content}
+)
 
 file(WRITE ${cmakelists} ${content})
\ No newline at end of file
diff --git a/cmake/source_archive_fat.cmake b/cmake/source_archive_fat.cmake
index 4e1ce00..66131d7 100644
--- a/cmake/source_archive_fat.cmake
+++ b/cmake/source_archive_fat.cmake
@@ -8,22 +8,11 @@ execute_process(
 file(RENAME ${source_archive_dir}/${source_archive_name_we} ${source_archive_dir}/${source_archive_fat_name_we})
 
 
-if (${CMAKE_VERSION} VERSION_LESS 3.3)
-	file(GLOB archives
-		${bin_dir}/${lib_src_dir}/*
-	)
-	foreach(file ${archives})
-		if(NOT IS_DIRECTORY ${file})
-			file(COPY ${file} DESTINATION ${source_archive_dir}/${source_archive_fat_name_we}/${lib_src_dir})
-		endif()
-	endforeach()
-else()
-	file(GLOB archives
-		LIST_DIRECTORIES FALSE
-		${bin_dir}/${lib_src_dir}/*
-	)
-	file(COPY ${archives} DESTINATION ${source_archive_dir}/${source_archive_fat_name_we}/${lib_src_dir})
-endif()
+file(GLOB archives
+	LIST_DIRECTORIES FALSE
+	${bin_dir}/${lib_src_dir}/*
+)
+file(COPY ${archives} DESTINATION ${source_archive_dir}/${source_archive_fat_name_we}/${lib_src_dir})
 
 if (${source_archive_fat_name} MATCHES ^.*.zip$)
 	execute_process(
@@ -32,7 +21,7 @@ if (${source_archive_fat_name} MATCHES ^.*.zip$)
 	)
 else()
 	execute_process(
-		COMMAND ${CMAKE_COMMAND} -E tar czf ${source_archive_fat_name} ${source_archive_dir}/${source_archive_fat_name_we} 
+		COMMAND ${CMAKE_COMMAND} -E tar czf ${source_archive_fat_name} ${source_archive_dir}/${source_archive_fat_name_we}
 		WORKING_DIRECTORY ${source_archive_dir}
 	)
 endif()
diff --git a/extra/azure-pipelines/Brewfile-STATIC_DEPS_ALL b/extra/azure-pipelines/Brewfile-STATIC_DEPS_ALL
index a94fdd6..b00159a 100644
--- a/extra/azure-pipelines/Brewfile-STATIC_DEPS_ALL
+++ b/extra/azure-pipelines/Brewfile-STATIC_DEPS_ALL
@@ -1,3 +1,4 @@
 brew "cmake"
 brew "ninja"
 brew "pkg-config"
+brew "automake"
diff --git a/extra/azure-pipelines/Brewfile-STATIC_DEPS_NONE b/extra/azure-pipelines/Brewfile-STATIC_DEPS_NONE
index 099c55b..d487485 100644
--- a/extra/azure-pipelines/Brewfile-STATIC_DEPS_NONE
+++ b/extra/azure-pipelines/Brewfile-STATIC_DEPS_NONE
@@ -3,5 +3,5 @@ brew "ninja"
 brew "pkg-config"
 brew "bdw-gc"
 brew "mariadb-connector-c"
-brew "mbedtls"
-brew "pcre"
+brew "mbedtls@2", link: true
+brew "pcre2"
diff --git a/extra/azure-pipelines/build-linux.yml b/extra/azure-pipelines/build-linux.yml
index f7235b1..8f96ff1 100644
--- a/extra/azure-pipelines/build-linux.yml
+++ b/extra/azure-pipelines/build-linux.yml
@@ -1,60 +1,25 @@
 parameters:
   name: 'BuildLinux'
-  vmImage: 'ubuntu-16.04'
-  staticDeps: 'true'
-  config: 'RelWithDebInfo'
+  vmImage: 'ubuntu-20.04'
+  linkType: 'static'
+  arch: 'amd64'
 
 jobs:
   - job: ${{ parameters.name }}
+    timeoutInMinutes: 0
     pool:
       vmImage: ${{ parameters.vmImage }}
-    variables:
-      ${{ if eq(parameters.staticDeps, 'true') }}:
-        APT_PACKAGES: cmake ninja-build pkg-config libgtk2.0-dev
-        STATIC_DEPS: all
-      ${{ if eq(parameters.staticDeps, 'false') }}:
-        APT_PACKAGES: cmake ninja-build pkg-config libgtk2.0-dev libgc-dev libpcre3-dev zlib1g-dev apache2-dev libmysqlclient-dev libsqlite3-dev
-        STATIC_DEPS: none
     steps:
+      - script: sudo /bin/sh -c 'wget https://github.com/earthly/earthly/releases/latest/download/earthly-linux-amd64 -O /usr/local/bin/earthly && chmod +x /usr/local/bin/earthly && /usr/local/bin/earthly bootstrap --with-autocomplete'
+        displayName: Install Earthly
       - script: |
-          set -ex
-          sudo apt-get update -qqy
-          sudo apt-get install -qqy $(APT_PACKAGES)
-        displayName: Install dependencies
-      - ${{ if eq(parameters.staticDeps, 'false') }}:
-        - script: |
-            set -ex
-            mkdir ~/mbedtls
-            pushd ~/mbedtls
-            wget https://tls.mbed.org/download/mbedtls-2.2.1-apache.tgz
-            tar xzf mbedtls-2.2.1-apache.tgz
-            cd mbedtls-2.2.1 && sed -i "s/\/\/#define MBEDTLS_THREADING_PTHREAD/#define MBEDTLS_THREADING_PTHREAD/; s/\/\/#define MBEDTLS_THREADING_C/#define MBEDTLS_THREADING_C/; s/#define MBEDTLS_SSL_PROTO_SSL3/\/\/#define MBEDTLS_SSL_PROTO_SSL3/" include/mbedtls/config.h
-            SHARED=1 make lib
-            sudo make install
-            popd
-          displayName: Install mbedTLS
-      - script: cmake . -DSTATIC_DEPS=$(STATIC_DEPS) -G Ninja -DCMAKE_BUILD_TYPE=${{ parameters.config }}
-        displayName: CMake
-      - ${{ if eq(parameters.staticDeps, 'true') }}:
-        - script: ninja download_static_deps || ninja download_static_deps || ninja download_static_deps
-          displayName: Download static deps
-      - script: |
-          set -ex
-          unset MACHINE RELEASE SYSTEM VERSION # https://marc.info/?l=gentoo-commits&m=155026142713994
-          ninja
-        displayName: Build
-      - script: |
-          set -ex
-          ldd -v ./bin/neko
-          ldd -v ./bin/nekoc
-          ldd -v ./bin/nekoml
-          ldd -v ./bin/nekotools
-        displayName: Check runtime dependencies
-      - script: ctest --verbose
-        displayName: Test
-      - script: ninja package
-        displayName: Package
+          sudo apt-get install qemu binfmt-support qemu-user-static
+          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
+          docker stop earthly-buildkitd || true
+        displayName: Install QEMU
+      - script: earthly --platform=linux/${{ parameters.arch }} +package --LINK_TYPE=${{ parameters.linkType }}
+        displayName: Build package
       - task: PublishPipelineArtifact@0
         inputs:
           artifactName: ${{ parameters.name }}Binaries
-          targetPath: bin/neko-2.3.0-linux64.tar.gz
\ No newline at end of file
+          targetPath: bin/${{ parameters.linkType }}/linux/${{ parameters.arch }}/neko-$(NEKO_VERSION)-linux64.tar.gz
diff --git a/extra/azure-pipelines/build-mac.yml b/extra/azure-pipelines/build-mac.yml
index 9a89e7e..843e511 100644
--- a/extra/azure-pipelines/build-mac.yml
+++ b/extra/azure-pipelines/build-mac.yml
@@ -1,11 +1,12 @@
 parameters:
   name: 'BuildMac'
-  vmImage: 'macOS-10.13'
+  vmImage: 'macOS-10.15'
   staticDeps: 'true'
   config: 'RelWithDebInfo'
 
 jobs:
   - job: ${{ parameters.name }}
+    timeoutInMinutes: 90
     pool:
       vmImage: ${{ parameters.vmImage }}
     variables:
@@ -24,7 +25,7 @@ jobs:
       - script: cmake . -DSTATIC_DEPS=$(STATIC_DEPS) -G Ninja -DCMAKE_BUILD_TYPE=${{ parameters.config }}
         displayName: CMake
       - ${{ if eq(parameters.staticDeps, 'true') }}:
-        - script: ninja download_static_deps || ninja download_static_deps || ninja download_static_deps
+        - script: ninja download_deps || ninja download_deps || ninja download_deps
           displayName: Download static deps
       - script: ninja
         displayName: Build
@@ -39,7 +40,11 @@ jobs:
         displayName: Test
       - script: ninja package
         displayName: Package
+      - bash: |
+          set -ex
+          [ "`./bin/neko -version`" == "$(NEKO_VERSION)" ]
+        displayName: Check version
       - task: PublishPipelineArtifact@0
         inputs:
           artifactName: ${{ parameters.name }}Binaries
-          targetPath: bin/neko-2.3.0-osx64.tar.gz
\ No newline at end of file
+          targetPath: bin/neko-$(NEKO_VERSION)-osx64.tar.gz
diff --git a/extra/azure-pipelines/build-windows.yml b/extra/azure-pipelines/build-windows.yml
index e807a67..6b2ebab 100644
--- a/extra/azure-pipelines/build-windows.yml
+++ b/extra/azure-pipelines/build-windows.yml
@@ -2,6 +2,7 @@ parameters:
   name: 'BuildWindows'
   vmImage: ''
   cmakeGenerator: ''
+  arch: ''
   config: 'RelWithDebInfo'
 
 jobs:
@@ -9,21 +10,23 @@ jobs:
     pool:
       vmImage: ${{ parameters.vmImage }}
     steps:
-      - ${{ if eq(parameters.vmImage, 'vs2015-win2012r2') }}:
+      - ${{ if startsWith(parameters.name, 'WinVS2017') }}:
         - powershell: |
-            Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
-            Write-Host "##vso[task.prependpath]C:\ProgramData\chocolatey\bin"
-          displayName: Install Chocolatey
-      - powershell: |
-          choco install activeperl -y
-          Write-Host "##vso[task.prependpath]C:\Perl64\bin"
-        displayName: Install Perl
-      - script: cmake . -G "${{ parameters.cmakeGenerator }}"
-        displayName: CMake
+            choco install visualstudio2017buildtools visualstudio2017-workload-vctools
+            # Install: Windows 8.1 SDK
+            Invoke-WebRequest -Method Get -Uri https://go.microsoft.com/fwlink/p/?LinkId=323507 -OutFile sdksetup.exe -UseBasicParsing
+            Start-Process -Wait sdksetup.exe -ArgumentList "/q", "/norestart", "/features", "OptionId.WindowsDesktopSoftwareDevelopmentKit", "OptionId.NetFxSoftwareDevelopmentKit"
+          displayName: Install VS2017 tools
+      - ${{ if startsWith(parameters.name, 'WinVS2017') }}:
+        - script: cmake . -G "${{ parameters.cmakeGenerator }}"
+          displayName: CMake
+      - ${{ if startsWith(parameters.name, 'WinVS2019') }}:
+        - script: cmake . -G "${{ parameters.cmakeGenerator }}" -A ${{ parameters.arch }}
+          displayName: CMake
       - script: |
-          cmake --build . --config ${{ parameters.config }} --target download_static_deps || \
-          cmake --build . --config ${{ parameters.config }} --target download_static_deps || \
-          cmake --build . --config ${{ parameters.config }} --target download_static_deps
+          cmake --build . --config ${{ parameters.config }} --target download_deps || \
+          cmake --build . --config ${{ parameters.config }} --target download_deps || \
+          cmake --build . --config ${{ parameters.config }} --target download_deps
         displayName: Download static deps
       - script: cmake --build . --config ${{ parameters.config }}
         displayName: Build
@@ -31,20 +34,14 @@ jobs:
         displayName: Test
       - script: cmake --build . --config ${{ parameters.config }} --target PACKAGE
         displayName: Package binaries
-      - task: PublishPipelineArtifact@0
-        inputs:
-          artifactName: ${{ parameters.name }}Binaries
-          ${{ if not(contains(parameters.cmakeGenerator, 'Win64')) }}:
-            targetPath: bin/neko-2.3.0-win.zip
-          ${{ if contains(parameters.cmakeGenerator, 'Win64') }}:
-            targetPath: bin/neko-2.3.0-win64.zip
       - bash: |
           set -ex
-          cmake --build . --config ${{ parameters.config }} --target package_choco
-          mkdir -p bin/choco
-          mv bin/*.nupkg bin/choco/
-        displayName: Package Chocolatey
+          [ "`./bin/neko -version`" == "$(NEKO_VERSION)" ]
+        displayName: Check version
       - task: PublishPipelineArtifact@0
         inputs:
-          artifactName: ${{ parameters.name }}Choco
-          targetPath: bin/choco
\ No newline at end of file
+          artifactName: ${{ parameters.name }}Binaries
+          ${{ if eq(parameters.arch, 'Win32') }}:
+            targetPath: bin/neko-$(NEKO_VERSION)-win.zip
+          ${{ if eq(parameters.arch, 'x64') }}:
+            targetPath: bin/neko-$(NEKO_VERSION)-win64.zip
diff --git a/extra/chocolatey/VERIFICATION.txt b/extra/chocolatey/VERIFICATION.txt
new file mode 100644
index 0000000..140b6dc
--- /dev/null
+++ b/extra/chocolatey/VERIFICATION.txt
@@ -0,0 +1,3 @@
+Packager (Andy Li) is a member of the Haxe Foundation.
+ 
+The files included in this package are the "Windows Binaries" available at https://github.com/HaxeFoundation/neko/releases.
\ No newline at end of file
diff --git a/extra/chocolatey/chocolateyInstall.ps1.template b/extra/chocolatey/chocolateyInstall.ps1.template
new file mode 100644
index 0000000..8605154
--- /dev/null
+++ b/extra/chocolatey/chocolateyInstall.ps1.template
@@ -0,0 +1,24 @@
+$packDir = "$(Split-Path -parent $MyInvocation.MyCommand.Definition)"
+
+Install-ChocolateyZipPackage `
+    -PackageName 'neko' `
+    -UnzipLocation "$packDir" `
+    -Url "$packDir\neko-*-win.zip" `
+    -Checksum '::CHECKSUM32::' `
+    -ChecksumType 'sha256' `
+    -Url64bit "$packDir\neko-*-win64.zip" `
+    -Checksum64 '::CHECKSUM64::' `
+    -ChecksumType64 'sha256'
+
+$nekoDir = "$(Get-Item "$packDir/neko-*-win*" -Exclude "*.zip")"
+
+# Install the dll files to C:\ProgramData\chocolatey\bin
+# It is because they are loaded by other neko binaries, e.g. haxelib.exe
+$chocoBin = Join-Path $env:ChocolateyInstall 'bin'
+$dllFiles = @('gcmt-dll.dll', 'neko.dll')
+foreach ($file in $dllFiles) {
+    Copy-Item "$nekoDir/$file" "$chocoBin"
+}
+
+# Set NEKOPATH such that the ndll files can be loaded.
+Install-ChocolateyEnvironmentVariable -VariableName NEKOPATH -VariableValue $nekoDir
diff --git a/extra/chocolateyUninstall.ps1 b/extra/chocolatey/chocolateyUninstall.ps1
similarity index 59%
rename from extra/chocolateyUninstall.ps1
rename to extra/chocolatey/chocolateyUninstall.ps1
index 2719c84..b6ff631 100644
--- a/extra/chocolateyUninstall.ps1
+++ b/extra/chocolatey/chocolateyUninstall.ps1
@@ -1,11 +1,9 @@
-$scriptPath = (Split-Path -parent $MyInvocation.MyCommand.Definition)
-
 # Remove the dll files from C:\ProgramData\chocolatey\bin
 $chocoBin = Join-Path $env:ChocolateyInstall 'bin'
 $dllFiles = @('gcmt-dll.dll', 'neko.dll')
 foreach ($file in $dllFiles) {
     $dllFile = Join-Path $chocoBin $file
-    del "$dllFile"
+    Remove-Item "$dllFile"
 }
 
-Uninstall-ChocolateyEnvironmentVariable -VariableName NEKOPATH
\ No newline at end of file
+Uninstall-ChocolateyEnvironmentVariable -VariableName NEKOPATH
diff --git a/extra/chocolatey/generatePackage.ps1 b/extra/chocolatey/generatePackage.ps1
new file mode 100644
index 0000000..dab8a6e
--- /dev/null
+++ b/extra/chocolatey/generatePackage.ps1
@@ -0,0 +1,58 @@
+param ([string] $version)
+$ErrorActionPreference = "Stop"
+
+$SOURCE = ".\extra\chocolatey"
+$OUTPUT = "$SOURCE\out"
+
+If ( $version -eq "" ) {
+	Write-Error "No version parameter was passed in."
+	Exit 1
+}
+
+# Create empty
+If ( Test-Path -Path $OUTPUT) {
+	Get-ChildItem -Path $OUTPUT -File | foreach { $_.Delete()}
+} Else {
+	New-Item -Path $OUTPUT -ItemType "directory" -Force > $null
+}
+
+Function Copy-File {
+	param ([string] $file)
+	Write-Host "Copying $file"
+	Copy-Item $file $OUTPUT
+}
+
+# Copy over zipped up binaries
+
+$file32 = "neko-$version-win.zip"
+$file64 = "neko-$version-win64.zip"
+
+ForEach ($file in @(".\WinVS2017Binaries\$file32", ".\WinVS2017x64Binaries\$file64")) {
+	If ( ! (Test-Path -Path $file -PathType Leaf) ) {
+		Write-Error "File $file missing"
+		Exit 2
+	}
+	Copy-File $file
+}
+
+# Generate install script
+Write-Host "Generating install script"
+
+# Load template
+$template = (Get-Content -Path "$source\chocolateyInstall.ps1.template" -Raw)
+
+# Get checksums
+$checksum32 = (Get-FileHash $OUTPUT\$file32).Hash.ToLower()
+$checksum64 = (Get-FileHash $OUTPUT\$file64).Hash.ToLower()
+
+# Generate install script with correct checksums
+$installScript = $template -Replace '::CHECKSUM32::',$checksum32 -Replace '::CHECKSUM64::',$checksum64
+
+Out-File -FilePath "$OUTPUT\chocolateyInstall.ps1" -InputObject $installScript -NoNewline
+
+# Copy over general files
+$toCopy = @(".\LICENSE", "$SOURCE\VERIFICATION.txt", "$SOURCE\neko.nuspec","$SOURCE\chocolateyUninstall.ps1")
+
+ForEach ($item in $toCopy) {
+	Copy-File $item
+}
diff --git a/extra/neko.nuspec b/extra/chocolatey/neko.nuspec
similarity index 84%
rename from extra/neko.nuspec
rename to extra/chocolatey/neko.nuspec
index bdb42c6..a5b3086 100644
--- a/extra/neko.nuspec
+++ b/extra/chocolatey/neko.nuspec
@@ -2,17 +2,17 @@
 <package xmlns="http://schemas.microsoft.com/packaging/2010/07/nuspec.xsd">
     <metadata>
         <id>neko</id>
-        <version>@SNAPSHOT_VERSION@</version>
+        <version>0.0.0</version>
         <title>Neko</title>
         <authors>Haxe Foundation</authors>
         <owners>Haxe Foundation</owners>
         <licenseUrl>https://github.com/HaxeFoundation/neko/blob/master/LICENSE</licenseUrl>
-        <projectUrl>http://nekovm.org/</projectUrl>
-        <docsUrl>http://nekovm.org/doc</docsUrl>
+        <projectUrl>https://nekovm.org/</projectUrl>
+        <docsUrl>https://nekovm.org/doc/begin/</docsUrl>
         <mailingListUrl>https://groups.google.com/forum/#!forum/haxelang</mailingListUrl>
         <bugTrackerUrl>https://github.com/HaxeFoundation/neko/issues</bugTrackerUrl>
         <projectSourceUrl>https://github.com/HaxeFoundation/neko</projectSourceUrl>
-        <packageSourceUrl>https://github.com/HaxeFoundation/neko/tree/master/extra</packageSourceUrl>
+        <packageSourceUrl>https://github.com/HaxeFoundation/neko/tree/master/extra/chocolatey</packageSourceUrl>
         <iconUrl>https://cdn.rawgit.com/andyli/cc07575f598351e0ad74/raw/6a9cae9a136670c0052356b773f8e13bf37c13dd/logo.png</iconUrl>
         <requireLicenseAcceptance>false</requireLicenseAcceptance>
         <summary>Neko is a lightweight and yet well optimized virtual machine.</summary>
@@ -20,7 +20,7 @@
         <releaseNotes>https://github.com/HaxeFoundation/neko/blob/master/CHANGES</releaseNotes>
         <tags>neko haxe vm admin</tags>
         <dependencies>
-            <dependency id="vcredist2013" version="12.0.30501" />
+            <dependency id="vcredist2017" version="14.16.27033" />
         </dependencies>
     </metadata>
 </package>
diff --git a/extra/chocolateyInstall.ps1 b/extra/chocolateyInstall.ps1
deleted file mode 100644
index 2bf7586..0000000
--- a/extra/chocolateyInstall.ps1
+++ /dev/null
@@ -1,13 +0,0 @@
-$scriptPath = (Split-Path -parent $MyInvocation.MyCommand.Definition)
-
-# Install the dll files to C:\ProgramData\chocolatey\bin
-# It is because they are loaded by other neko binaries, e.g. haxelib.exe
-$chocoBin = Join-Path $env:ChocolateyInstall 'bin'
-$dllFiles = @('gcmt-dll.dll', 'neko.dll')
-foreach ($file in $dllFiles) {
-    $dllFile = Join-Path $scriptPath $file
-    copy "$dllFile" "$chocoBin"
-}
-
-# Set NEKOPATH such that the ndll files can be loaded.
-Install-ChocolateyEnvironmentVariable -VariableName NEKOPATH -VariableValue $scriptPath
\ No newline at end of file
diff --git a/libs/CMakeLists.txt b/libs/CMakeLists.txt
index 6d0c351..9451792 100644
--- a/libs/CMakeLists.txt
+++ b/libs/CMakeLists.txt
@@ -41,13 +41,14 @@ if (WITH_APACHE)
 			set(APRUTIL_CONF "")
 			set(APRUTIL_DEP "")
 		endif()
-		if (STATIC_PCRE)
+		# APACHE still uses old pcre currently
+		# if (STATIC_PCRE2)
 			set(PCRE_CONF --with-pcre=${CMAKE_BINARY_DIR}/libs/src/install-prefix)
 			set(PCRE_DEP PCRE)
-		elseif()
-			set(PCRE_CONF "")
-			set(PCRE_DEP "")
-		endif()
+		# elseif()
+		# 	set(PCRE_CONF "")
+		# 	set(PCRE_DEP "")
+		# endif()
 		if (STATIC_ZLIB)
 			set(ZLIB_CONF --with-z=${CMAKE_BINARY_DIR}/libs/src/install-prefix)
 			set(ZLIB_DEP Zlib)
@@ -83,15 +84,89 @@ if (WITH_APACHE)
 					make install
 			)
 		endif()
+
+		# Apache still uses old PCRE. Remove this once they migrate
+		## Start of PCRE download info
+		set(PCRE_URL_DATA
+			URL "https://downloads.sourceforge.net/project/pcre/pcre/8.45/pcre-8.45.tar.gz"
+			URL_HASH SHA1=a19402ce56d770da1557cf331b109d33adb74062
+		)
+		if (WIN32)
+			ExternalProject_Add(PCRE
+				${EP_CONFIGS}
+				${PCRE_URL_DATA}
+				CMAKE_ARGS
+					-G ${CMAKE_GENERATOR}
+					-DCMAKE_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/libs/src/install-prefix
+					-Wno-dev
+					-DPCRE_BUILD_PCRECPP=OFF
+					-DPCRE_BUILD_PCREGREP=OFF
+					-DPCRE_BUILD_TESTS=OFF
+					-DPCRE_SUPPORT_JIT=ON
+					-DPCRE_SUPPORT_UNICODE_PROPERTIES=ON
+			)
+			set(PCRE_LIBRARIES
+				optimized ${CMAKE_BINARY_DIR}/libs/src/install-prefix/lib/pcre.lib
+				debug ${CMAKE_BINARY_DIR}/libs/src/install-prefix/lib/pcred.lib
+			)
+		else()
+			if (APPLE)
+				set(PCRE_CFLAGS "-w -mmacosx-version-min=${CMAKE_OSX_DEPLOYMENT_TARGET}")
+			else()
+				set(PCRE_CFLAGS "-w")
+			endif()
+			set(PCRE_LIBRARIES
+				${CMAKE_BINARY_DIR}/libs/src/install-prefix/lib/libpcre.a
+			)
+			ExternalProject_Add(PCRE
+				${EP_CONFIGS}
+				${PCRE_URL_DATA}
+				CONFIGURE_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/PCRE &&
+					autoreconf -f -i &&
+					./configure
+						--prefix=${CMAKE_BINARY_DIR}/libs/src/install-prefix
+						--with-pic
+						--enable-unicode-properties
+						--enable-silent-rules
+						--enable-jit
+						--disable-cpp
+						--enable-shared=no
+						--enable-static=yes
+						--silent
+				BUILD_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/PCRE &&
+					make "CFLAGS=${PCRE_CFLAGS}"
+				INSTALL_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/PCRE &&
+					make install
+				BYPRODUCTS ${PCRE_LIBRARIES}
+			)
+		endif()
+
+		set_target_properties(PCRE PROPERTIES ${EP_PROPS})
+		# don't want to add PCRE 1 to external_deps,
+		# but want download_deps to depend on it
+		add_dependencies(download_deps PCRE-download)
+
+		## End of PCRE download info
+
+		if (APPLE) # We need to use the most up to date version on MacOS
+			set(APR_SOURCE
+				SVN_REPOSITORY https://svn.apache.org/repos/asf/apr/apr/trunk/
+				CONFIGURE_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/APR &&
+					./buildconf
+			)
+		else()
+			set(APR_SOURCE
+				URL https://archive.apache.org/dist/apr/apr-1.5.2.tar.gz
+				URL_MD5 98492e965963f852ab29f9e61b2ad700
+			)
+		endif()
 		ExternalProject_Add(APR
 			${EP_CONFIGS}
-			URL http://archive.apache.org/dist/apr/apr-1.5.2.tar.gz
-			URL_MD5 98492e965963f852ab29f9e61b2ad700
+			${APR_SOURCE}
 			${APR_CONFIGS}
 		)
 		set_target_properties(APR PROPERTIES ${EP_PROPS})
 
-
 		if(WIN32)
 			set(APRutil_CONFIGS
 				CMAKE_ARGS
@@ -100,7 +175,7 @@ if (WITH_APACHE)
 					-DOPENSSL_ROOT_DIR=${CMAKE_BINARY_DIR}/libs/src/install-prefix
 					-DINSTALL_PDB=OFF
 			)
-		else()
+		elseif(NOT APPLE)
 			set(APRutil_CONFIGS
 				CONFIGURE_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/APRutil &&
 					./configure
@@ -114,15 +189,18 @@ if (WITH_APACHE)
 					make install
 			)
 		endif()
-		ExternalProject_Add(APRutil
-			${EP_CONFIGS}
-			DEPENDS ${APR_DEP} ${OPENSSL_DEP}
-			URL http://archive.apache.org/dist/apr/apr-util-1.5.4.tar.gz
-			URL_MD5 866825c04da827c6e5f53daff5569f42
-			${APRutil_CONFIGS}
-		)
-		set_target_properties(APRutil PROPERTIES ${EP_PROPS})
 
+		# For apple we use APR 2.0, which contains apr-util
+		if (NOT APPLE)
+			ExternalProject_Add(APRutil
+				${EP_CONFIGS}
+				DEPENDS ${APR_DEP} ${OPENSSL_DEP}
+				URL https://archive.apache.org/dist/apr/apr-util-1.5.4.tar.gz
+				URL_MD5 866825c04da827c6e5f53daff5569f42
+				${APRutil_CONFIGS}
+			)
+			set_target_properties(APRutil PROPERTIES ${EP_PROPS})
+		endif()
 
 		if(WIN32)
 			set(Apache_CONFIGS
@@ -147,40 +225,59 @@ if (WITH_APACHE)
 				${CMAKE_BINARY_DIR}/libs/src/Apache-build/${CMAKE_CFG_INTDIR}/libhttpd.lib
 			)
 		else()
+			set(APACHE_CONFIG_SETTINGS
+					${APR_CONF}
+					${OPENSSL_CONF}
+					${PCRE_CONF}
+					${ZLIB_CONF}
+			)
+			if (NOT APPLE)
+				list(APPEND APACHE_CONFIG_SETTINGS ${APRUTIL_CONF})
+			endif()
 			set(Apache_CONFIGS
 				CONFIGURE_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/Apache &&
 					./configure
 						--prefix=${CMAKE_BINARY_DIR}/libs/src/Apache-build
 						--silent
-						${APR_CONF}
-						${APRUTIL_CONF}
-						${OPENSSL_CONF}
-						${PCRE_CONF}
-						${ZLIB_CONF}
+						${APACHE_CONFIG_SETTINGS}
 				BUILD_COMMAND echo skip build
 				INSTALL_COMMAND echo skip install
 			)
 			set(APACHE_INCLUDE_DIRS
-				${CMAKE_BINARY_DIR}/libs/src/install-prefix/include/apr-1
 				${CMAKE_BINARY_DIR}/libs/src/Apache/include
 				${CMAKE_BINARY_DIR}/libs/src/Apache/os/unix
 			)
+			if (APPLE)
+				list(APPEND APACHE_INCLUDE_DIRS ${CMAKE_BINARY_DIR}/libs/src/install-prefix/include/apr-2)
+			else()
+				list(APPEND APACHE_INCLUDE_DIRS ${CMAKE_BINARY_DIR}/libs/src/install-prefix/include/apr-1)
+			endif()
 			set(APACHE_LIBRARIES
 
 			)
 		endif()
+		set(APACHE_DEPENDENCIES
+			${APR_DEP} ${OPENSSL_DEP} ${PCRE_DEP}
+		)
+		if (NOT APPLE)
+			list(APPEND APACHE_DEPENDENCIES ${APRUTIL_DEP})
+		endif()
 		ExternalProject_Add(Apache
 			${EP_CONFIGS}
-			DEPENDS ${APR_DEP} ${APRUTIL_DEP} ${OPENSSL_DEP} ${PCRE_DEP}
-			URL http://archive.apache.org/dist/httpd/httpd-2.4.29.tar.gz
+			DEPENDS ${APACHE_DEPENDENCIES}
+			URL
+				https://archive.apache.org/dist/httpd/httpd-2.4.29.tar.gz
+				https://github.com/HaxeFoundation/neko/files/9692684/httpd-2.4.29.tar.gz
 			URL_MD5 6380b0856658f07479fdcba9e20294a6
 			${Apache_CONFIGS}
 		)
 		set_target_properties(Apache PROPERTIES ${EP_PROPS})
 		# Download sources for fat source archive
-		add_dependencies(download_static_deps Apache-download)
-		add_dependencies(download_static_deps APR-download)
-		add_dependencies(download_static_deps APRutil-download)
+		add_dependencies(download_deps Apache-download)
+		add_dependencies(download_deps APR-download)
+		if (NOT APPLE)
+			add_dependencies(download_deps APRutil-download)
+		endif()
 	else()
 		find_package(APACHE REQUIRED)
 		find_package(APR REQUIRED)
@@ -191,6 +288,6 @@ if (WITH_APACHE)
 		set(APACHE_INCLUDE_DIRS ${APACHE_INCLUDE_DIR} ${APR_INCLUDE_DIR} ${APRUTIL_INCLUDE_DIR})
 	endif()
 
-  add_subdirectory(mod_neko)
-  add_subdirectory(mod_tora)
+	add_subdirectory(mod_neko)
+	add_subdirectory(mod_tora)
 endif()
diff --git a/libs/common/osdef.h.in b/libs/common/osdef.h.in
index b0ab0bf..8713828 100644
--- a/libs/common/osdef.h.in
+++ b/libs/common/osdef.h.in
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/common/sha1.c b/libs/common/sha1.c
index cdfc40e..57b3602 100644
--- a/libs/common/sha1.c
+++ b/libs/common/sha1.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/common/sha1.h b/libs/common/sha1.h
index e15a1c5..966cfaa 100644
--- a/libs/common/sha1.h
+++ b/libs/common/sha1.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/common/socket.c b/libs/common/socket.c
index 979b084..2c80549 100644
--- a/libs/common/socket.c
+++ b/libs/common/socket.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -47,7 +47,7 @@
 #	define HANDLE_EINTR(x)	if( errno == EINTR ) goto x
 #endif
 
-#if defined(OS_WINDOWS) || defined(OS_MAC)
+#ifndef MSG_NOSIGNAL
 #	define MSG_NOSIGNAL 0
 #endif
 
diff --git a/libs/common/socket.h b/libs/common/socket.h
index e73c8d7..82d1200 100644
--- a/libs/common/socket.h
+++ b/libs/common/socket.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/mod_neko/CMakeLists.txt b/libs/mod_neko/CMakeLists.txt
index bef558a..e053b0b 100644
--- a/libs/mod_neko/CMakeLists.txt
+++ b/libs/mod_neko/CMakeLists.txt
@@ -17,7 +17,10 @@ target_link_libraries(mod_neko2.ndll libneko ${APACHE_LIBRARIES})
 
 # In static Apache case build dependencies first
 if (STATIC_APACHE)
-	add_dependencies(mod_neko2.ndll Apache APR APRutil)
+	add_dependencies(mod_neko2.ndll Apache APR)
+	if (NOT APPLE)
+		add_dependencies(mod_neko2.ndll APRutil)
+	endif()
 endif()
 
 set_target_properties(mod_neko2.ndll
diff --git a/libs/mod_neko/cgi.c b/libs/mod_neko/cgi.c
index 017b8a2..caace4f 100644
--- a/libs/mod_neko/cgi.c
+++ b/libs/mod_neko/cgi.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -29,6 +29,11 @@ DEFINE_KIND(k_mod_neko);
 #	define strcmpi	strcasecmp
 #endif
 
+// recent versions of APR include "stdbool.h" somewhere which causes conflicts.
+#ifdef bool
+#	undef bool
+#endif
+
 #ifdef APACHE_2_X
 #	define ap_table_get		apr_table_get
 #	define ap_table_set		apr_table_set
diff --git a/libs/mod_neko/mod_neko.c b/libs/mod_neko/mod_neko.c
index 05924b1..62ccb90 100644
--- a/libs/mod_neko/mod_neko.c
+++ b/libs/mod_neko/mod_neko.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/mod_neko/mod_neko.h b/libs/mod_neko/mod_neko.h
index 34f7d84..1267b87 100644
--- a/libs/mod_neko/mod_neko.h
+++ b/libs/mod_neko/mod_neko.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/mod_tora/CMakeLists.txt b/libs/mod_tora/CMakeLists.txt
index 8c92af6..31e008e 100644
--- a/libs/mod_tora/CMakeLists.txt
+++ b/libs/mod_tora/CMakeLists.txt
@@ -10,7 +10,7 @@ add_library(mod_tora2.ndll MODULE
 add_dependencies(mod_tora2.ndll
 	mod_neko2.ndll
 	socket
-	)
+)
 
 target_include_directories(mod_tora2.ndll
 	PRIVATE
@@ -20,7 +20,7 @@ target_include_directories(mod_tora2.ndll
 target_link_libraries(mod_tora2.ndll
 	socket
 	${APACHE_LIBRARIES}
-	)
+)
 
 if (WIN32)
 	target_link_libraries(mod_tora2.ndll ws2_32)
diff --git a/libs/mod_tora/mod_tora.c b/libs/mod_tora/mod_tora.c
index ec71c0f..d0ea6fc 100644
--- a/libs/mod_tora/mod_tora.c
+++ b/libs/mod_tora/mod_tora.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/mod_tora/protocol.c b/libs/mod_tora/protocol.c
index bec867b..6ff65ec 100644
--- a/libs/mod_tora/protocol.c
+++ b/libs/mod_tora/protocol.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/mod_tora/protocol.h b/libs/mod_tora/protocol.h
index 2c6f254..d69f755 100644
--- a/libs/mod_tora/protocol.h
+++ b/libs/mod_tora/protocol.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/mysql/CMakeLists.txt b/libs/mysql/CMakeLists.txt
index 9b10433..cda7d77 100644
--- a/libs/mysql/CMakeLists.txt
+++ b/libs/mysql/CMakeLists.txt
@@ -4,10 +4,12 @@
 
 if (STATIC_OPENSSL)
 	if (APPLE)
-		if (${CMAKE_OSX_ARCHITECTURES} STREQUAL "i386")
-			set(OPENSSL_CONF ./Configure darwin-i386-cc "-mmacosx-version-min=${CMAKE_OSX_DEPLOYMENT_TARGET}")
-		elseif (${CMAKE_OSX_ARCHITECTURES} STREQUAL "x86_64")
+		if (${CMAKE_SYSTEM_PROCESSOR} STREQUAL "i386")
+			set(OPENSSL_CONF ./Configure $CMAKE_C_COMPILER "-mmacosx-version-min=${CMAKE_OSX_DEPLOYMENT_TARGET}")
+		elseif (${CMAKE_SYSTEM_PROCESSOR} STREQUAL "x86_64")
 			set(OPENSSL_CONF ./Configure darwin64-x86_64-cc "-mmacosx-version-min=${CMAKE_OSX_DEPLOYMENT_TARGET}")
+		elseif (${CMAKE_SYSTEM_PROCESSOR} STREQUAL "arm64")
+			set(OPENSSL_CONF ./Configure darwin64-arm64-cc "-mmacosx-version-min=${CMAKE_OSX_DEPLOYMENT_TARGET}")
 		endif()
 	else()
 		set(OPENSSL_CONF ./config)
@@ -42,8 +44,8 @@ if (STATIC_OPENSSL)
 	endif()
 	ExternalProject_Add(OpenSSL
 		${EP_CONFIGS}
-		URL https://www.openssl.org/source/openssl-1.1.1.tar.gz
-		URL_MD5 7079eb017429e0ffb9efb42bf80ccb21
+		URL https://www.openssl.org/source/old/1.1.1/openssl-1.1.1k.tar.gz
+		URL_HASH SHA256=892a0875b9872acd04a9fde79b1f943075d5ea162415de3047c327df33fbaee5
 		${OPENSSL_CONFS}
 		PATCH_COMMAND ${CMAKE_COMMAND} -Dopenssl_source=${CMAKE_BINARY_DIR}/libs/src/openssl -P ${CMAKE_SOURCE_DIR}/cmake/patch_openssl.cmake
 		SOURCE_DIR ${CMAKE_BINARY_DIR}/libs/src/openssl
@@ -57,7 +59,7 @@ if (STATIC_OPENSSL)
 		)
 	endif()
 	# Download project for fat source archive
-	add_dependencies(download_static_deps OpenSSL-download)
+	add_dependencies(download_deps OpenSSL-download)
 else()
 	find_package(OpenSSL)
 endif()
@@ -88,7 +90,7 @@ if (STATIC_MARIADBCONNECTOR)
 	ExternalProject_Add(MariaDBConnector
 		${EP_CONFIGS}
 		DEPENDS ${OPENSSL_DEP}
-		URL https://downloads.mariadb.org/f/connector-c-3.0.9/mariadb-connector-c-3.0.9-src.tar.gz
+		URL https://downloads.mariadb.com/Connectors/c/connector-c-3.0.9/mariadb-connector-c-3.0.9-src.tar.gz
 		URL_MD5 e7fdb17e26e779f4bd15b6a32e1c8472
 		CMAKE_ARGS
 			-Wno-dev
@@ -109,7 +111,7 @@ if (STATIC_MARIADBCONNECTOR)
 	)
 	add_dependencies(mysql.ndll MariaDBConnector)
 	# Download project for fat source archive
-	add_dependencies(download_static_deps MariaDBConnector-download)
+	add_dependencies(download_deps MariaDBConnector-download)
 else()
 	find_package(MariaDBConnector REQUIRED)
 endif()
@@ -157,7 +159,7 @@ target_link_libraries(mysql5.ndll
 	socket
 	sha1
 	libneko
-	)
+)
 
 if (WIN32)
 	target_link_libraries(mysql5.ndll ws2_32)
diff --git a/libs/mysql/my_proto/my_api.c b/libs/mysql/my_proto/my_api.c
index 7e83330..1d9e996 100644
--- a/libs/mysql/my_proto/my_api.c
+++ b/libs/mysql/my_proto/my_api.c
@@ -1,6 +1,6 @@
 /*
  * MYSQL 5.0 Protocol Implementation
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -141,7 +141,7 @@ MYSQL *mysql_real_connect( MYSQL *m, const char *host, const char *user, const c
 			myp_close(m);
 			save_error(m,p);
 			return NULL;
-		}	
+		}
 		m->infos.server_version = strdup(myp_read_string(p));
 		m->infos.thread_id = myp_read_int(p);
 		myp_read(p,scramble_buf,8);
@@ -345,7 +345,7 @@ static int do_store( MYSQL *m, MYSQL_RES *r ) {
 		// read row fields
 		{
 			MYSQL_ROW_DATA *current = r->rows + r->row_count++;
-			int prev = 0;			
+			int prev = 0;
 			current->raw = p->buf;
 			current->lengths = (unsigned long*)malloc(sizeof(unsigned long) * r->nfields);
 			current->datas = (char**)malloc(sizeof(char*) * r->nfields);
@@ -475,11 +475,11 @@ MYSQL_ROW mysql_fetch_row( MYSQL_RES * r ) {
 		// next
 		cur++;
 	}
-	if( cur >= r->rows + r->row_count ) {		
+	if( cur >= r->rows + r->row_count ) {
 		free(r->rows);
 		r->rows = NULL;
 		r->memory_rows = 0;
-		cur = NULL;	
+		cur = NULL;
 	}
 	r->current = cur;
 	return cur ? cur->datas : NULL;
diff --git a/libs/mysql/my_proto/my_proto.c b/libs/mysql/my_proto/my_proto.c
index c0b8247..cfb212b 100644
--- a/libs/mysql/my_proto/my_proto.c
+++ b/libs/mysql/my_proto/my_proto.c
@@ -1,6 +1,6 @@
 /*
  * MYSQL 5.0 Protocol Implementation
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/mysql/my_proto/my_proto.h b/libs/mysql/my_proto/my_proto.h
index 71b0bcf..81fc5c1 100644
--- a/libs/mysql/my_proto/my_proto.h
+++ b/libs/mysql/my_proto/my_proto.h
@@ -1,6 +1,6 @@
 /*
  * MYSQL 5.0 Protocol Implementation
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/mysql/my_proto/mysql.h b/libs/mysql/my_proto/mysql.h
index 68492d7..7ca3281 100644
--- a/libs/mysql/my_proto/mysql.h
+++ b/libs/mysql/my_proto/mysql.h
@@ -1,6 +1,6 @@
 /*
  * MYSQL 5.0 Protocol Implementation
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -25,7 +25,7 @@
 
 struct _MYSQL;
 struct _MYSQL_RES;
-typedef struct _MYSQL MYSQL; 
+typedef struct _MYSQL MYSQL;
 typedef struct _MYSQL_RES MYSQL_RES;
 typedef char **MYSQL_ROW;
 
diff --git a/libs/mysql/mysql.c b/libs/mysql/mysql.c
index 1fec59c..e7f1b94 100644
--- a/libs/mysql/mysql.c
+++ b/libs/mysql/mysql.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -352,7 +352,7 @@ static value alloc_result( connection *c, MYSQL_RES *r ) {
 	res->current = NULL;
 	res->nfields = num_fields;
 	res->fields_ids = (field*)alloc_private(sizeof(field)*num_fields);
-	res->fields_convs = (CONV*)alloc_private(sizeof(CONV)*num_fields);	
+	res->fields_convs = (CONV*)alloc_private(sizeof(CONV)*num_fields);
 	for(i=0;i<num_fields;i++) {
 		field id;
 		if( strchr(fields[i].name,'(') )
@@ -496,7 +496,7 @@ static value connect_mysql( value params  ) {
 	if( !val_is_string(socket) && !val_is_null(socket) )
 		neko_error();
 	{
-		connection *c = (connection*)alloc(sizeof(connection));		
+		connection *c = (connection*)alloc(sizeof(connection));
 		value v;
 		c->m = mysql_init(NULL);
 		c->conv_string = NULL;
diff --git a/libs/ocaml/binast.ml b/libs/ocaml/binast.ml
index c6ce233..53ca333 100644
--- a/libs/ocaml/binast.ml
+++ b/libs/ocaml/binast.ml
@@ -1,6 +1,6 @@
 (*
  *  Neko Binary AST for OCaml
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/libs/ocaml/ml/mlast.ml b/libs/ocaml/ml/mlast.ml
index 3ce5867..485a391 100644
--- a/libs/ocaml/ml/mlast.ml
+++ b/libs/ocaml/ml/mlast.ml
@@ -1,6 +1,6 @@
 (*
  *  NekoML Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -108,8 +108,8 @@ and expr_decl =
 	| EBlock of expr list
 	| EField of expr * string
 	| ECall of expr * expr list
-	| EArray of expr * expr	
-	| EVar of (string * type_path option) list * expr 
+	| EArray of expr * expr
+	| EVar of (string * type_path option) list * expr
 	| EIf of expr * expr * expr option
 	| EFunction of bool * string option * arg list * expr * type_path option
 	| EBinop of string * expr * expr
@@ -164,9 +164,9 @@ let rec s_constant = function
 	| String s -> "\"" ^ escape s ^ "\""
 	| Ident s -> s
 	| Constr s -> s
-	| Module (l,c) -> String.concat "." l ^ "." ^ s_constant c 
+	| Module (l,c) -> String.concat "." l ^ "." ^ s_constant c
 
-let s_path path n = 
+let s_path path n =
 	match path with
 	| [] -> n
 	| _ -> String.concat "." path ^ "." ^ n
diff --git a/libs/ocaml/ml/mllexer.mll b/libs/ocaml/ml/mllexer.mll
index 4e969af..e2f7926 100644
--- a/libs/ocaml/ml/mllexer.mll
+++ b/libs/ocaml/ml/mllexer.mll
@@ -1,6 +1,6 @@
 (*
  *  NekoML Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -42,7 +42,7 @@ let all_lines = Hashtbl.create 0
 let lines = ref []
 let buf = Buffer.create 100
 
-let error e pos = 
+let error e pos =
 	raise (Error (e,{ pmin = pos; pmax = pos; pfile = !cur_file }))
 
 let keywords =
@@ -65,7 +65,7 @@ let save() =
 let restore file =
 	save_lines();
 	cur_file := file;
-	lines := Hashtbl.find all_lines file 
+	lines := Hashtbl.find all_lines file
 
 let newline lexbuf =
 	lines := (lexeme_end lexbuf) :: !lines
@@ -104,7 +104,7 @@ let add c = Buffer.add_string buf c
 let mk_tok t pmin pmax =
 	t , { pfile = !cur_file; pmin = pmin; pmax = pmax }
 
-let mk lexbuf t = 
+let mk lexbuf t =
 	mk_tok t (lexeme_start lexbuf) (lexeme_end lexbuf)
 
 let mk_ident lexbuf =
@@ -133,13 +133,13 @@ rule token = parse
 	| ']' { mk lexbuf BracketClose }
 	| '\'' { mk lexbuf Quote }
 	| '|' { mk lexbuf Vertical }
-	| space+ { token lexbuf } 
+	| space+ { token lexbuf }
 	| '\n' { newline lexbuf; token lexbuf }
-	| "0x" ['0'-'9' 'a'-'f' 'A'-'F']+	
+	| "0x" ['0'-'9' 'a'-'f' 'A'-'F']+
 	| number+ { mk lexbuf (Const (Int (int_of_string (lexeme lexbuf)))) }
 	| number+ '.' number*
 	| '.' number+ { mk lexbuf (Const (Float (lexeme lexbuf))) }
-	| "true" { mk lexbuf (Const (Bool true)) } 
+	| "true" { mk lexbuf (Const (Bool true)) }
 	| "false" { mk lexbuf (Const (Bool false)) }
 	| '"' {
 			reset();
@@ -160,12 +160,12 @@ rule token = parse
 	| "'\\\\'" { mk lexbuf (Const (Char '\\')) }
 	| "'\\\"'" | "'\\t'" { mk lexbuf (Const (Char '"')) }
 	| '\'' [^'\\'] '\'' { mk lexbuf (Const (Char (lexeme lexbuf).[1])) }
-	| "\'\\" ['0'-'9'] ['0'-'9'] ['0'-'9'] '\'' { 
+	| "\'\\" ['0'-'9'] ['0'-'9'] ['0'-'9'] '\'' {
 			let s = String.sub (lexeme lexbuf) 2 3 in
 			let n = int_of_string s in
 			let c = (try char_of_int n with _ -> error (Invalid_escaped_character n) (lexeme_start lexbuf)) in
 			mk lexbuf (Const (Char c))
-		}	
+		}
 	| "//" [^'\n']*  {
 			let s = lexeme lexbuf in
 			let n = (if s.[String.length s - 1] = '\r' then 3 else 2) in
@@ -176,7 +176,7 @@ rule token = parse
 	| "->" { mk lexbuf Arrow }
 	| binop binop? | ">>>" | "===" | "!==" | "or" | "and" | "xor" { mk lexbuf (Binop (lexeme lexbuf)) }
 	| ident { mk_ident lexbuf }
-	| modident { mk lexbuf (Const (Constr (lexeme lexbuf))) } 
+	| modident { mk lexbuf (Const (Constr (lexeme lexbuf))) }
 	| _ {
 			error (Invalid_character (lexeme_char lexbuf 0)) (lexeme_start lexbuf)
 		}
@@ -197,7 +197,7 @@ and string = parse
 	| "\\n" { add "\n"; string lexbuf }
 	| "\\t" { add "\t"; string lexbuf }
 	| "\\r" { add "\r"; string lexbuf }
-	| '\\' ['0'-'9'] ['0'-'9'] ['0'-'9'] { 
+	| '\\' ['0'-'9'] ['0'-'9'] ['0'-'9'] {
 			let i = int_of_string (String.sub (lexeme lexbuf) 1 3) in
 			if i >= 256 then error (Invalid_escaped_character i) (lexeme_start lexbuf);
 			add (String.make 1 (char_of_int i));
@@ -206,4 +206,3 @@ and string = parse
 	| '\\' { error Invalid_escape (lexeme_start lexbuf) }
 	| '"' { lexeme_end lexbuf }
 	| [^'"' '\\' '\n']+ { store lexbuf; string lexbuf }
- 
\ No newline at end of file
diff --git a/libs/ocaml/ml/mlmain.ml b/libs/ocaml/ml/mlmain.ml
index 87c7849..54b13c7 100644
--- a/libs/ocaml/ml/mlmain.ml
+++ b/libs/ocaml/ml/mlmain.ml
@@ -1,6 +1,6 @@
 (*
  *  NekoML Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -27,7 +27,7 @@ let nekoml file ch out =
 	ignore(Mltyper.load_module ctx modname Mlast.null_pos);
 	Hashtbl.iter (fun m (e,deps,idents) ->
 		let e = Mlneko.generate e deps idents m in
-		let file = String.concat "/" m ^ ".neko" in		
+		let file = String.concat "/" m ^ ".neko" in
 		let ch = (if m = modname then out else IO.output_channel (open_out file)) in
 		let ctx = Printer.create ch in
 		Printer.print ctx e;
diff --git a/libs/ocaml/ml/mlmatch.ml b/libs/ocaml/ml/mlmatch.ml
index 7386224..5fcf949 100644
--- a/libs/ocaml/ml/mlmatch.ml
+++ b/libs/ocaml/ml/mlmatch.ml
@@ -1,6 +1,6 @@
 (*
  *  NekoML Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -20,10 +20,10 @@
 (* -----
 	We're using the same algorithm and source code as described in
 	chapter 5.2.4 of "The Zinc experiment" by X. Leroy
-	( http://citeseer.ist.psu.edu/leroy90zinc.html )
+	( https://citeseer.ist.psu.edu/viewdoc/summary?doi=10.1.1.43.6772 )
 	also described in "The Implementation of Functional Programming Languages"
 	by Simon Peyton Jones, in the Chapter 5 by Philip Wadler
-	( http://research.microsoft.com/Users/simonpj/Papers/slpj-book-1987/ )
+	( https://www.microsoft.com/en-us/research/publication/the-implementation-of-functional-programming-languages/ )
 *)
 
 open Mlast
@@ -97,7 +97,7 @@ let total p1 p2 =
 	| _ , Partial -> Partial
 	| _ , _ -> Dubious
 
-let partial p1 p2 = 
+let partial p1 p2 =
 	match p1 , p2 with
 	| Total , _ -> p2
 	| _ , Total -> Total
@@ -178,7 +178,7 @@ let split_matching (m:matching) =
 		in
 		split_rec casel
 
-let divide_matching (m:matching) = 
+let divide_matching (m:matching) =
 	match m with
 	| _ , [] ->
 		assert false
@@ -195,7 +195,7 @@ let divide_matching (m:matching) =
 			| ((PConst c,_) :: l, act) :: rest ->
 				let constant , constrs, others = divide_rec rest in
 				add_to_division (make_constant_match pathl) constant (t_const c) (l, act), constrs , others
-			| ((PConstr (path,c,arg),_) :: l,act) :: rest ->				
+			| ((PConstr (path,c,arg),_) :: l,act) :: rest ->
 				let constants , constrs, others = divide_rec rest in
 				let args = flatten arg in
 				constants , add_to_division (make_construct_match false (List.length args) pathl) constrs (TModule (path,TConstr c)) (args @ l,act) , others
@@ -244,7 +244,7 @@ and conquer_matching (m:matching) =
 			handle action a , p , r
 		else
 			action , Total, rest
-	| _ , [] -> 
+	| _ , [] ->
 		assert false
 	| (p :: _,_) :: _ , _ :: _ when start_by_a_variable p ->
 		let vars , rest = split_matching m in
@@ -273,8 +273,8 @@ and conquer_matching (m:matching) =
 			assert false
 
 let make (cases : (pattern list * texpr option * texpr) list) p =
-	let cases = List.concat (List.map (fun (pl,wcond,e) ->		
-		let e = exec e in 
+	let cases = List.concat (List.map (fun (pl,wcond,e) ->
+		let e = exec e in
 		let e = (match wcond with None -> e | Some e2 -> ewhen e2 e) in
 		List.map (fun p -> [p] , e) pl
 	) cases) in
diff --git a/libs/ocaml/ml/mlneko.ml b/libs/ocaml/ml/mlneko.ml
index 03e150a..ff842a1 100644
--- a/libs/ocaml/ml/mlneko.ml
+++ b/libs/ocaml/ml/mlneko.ml
@@ -1,6 +1,6 @@
 (*
  *  NekoML Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,13 +16,13 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
  *)
- 
+
 open Ast
 open Mltype
 
 type comparison =
 	| Native
-	| Structural	
+	| Structural
 
 type context = {
 	module_name : string;
@@ -60,7 +60,7 @@ let null =
 let core s p =
 	EField ((EConst (Ident (module_name ["Core"])),p),s) , p
 
-let pos (p : Mlast.pos) = 
+let pos (p : Mlast.pos) =
 	{
 		pmin = p.Mlast.pmin;
 		pmax = p.Mlast.pmax;
@@ -80,7 +80,7 @@ let rec call ret f args p =
 	| EConst (Builtin _) , _ -> ECall (f,args) , p
 	| _ ->
 		match args with
-		| a :: b :: c :: d :: x :: l -> 
+		| a :: b :: c :: d :: x :: l ->
 			let app = ECall ((EConst (Builtin "apply"),p),[f;a;b;c;d]) , p in
 			call ret app (x :: l) p
 		| _ ->
@@ -94,7 +94,7 @@ let array args p =
 
 let block e =
 	match e with
-	| EBlock _ , _ -> e 
+	| EBlock _ , _ -> e
 	| _ -> EBlock [e] , snd e
 
 let rec arity t =
@@ -128,7 +128,7 @@ let rec gen_constant ctx c p =
 	| TConstr "::" | TModule (["Core"],TConstr "::") -> fst (core "@cons" p)
 	| TConstr s -> EConst (Ident s)
 	| TModule ([],c) -> fst (gen_constant ctx c p)
-	| TModule (m,c) ->		
+	| TModule (m,c) ->
 		EField ( (EConst (Ident (module_name m)),p) , (match c with TConstr x -> x | TIdent s -> s | _ -> assert false))
 	) , p
 
@@ -157,7 +157,7 @@ let rec gen_match_rec mctx fail m =
 			EBlock [] , p
 		else
 			call t_void (builtin "goto") [ident label] p
-	| MHandle (m1,m2) -> 
+	| MHandle (m1,m2) ->
 		let label = gen_label ctx in
 		let m1 = gen_rec label m1 in
 		let m2 = gen_rec fail m2 in
@@ -170,7 +170,7 @@ let rec gen_match_rec mctx fail m =
 			let reraise = EIf ( ematch , gen_rec fail MFailure, Some(ECall (builtin "throw", [ident "@exc"]) , p) ) , p in
 			mctx.first <- false;
 			match e.edecl with
-			| TConst _ -> gen_expr ctx e 
+			| TConst _ -> gen_expr ctx e
 			| _ -> ETry (gen_expr ctx e, "@exc" , reraise ) , p
 		end else begin
 			mctx.first <- true;
@@ -233,12 +233,12 @@ let rec gen_match_rec mctx fail m =
 		let fail = gen_rec fail MFailure in
 		EIf (e,m,Some fail) , p
 	| MToken (m,n) ->
-		call t_void (core "stream_token" p) [gen_rec fail m; int n] p		
+		call t_void (core "stream_token" p) [gen_rec fail m; int n] p
 	| MJunk (m,n,m2) ->
 		let m = gen_rec fail m in
 		mctx.first <- false;
 		EBlock [
-			call t_void (core "stream_junk" p) [m; int n] p;		
+			call t_void (core "stream_junk" p) [m; int n] p;
 			gen_rec fail m2
 		] , p
 
@@ -252,7 +252,7 @@ and gen_matching ctx v m p stream out =
 		next = no_label;
 	} in
 	let label = (if stream then gen_label ctx else no_label) in
-	Hashtbl.add mctx.h MRoot v;	
+	Hashtbl.add mctx.h MRoot v;
 	let e = gen_match_rec mctx label m in
 	if stream then begin
 		let vpos = gen_variable ctx in
@@ -264,7 +264,7 @@ and gen_matching ctx v m p stream out =
 		e
 
 and gen_match ctx e m stream p =
-	let out = gen_label ctx in 
+	let out = gen_label ctx in
 	let v = gen_variable ctx in
 	let m = gen_matching ctx v m p stream out in
 	let m = ENext ((EVars [v,Some e],p),m) , p in
@@ -287,7 +287,7 @@ and gen_constructor ctx tname c t p =
 	let export = EBinop ("=", (EField (ident ctx.module_name,c),p) , field) , p in
 	ENext (val_type t , export) , p
 
-and gen_type_printer ctx c t =	
+and gen_type_printer ctx c t =
 	let printer = mk (TConst (TModule (["Core"],TIdent "@print_union"))) t_void Mlast.null_pos in
 	let e = mk (TCall (printer,[
 		mk (TConst (TString c)) t_string Mlast.null_pos;
@@ -338,7 +338,7 @@ and gen_binop ctx op e1 e2 p =
 	| "and" -> make "&"
 	| "or" -> make "|"
 	| "xor" -> make "^"
-	| "==" | "!=" | ">" | "<" | ">=" | "<=" -> 
+	| "==" | "!=" | ">" | "<" | ">=" | "<=" ->
 		(match comparison e1.etype with
 		| Structural -> compare op
 		| Native -> make op)
@@ -351,7 +351,7 @@ and gen_binop ctx op e1 e2 p =
 			ECall (core "@aset" p,[gen_expr ctx a; gen_expr ctx i; gen_expr ctx e2]) , p
 		| _ ->
 			EBinop ("=",(EArray (gen_expr ctx e1,int 0),pos e1.epos),gen_expr ctx e2) , p)
-	| _ -> 
+	| _ ->
 		make op
 
 and gen_expr ctx e =
@@ -366,11 +366,11 @@ and gen_expr ctx e =
 		let ch = IO.input_string (String.concat "\"" (ExtString.String.nsplit s "'")) in
 		let file = "neko@" ^ p.pfile in
 		Parser.parse (Lexing.from_function (fun s p -> try IO.input ch s 0 p with IO.No_more_input -> 0)) file
-	| TCall (f,el) -> 
+	| TCall (f,el) ->
 		let f = gen_expr ctx f in
 		call e.etype f (List.map (gen_expr ctx) el) p
 	| TField (e,s) -> EField (gen_expr ctx e, s) , p
-	| TArray (e1,e2) -> 
+	| TArray (e1,e2) ->
 		let e1 = gen_expr ctx e1 in
 		ECall (core "@aget" p,[e1;gen_expr ctx e2]) , p
 	| TVar ([v],e) ->
@@ -383,7 +383,7 @@ and gen_expr ctx e =
 			incr n;
 			v , Some (EArray (ident "@tmp",int !n),p)
 		) vl) , p
-	| TIf (e,e1,e2) -> 
+	| TIf (e,e1,e2) ->
 		let e = gen_expr ctx e in
 		let e1 = gen_expr ctx e1 in
 		EIf (e, e1, match e2 with None -> None | Some e2 -> Some (gen_expr ctx e2)) , p
@@ -398,7 +398,7 @@ and gen_expr ctx e =
 	| TTupleDecl tl -> array (List.map (gen_expr ctx) tl) p
 	| TTypeDecl t -> gen_type ctx "<assert>" t p
 	| TMut e -> gen_expr ctx (!e)
-	| TRecordDecl fl -> 
+	| TRecordDecl fl ->
 		EObject (("__string", core "@print_record" p) :: List.map (fun (s,e) -> s , gen_expr ctx e) fl) , p
 	| TListDecl el ->
 		(match el with
@@ -406,7 +406,7 @@ and gen_expr ctx e =
 		| x :: l ->
 			let x = gen_expr ctx x in
 			array [x; gen_expr ctx { e with edecl = TListDecl l }] p)
-	| TUnop (op,e) -> 
+	| TUnop (op,e) ->
 		(match op with
 		| "-" -> EBinop ("-",int 0,gen_expr ctx e) , p
 		| "*" -> EArray (gen_expr ctx e,int 0) , p
@@ -468,7 +468,7 @@ and gen_block ctx el p =
 			ell := gen_expr ctx x :: !ell;
 			loop [] l
 	in
-	loop [] el;	
+	loop [] el;
 	ctx.refvars <- old;
 	List.rev !ell
 
@@ -481,7 +481,7 @@ let generate e deps idents m =
 	} in
 	if !verbose then print_endline ("Generating " ^ m ^ ".neko");
 	let init = EBinop ("=",ident m,builtin "exports"), null_pos in
-	let deps = List.map (fun m -> 
+	let deps = List.map (fun m ->
 		let file = String.concat "/" m in
 		let load = ECall ((EField (builtin "loader","loadmodule"),null_pos),[gen_constant ctx (TString file) null_pos;builtin "loader"]) , null_pos in
 		EBinop ("=", ident (module_name m), load ) , null_pos
@@ -490,6 +490,6 @@ let generate e deps idents m =
 		EBinop ("=", (EField (builtin "exports",i),null_pos) , ident i) , null_pos
 	) idents in
 	match gen_expr ctx e with
-	| EBlock e , p -> EBlock (init :: deps @ e @ exports) , p 
+	| EBlock e , p -> EBlock (init :: deps @ e @ exports) , p
 	| e -> EBlock (init :: deps @ e :: exports) , null_pos
 
diff --git a/libs/ocaml/ml/mlparser.ml b/libs/ocaml/ml/mlparser.ml
index 4953732..6fd9b35 100644
--- a/libs/ocaml/ml/mlparser.ml
+++ b/libs/ocaml/ml/mlparser.ml
@@ -1,6 +1,6 @@
 (*
  *  NekoML Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
  *)
- 
+
 open Mlast
 
 type error_msg =
@@ -65,7 +65,7 @@ let rec make_binop op e ((v,p2) as e2) =
 	| _ ->
 		EBinop (op,e,e2) , punion (pos e) (pos e2)
 
-let rec make_unop op ((v,p2) as e) p1 = 
+let rec make_unop op ((v,p2) as e) p1 =
 	match v with
 	| EBinop (bop,e,e2) -> EBinop (bop, make_unop op e p1 , e2) , (punion p1 p2)
 	| _ ->
@@ -81,7 +81,7 @@ let rec make_list_pat p = function
 let rec make_list p = function
 	| [] -> EConst (Constr "[]") , p
 	| x :: l ->
-		let p = snd x in		
+		let p = snd x in
 		ECall ((EConst (Constr "::") , p), [x;make_list p l]) , p
 
 let is_unop = function
@@ -95,7 +95,7 @@ let rec program = parser
 	| [< '(Semicolon,_); p = program >] -> p
 	| [< '(Eof,_) >] -> []
 
-and expr = parser	
+and expr = parser
 	| [< '(BraceOpen,p1); e = block1; s >] ->
 		(match s with parser
 		| [< '(BraceClose,p2); s >] -> e , punion p1 p2
@@ -169,14 +169,14 @@ and expr_next e = parser
 		e
 
 and expr_constr n p = parser
-	| [< '(Dot,_); e = expr_constr2 >] -> 
+	| [< '(Dot,_); e = expr_constr2 >] ->
 		(match e with
-		| EConst ((Ident _) as c) , p2 
+		| EConst ((Ident _) as c) , p2
 		| EConst ((Constr _) as c) , p2 -> EConst (Module ([n],c)) , punion p p2
 		| EConst (Module (l,c)) , p2 -> EConst (Module (n :: l,c)) , punion p p2
 		| _ -> assert false);
 	| [< >] -> EConst (Constr n), p
-		
+
 and expr_constr2 = parser
 	| [< '(Const (Ident n),p) >] -> EConst (Ident n) , p
 	| [< '(Const (Constr n),p); e = expr_constr n p >] -> e
@@ -280,12 +280,12 @@ and type_declaration p = parser
 and record_declaration mut = parser
 	| [< '(BraceClose,p) >] -> [] , p
 	| [< '(Const (Ident "mutable"),_); l = record_declaration true; >] -> l
-	| [< '(Semicolon,_); l = record_declaration false >] -> l 
+	| [< '(Semicolon,_); l = record_declaration false >] -> l
 	| [< '(Const (Ident name),_); '(Binop ":",_); t , _ = type_path; l , p = record_declaration false >] -> (name,mut,t) :: l , p
 
 and union_declaration = parser
 	| [< '(BraceClose,p) >] -> [] , p
-	| [< '(Semicolon,_); l = union_declaration >] -> l 
+	| [< '(Semicolon,_); l = union_declaration >] -> l
 	| [< '(Const (Constr name),_); t = type_opt; l , p = union_declaration >] -> (name,t) :: l , p
 
 and patterns_begin = parser
@@ -365,7 +365,7 @@ and pattern_record = parser
 
 and pattern_opt p = parser
 	| [< ( _ , pos as p) = pattern >] -> Some p , pos
-	| [< >] -> None , p 
+	| [< >] -> None , p
 
 and when_clause = parser
 	| [< '(Keyword When,_); e = expr >] -> Some e
@@ -390,7 +390,7 @@ let parse code file =
 		EBlock l, { pmin = 0; pmax = (pos !last).pmax; pfile = file }
 	with
 		| Stream.Error _
-		| Stream.Failure -> 
+		| Stream.Failure ->
 			Mllexer.restore old;
 			error (Unexpected (fst !last)) (pos !last)
 		| e ->
diff --git a/libs/ocaml/ml/mltype.ml b/libs/ocaml/ml/mltype.ml
index d70bba9..fbc8faf 100644
--- a/libs/ocaml/ml/mltype.ml
+++ b/libs/ocaml/ml/mltype.ml
@@ -1,6 +1,6 @@
 (*
  *  NekoML Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -23,7 +23,7 @@ type mutflag =
 	| Mutable
 	| Immutable
 
-type type_expr = 
+type type_expr =
 	| TAbstract
 	| TMono of int
 	| TPoly
@@ -87,7 +87,7 @@ and texpr_decl =
 	| TTry of texpr * match_op
 	| TTupleGet of texpr * int
 	| TErrorDecl of string * t
-	| TWhile of texpr * texpr	
+	| TWhile of texpr * texpr
 
 and texpr = {
 	edecl : texpr_decl;
@@ -131,7 +131,7 @@ let t_error = abstract "error"
 let t_bool = {
 	tid = -1;
 	texpr = TNamed (["bool"],[], {
-		tid = -1; 
+		tid = -1;
 		texpr = TUnion (2,[
 			("true",{ tid = -1; texpr = TAbstract });
 			("false",{ tid = -1; texpr = TAbstract })
@@ -151,7 +151,7 @@ let t_polymorph g = {
 	texpr = TPoly;
 }
 
-let t_poly g name = 
+let t_poly g name =
 	let param = t_mono g in
 	{
 		tid = genid g;
@@ -202,13 +202,13 @@ let s_mutable = function
 	| Mutable -> "mutable "
 	| Immutable -> ""
 
-let rec s_type ?(ext=false) ?(h=s_context()) t = 
+let rec s_type ?(ext=false) ?(h=s_context()) t =
 	match t.texpr with
 	| TAbstract -> "<abstract>"
 	| TMono _ -> Printf.sprintf "'_%s" (poly_id (try
 			if t.tid <> -2 then assert false;
 			List.assq t h.pi_ml
-		with Not_found -> 
+		with Not_found ->
 			let k = h.pi_mcount in
 			h.pi_mcount <- h.pi_mcount + 1;
 			h.pi_ml <- (t,k) :: h.pi_ml;
@@ -216,7 +216,7 @@ let rec s_type ?(ext=false) ?(h=s_context()) t =
 	| TPoly -> Printf.sprintf "'%s" (poly_id (try
 			if t.tid = -1 then assert false;
 			Hashtbl.find h.pi_ph t.tid
-		with Not_found -> 
+		with Not_found ->
 			let k = h.pi_pcount in
 			h.pi_pcount <- h.pi_pcount + 1;
 			Hashtbl.add h.pi_ph t.tid k;
@@ -225,7 +225,7 @@ let rec s_type ?(ext=false) ?(h=s_context()) t =
 	| TUnion (_,fl) -> Printf.sprintf "{ %s }" (String.concat "; " (List.map (fun (f,t) -> f ^ " : " ^ s_type ~h t) fl))
 	| TTuple l -> Printf.sprintf "(%s)" (String.concat ", " (List.map (s_type ~h) l))
 	| TLink t  -> s_type ~ext ~h t
-	| TFun (tl,r) -> 
+	| TFun (tl,r) ->
 		let l = String.concat " -> " (List.map (s_fun ~ext ~h) tl) ^ " -> " in
 		l ^ s_type ~ext ~h r
 	| TNamed (name,params,t) ->
@@ -238,7 +238,7 @@ let rec s_type ?(ext=false) ?(h=s_context()) t =
 		if ext then
 			s ^ name ^ " = " ^ s_type ~h t
 		else
-			s ^ name 
+			s ^ name
 
 and s_fun ~ext ~h t =
 	match t.texpr with
diff --git a/libs/ocaml/ml/mltyper.ml b/libs/ocaml/ml/mltyper.ml
index da3f346..a65615f 100644
--- a/libs/ocaml/ml/mltyper.ml
+++ b/libs/ocaml/ml/mltyper.ml
@@ -1,6 +1,6 @@
 (*
  *  NekoML Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
  *)
- 
+
 open Mlast
 open Mltype
 
@@ -71,7 +71,7 @@ let load_module_ref = ref (fun _ _ -> assert false)
 let add_local ctx v t =
 	if v <> "_" then ctx.current.idents <- PMap.add v t ctx.current.idents
 
-let save_locals ctx = 
+let save_locals ctx =
 	ctx.current.idents
 
 let restore_locals ctx l =
@@ -84,8 +84,8 @@ let get_module ctx path p =
 		let m = (try
 			Hashtbl.find ctx.modules path
 		with
-			Not_found -> 
-				!load_module_ref ctx path p) in		
+			Not_found ->
+				!load_module_ref ctx path p) in
 		if m != ctx.current then begin
 			if m.expr = None then error (Module_not_loaded m) p;
 			Hashtbl.replace ctx.current.deps m.path m;
@@ -151,14 +151,14 @@ let get_record ctx f p =
 	let h = Hashtbl.create 0 in
 	duplicate ctx.gen ~h rt, duplicate ctx.gen ~h ft, mut
 
-let rec is_tuple t = 
+let rec is_tuple t =
 	match t.texpr with
 	| TLink t -> is_tuple t
 	| TTuple _ -> true
 	| TNamed(_,_,t) -> is_tuple t
 	| _ -> false
 
-let rec is_recursive t1 t2 = 
+let rec is_recursive t1 t2 =
 	if t1 == t2 then
 		true
 	else match t2.texpr with
@@ -187,7 +187,7 @@ let unify_stack t1 t2 = function
 	| e -> raise e
 
 let is_alias = function
-	| TAbstract 
+	| TAbstract
 	| TRecord _
 	| TUnion _ -> false
 	| TMono _
@@ -203,7 +203,7 @@ let rec propagate k t =
 	| TPoly -> ()
 	| TUnion _
 	| TRecord _ -> assert false
-	| TMono k2 -> if k < k2 then t.texpr <- TMono k	
+	| TMono k2 -> if k < k2 then t.texpr <- TMono k
 	| TTuple tl -> List.iter (propagate k) tl
 	| TLink t -> propagate k t
 	| TFun (tl,t) -> propagate k t; List.iter (propagate k) tl
@@ -222,7 +222,7 @@ let rec unify ctx t1 t2 p =
 	| TNamed (n1,p1,_) , TNamed (n2,p2,_) when n1 = n2 ->
 		(try
 			List.iter2 (fun p1 p2 -> unify ctx p1 p2 p) p1 p2
-		with	
+		with
 			e -> unify_stack t1 t2 e)
 	| TNamed (_,_,t1) , _ when is_alias t1.texpr ->
 		(try
@@ -234,16 +234,16 @@ let rec unify ctx t1 t2 p =
 			unify ctx t1 t2 p
 		with
 			e -> unify_stack t1 t2 e)
-	| TFun (tl1,r1) , TFun (tl2,r2) when List.length tl1 = List.length tl2 -> 
+	| TFun (tl1,r1) , TFun (tl2,r2) when List.length tl1 = List.length tl2 ->
 		(try
-			List.iter2 (fun t1 t2 -> unify ctx t1 t2 p) tl1 tl2; 
+			List.iter2 (fun t1 t2 -> unify ctx t1 t2 p) tl1 tl2;
 			unify ctx r1 r2 p;
-		with	
+		with
 			e -> unify_stack t1 t2 e)
 	| TTuple tl1 , TTuple tl2 when List.length tl1 = List.length tl2 ->
 		(try
 			List.iter2 (fun t1 t2 -> unify ctx t1 t2 p) tl1 tl2
-		with	
+		with
 			e -> unify_stack t1 t2 e)
 	| _ , _ ->
 		error (Cannot_unify (t1,t2)) p
@@ -285,7 +285,7 @@ let rec type_type ?(allow=true) ?(h=Hashtbl.create 0) ctx t p =
 	| EArrow _ ->
 		let rec loop params t =
 			match t with
-			| EArrow (ta,tb) -> 
+			| EArrow (ta,tb) ->
 				let ta = type_type ~allow ~h ctx ta p in
 				loop (ta :: params) tb
 			| _ ->
@@ -303,7 +303,7 @@ let rec type_constant ctx ?(path=[]) c p =
 	| Char c -> mk (TConst (TChar c)) t_char p
 	| Ident s ->
 		let path , t = get_ident ctx path s p in
-		let t = duplicate ctx.gen t in		
+		let t = duplicate ctx.gen t in
 		mk (TConst (TModule (path,TIdent s))) t p
 	| Constr s ->
 		let path , ut , t = get_constr ctx path s p in
@@ -340,16 +340,16 @@ let type_binop ctx op e1 e2 p =
 		| NFloat , NInt -> emk t_float
 		| NInt , NString
 		| NFloat , NString
-		| NString , NInt 
+		| NString , NInt
 		| NString , NFloat
 		| NString , NString -> emk t_string
 		| NInt , NNan
-		| NFloat , NNan 
+		| NFloat , NNan
 		| NString , NNan ->
 			unify ctx e2.etype e1.etype (pos e2);
 			emk e1.etype
 		| NNan , NInt
-		| NNan , NFloat 
+		| NNan , NFloat
 		| NNan , NString ->
 			unify ctx e1.etype e2.etype (pos e1);
 			emk e2.etype
@@ -419,9 +419,9 @@ let type_unop ctx op e p =
 		let p , pt = t_poly ctx.gen "ref" in
 		unify ctx e.etype p (pos e);
 		emk pt
-	| "!" -> 
+	| "!" ->
 		unify ctx e.etype t_bool (pos e);
-		emk t_bool 
+		emk t_bool
 	| "-" ->
 		(match addable false e with
 		| NInt -> emk t_int
@@ -433,7 +433,7 @@ let type_unop ctx op e p =
 		assert false
 
 let rec type_arg ctx h binds p = function
-	| ATyped (a,t) -> 
+	| ATyped (a,t) ->
 		let n , ta = type_arg ctx h binds p a in
 		unify ctx ta (type_type ~h ctx t p) p;
 		n , ta
@@ -457,18 +457,18 @@ let register_function ctx isrec name pl e rt p =
 	let binds = ref [] in
 	let el = List.map (type_arg ctx h binds p) pl in
 	let name = (match name with None -> "_" | Some n -> n) in
-	let e = (match List.rev !binds with 
+	let e = (match List.rev !binds with
 		| [] -> e
-		| l -> 
+		| l ->
 			EBlock (List.fold_left (fun acc (v,n,v2) ->
 				(EVar ([v2,None], (ETupleGet ((EConst (Ident v),p),n),p)) , p) :: acc
 			) [e] l) , p
 	) in
-	let rt = (match rt with 
+	let rt = (match rt with
 		| None -> t_mono ctx.gen
 		| Some rt -> type_type ~h ctx rt p
 	) in
-	let ft = mk_fun ctx.gen (List.map snd el) rt in		
+	let ft = mk_fun ctx.gen (List.map snd el) rt in
 	ctx.functions <- (isrec,name,expr,ft,el,e,rt,p) :: ctx.functions;
 	if isrec then add_local ctx name ft;
 	mk (TMut expr) (if name = "_" then ft else t_void) p
@@ -481,7 +481,7 @@ let type_format ctx s p =
 		if !percent then begin
 			percent := false;
 			match c with
-			| '%' -> 
+			| '%' ->
 				()
 			| 'x' | 'X' | 'd' ->
 				types := t_int :: !types
@@ -499,7 +499,7 @@ let type_format ctx s p =
 				error (Custom "Invalid % sequence") p
 		end else
 			match c with
-			| '%' -> 
+			| '%' ->
 				percent := true
 			| _ ->
 				()
@@ -525,7 +525,7 @@ let rec type_functions ctx =
 		end;
 		List.iter (fun (p,pt) ->
 			add_local ctx p pt
-		) el;		
+		) el;
 		let e = type_expr ctx e in
 		restore_locals ctx locals;
 		ctx.curfunction <- func;
@@ -541,7 +541,7 @@ and type_expr ctx (e,p) =
 	match e with
 	| EConst c ->
 		type_constant ctx c p
-	| EBlock [] -> 
+	| EBlock [] ->
 		mk (TConst TVoid) t_void p
 	| EBlock (e :: l) ->
 		let locals = save_locals ctx in
@@ -580,7 +580,7 @@ and type_expr ctx (e,p) =
 			let rec loop acc expr l tl r =
 				match l , tl with
 				| e :: l , t :: tl ->
-					(match tlinks true t with 
+					(match tlinks true t with
 					| TNamed (["format"],[param],_) ->
 						(match e.edecl with
 						| TConst (TString s) ->
@@ -634,7 +634,7 @@ and type_expr ctx (e,p) =
 		unify ctx e.etype t (pos e);
 		mk (TArray (e,ei)) pt p
 	| EVar _ ->
-		error (Custom "Variable declaration not allowed outside a block") p	
+		error (Custom "Variable declaration not allowed outside a block") p
 	| EIf (e,e1,None) ->
 		let e = type_expr ctx e in
 		unify ctx e.etype t_bool (pos e);
@@ -654,7 +654,7 @@ and type_expr ctx (e,p) =
 		let e2 = type_expr ctx e2 in
 		unify ctx e2.etype t_void (pos e2);
 		mk (TWhile (e1,e2)) t_void p
-	| EFunction (isrec,name,pl,e,rt) ->		
+	| EFunction (isrec,name,pl,e,rt) ->
 		let r = register_function ctx isrec name pl e rt p in
 		type_functions ctx;
 		r
@@ -689,7 +689,7 @@ and type_expr ctx (e,p) =
 						let t = t_mono ctx.gen in
 						Hashtbl.add h p t;
 						t
-					) params in					
+					) params in
 					let t = {
 						tid = -1;
 						texpr = TNamed (fullname,tl,t_abstract);
@@ -733,13 +733,13 @@ and type_expr ctx (e,p) =
 		) in
 		let fl2 = ref fll in
 		let rec loop f = function
-			| [] -> 
+			| [] ->
 				if List.exists (fun (f2,_,_) -> f = f2) fll then
 					error (Custom ("Duplicate declaration for field " ^ f)) p
 				else
 					error (Have_no_field (r,f)) p
 			| (f2,_,ft) :: l when f = f2 -> ft , l
-			| x :: l -> 
+			| x :: l ->
 				let t , l = loop f l in
 				t , x :: l
 		in
@@ -786,13 +786,13 @@ and type_expr ctx (e,p) =
 		in
 		mk (TTupleGet (e,n)) (loop e.etype) p
 
-and type_block ctx ((e,p) as x)  = 
+and type_block ctx ((e,p) as x)  =
 	match e with
 	| EVar (vl,e) ->
 		type_functions ctx;
 		let e = type_expr ctx e in
 		let make v t =
-			let t = (match t with 
+			let t = (match t with
 				| None -> t_mono ctx.gen
 				| Some t -> type_type ctx t p
 			) in
@@ -802,7 +802,7 @@ and type_block ctx ((e,p) as x)  =
 		let t = (match vl with
 			| [] -> assert false
 			| [v,t] -> make v t
-			| _ -> 
+			| _ ->
 				mk_tup ctx.gen (List.map (fun (v,t) -> make v t) vl)
 		) in
 		unify ctx t e.etype (pos e);
@@ -839,7 +839,7 @@ and type_pattern (ctx:context) h ?(h2 = Hashtbl.create 0) set add (pat,p) =
 		| PTuple [p] ->
 			let pt , pat = type_pattern ctx h ~h2 set add p in
 			pt , fst pat
-		| PTuple pl -> 
+		| PTuple pl ->
 			let pl , patl = List.split (List.map (type_pattern ctx h ~h2 set add) pl) in
 			mk_tup ctx.gen pl , PTuple patl
 		| PRecord fl ->
@@ -849,24 +849,24 @@ and type_pattern (ctx:context) h ?(h2 = Hashtbl.create 0) set add (pat,p) =
 			| TRecord rl ->
 				List.map (fun (f,pat) ->
 					let pt , pat = type_pattern ctx h ~h2 set add pat in
-					let t = (try 
-						let _ , _ , t = List.find (fun (f2,_,_) -> f = f2 ) rl in t 
+					let t = (try
+						let _ , _ , t = List.find (fun (f2,_,_) -> f = f2 ) rl in t
 					with Not_found ->
 						error (Have_no_field (r,f)) p
 					) in
 					unify ctx pt t (snd pat);
 					f , pat
-				) fl 
+				) fl
 			| _ ->
 				assert false
 			) in
 			r , PRecord fl
 		| PIdent s ->
 			(if s = "_" then t_mono ctx.gen else pvar add s) , pat
-		| PConstr (path,s,param) ->	
+		| PConstr (path,s,param) ->
 			let tparam , param = (match param with
-				| None -> None , None 
-				| Some ((_,p) as param) -> 
+				| None -> None , None
+				| Some ((_,p) as param) ->
 					let t , pat = type_pattern ctx h ~h2 set add param in
 					Some (p,t) , Some pat
 			) in
@@ -879,7 +879,7 @@ and type_pattern (ctx:context) h ?(h2 = Hashtbl.create 0) set add (pat,p) =
 				let h = Hashtbl.create 0 in
 				let ut = duplicate ctx.gen ~h ut in
 				let t = duplicate ctx.gen ~h t in
-				let param , pt = (match param with 
+				let param , pt = (match param with
 					| Some (PTuple l,p) when not (is_tuple t) -> Some (PTuple [(PTuple l,p)],p) , mk_fun ctx.gen [pt] ut
 					| Some (PIdent "_",p) -> param , pt
 					| _  -> param , (match pt.texpr with TTuple l -> mk_fun ctx.gen l ut | _ -> mk_fun ctx.gen [pt] ut)
@@ -904,7 +904,7 @@ and type_pattern (ctx:context) h ?(h2 = Hashtbl.create 0) set add (pat,p) =
 				| SPattern pat ->
 					let t , p = type_pattern ctx h ~h2 set true pat in
 					unify ctx t polyt (snd p);
-					SPattern p 
+					SPattern p
 				| SExpr ([v],e) ->
 					let e = type_expr ctx e in
 					let t = pvar true v in
@@ -921,9 +921,9 @@ and type_pattern (ctx:context) h ?(h2 = Hashtbl.create 0) set add (pat,p) =
 			) l in
 			restore_locals ctx locals;
 			t , PStream (l,k)
-	) in	
+	) in
 	pt , (pat,p)
-	
+
 and type_match ctx t cl p =
 	let ret = t_mono ctx.gen in
 	let cl = List.map (fun (pl,wh,pe) ->
@@ -942,13 +942,13 @@ and type_match ctx t cl p =
 				SSet.iter (fun s -> error (Custom ("Variable " ^ s ^ " must occur in all patterns")) p) (SSet.union s1 s2);
 			end;
 			unify ctx pt t p;
-			pat 
+			pat
 		) pl in
 		let locals = save_locals ctx in
 		Hashtbl.iter (fun v t -> add_local ctx v t) h;
-		let wh = (match wh with 
+		let wh = (match wh with
 			| None -> None
-			| Some e -> 
+			| Some e ->
 				let e = type_expr ctx e in
 				unify ctx e.etype t_bool e.epos;
 				Some e
@@ -987,10 +987,10 @@ and type_match ctx t cl p =
 
 let modules ctx =
 	let h = Hashtbl.create 0 in
-	Hashtbl.iter (fun p m -> 
-		match m.expr with 
+	Hashtbl.iter (fun p m ->
+		match m.expr with
 		| None -> ()
-		| Some e -> 		
+		| Some e ->
 			let deps = ref (if m.path = ["Core"] || Hashtbl.mem m.deps ["Core"] then [] else [["Core"]]) in
 			let idents = ref [] in
 			Hashtbl.iter (fun _ m ->
@@ -1019,7 +1019,7 @@ let load_module ctx m p =
 	try
 		Hashtbl.find ctx.modules m
 	with
-		Not_found ->			
+		Not_found ->
 			let file , ch = open_file ctx (String.concat "/" m ^ ".nml") p in
 			let is_core , core = (try
 				false , Hashtbl.find ctx.modules ["Core"]
@@ -1055,11 +1055,11 @@ let load_module ctx m p =
 				| _ ->
 					type_expr ctx ast
 			) in
-			ctx.current.expr <- Some e;			
+			ctx.current.expr <- Some e;
 			if !verbose then print_endline ("Typing done with " ^ file);
 			ctx.current
 
-let context cpath = 
+let context cpath =
 	let ctx = {
 		gen = generator();
 		tmptypes = Hashtbl.create 0;
@@ -1079,10 +1079,10 @@ let context cpath =
 			records = Hashtbl.create 0;
 		};
 	} in
-	let add_type args name t = 
+	let add_type args name t =
 		ignore(type_expr ctx (ETypeDecl (args,name,t) , null_pos));
 	in
-	let add_variable name t = 
+	let add_variable name t =
 		ctx.current.idents <- PMap.add name t ctx.current.idents
 	in
 	add_type [] "bool" EAbstract;
diff --git a/libs/ocaml/nast.ml b/libs/ocaml/nast.ml
index 9e0ab51..9c23f3a 100644
--- a/libs/ocaml/nast.ml
+++ b/libs/ocaml/nast.ml
@@ -1,6 +1,6 @@
 (*
  *  Neko AST for OCaml
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -43,7 +43,7 @@ type expr_decl =
 	| EParenthesis of expr
 	| EField of expr * string
 	| ECall of expr * expr list
-	| EArray of expr * expr	
+	| EArray of expr * expr
 	| EVars of (string * expr option) list
 	| EWhile of expr * expr * while_flag
 	| EIf of expr * expr * expr option
@@ -116,7 +116,7 @@ let iter f (e,p) =
 	| EBreak (Some e) -> f e
 	| ENext (e1,e2) -> f e1; f e2
 	| EObject fl -> List.iter (fun (_,e) -> f e) fl
-	| ESwitch (e,cases,def) -> f e; List.iter (fun(e1,e2) -> f e1; f e2) cases; (match def with None -> () | Some e -> f e) 
+	| ESwitch (e,cases,def) -> f e; List.iter (fun(e1,e2) -> f e1; f e2) cases; (match def with None -> () | Some e -> f e)
 	| EReturn None
 	| EBreak None
 	| EContinue
diff --git a/libs/ocaml/neko/bytecode.ml b/libs/ocaml/neko/bytecode.ml
index 0e5c375..41928e9 100644
--- a/libs/ocaml/neko/bytecode.ml
+++ b/libs/ocaml/neko/bytecode.ml
@@ -1,6 +1,6 @@
 (*
  *  Neko Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -96,7 +96,7 @@ let hash_field s =
 		acc := 223 * !acc + Char.code (String.unsafe_get s i)
 	done;
 	acc := !acc land ((1 lsl 31) - 1);
-	!acc	
+	!acc
 
 let op_param = function
 	| AccInt _
@@ -116,7 +116,7 @@ let op_param = function
 	| JumpIf _
 	| JumpIfNot _
 	| Trap _
-	| MakeEnv _ 
+	| MakeEnv _
 	| MakeArray _
 	| Ret _
 	| AccIndex _
@@ -169,7 +169,7 @@ let code_tables ops =
 				let f = Hashtbl.find ids id in
 				if f <> s then failwith ("Field hashing conflict " ^ s ^ " and " ^ f);
 			with
-				Not_found ->	
+				Not_found ->
 					Hashtbl.add ids id s)
 		| _ -> ()
 	) ops;
@@ -296,7 +296,7 @@ let read ch =
 			| _ -> raise Invalid_file
 		) in
 		let ids = Hashtbl.create 0 in
-		let rec loop n = 
+		let rec loop n =
 			if n = 0 then
 				()
 			else
@@ -400,7 +400,7 @@ let read ch =
 			| JumpIf p -> JumpIf (pos_index i (a+p))
 			| JumpIfNot p -> JumpIfNot (pos_index i (a+p))
 			| Trap p -> Trap (pos_index i (a+p))
-			| _ -> assert false)			
+			| _ -> assert false)
 		) !jumps;
 		Array.iteri (fun i g ->
 			match g with
@@ -423,10 +423,10 @@ let dump ch (globals,ops) =
 	IO.printf ch "GLOBALS =\n";
 	let marks = Array.create csize false in
 	Array.iteri (fun i g ->
-		IO.printf ch "  global %d : %s\n" i 
+		IO.printf ch "  global %d : %s\n" i
 			(match g with
 			| GlobalVar s -> "var " ^ s
-			| GlobalFunction (p,n) -> 
+			| GlobalFunction (p,n) ->
 				if p >= 0 && p < csize then marks.(p) <- true;
 				"function " ^ string_of_int p ^ " nargs " ^ string_of_int n
 			| GlobalString s -> "string \"" ^ escape s ^ "\""
@@ -477,7 +477,7 @@ let dump ch (globals,ops) =
 			| IsNull -> "IsNull"
 			| IsNotNull -> "IsNotNull"
 			| Add -> "Add"
-			| Sub -> "Sub" 
+			| Sub -> "Sub"
 			| Mult -> "Mult"
 			| Div -> "Div"
 			| Mod -> "Mod"
diff --git a/libs/ocaml/neko/compile.ml b/libs/ocaml/neko/compile.ml
index 384b146..9978999 100644
--- a/libs/ocaml/neko/compile.ml
+++ b/libs/ocaml/neko/compile.ml
@@ -1,6 +1,6 @@
 (*
  *  Neko Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
  *)
- 
+
 open Ast
 open Bytecode
 
@@ -46,7 +46,7 @@ type context = {
 	labels : (string,label) Hashtbl.t;
 }
 
-type error_msg = 
+type error_msg =
 	| Custom of string
 
 exception Error of error_msg * pos
@@ -63,14 +63,14 @@ let stack_delta = function
 	| AccThis
 	| AccInt _
 	| AccStack _
-	| AccGlobal _ 
+	| AccGlobal _
 	| AccEnv _
 	| AccField _
 	| AccBuiltin _
 	| AccIndex _
 	| JumpIf _
 	| JumpIfNot _
-	| Jump _ 
+	| Jump _
 	| Ret _
 	| SetGlobal _
 	| SetStack _
@@ -168,7 +168,7 @@ let check_breaks ctx =
 
 let rec scan_labels ctx supported e =
 	match fst e with
-	| EFunction (args,e) -> 
+	| EFunction (args,e) ->
 		let nargs = List.length args in
 		let ntraps = ctx.ntraps in
 		ctx.ntraps <- 0;
@@ -176,7 +176,7 @@ let rec scan_labels ctx supported e =
 		scan_labels ctx supported e;
 		ctx.stack <- ctx.stack - nargs;
 		ctx.ntraps <- ntraps
-	| EBlock _ -> 
+	| EBlock _ ->
 		let old = ctx.stack in
 		Ast.iter (scan_labels ctx supported) e;
 		ctx.stack <- old
@@ -237,13 +237,13 @@ let rec scan_labels ctx supported e =
 		List.iter (fun (s,e) ->
 			scan_labels ctx supported e
 		) fl;
-		ctx.stack <- ctx.stack - 2;	
+		ctx.stack <- ctx.stack - 2;
 	| EConst _
-	| EContinue 
+	| EContinue
 	| EBreak _
-	| EReturn _ 
+	| EReturn _
 	| EIf _
-	| EWhile _ 
+	| EWhile _
 	| EParenthesis _
 	| ENext _ ->
 		Ast.iter (scan_labels ctx supported) e
@@ -261,7 +261,7 @@ let compile_constant ctx c p =
 	| Int n -> write ctx (AccInt n)
 	| Float f -> write ctx (AccGlobal (global ctx (GlobalFloat f)))
 	| String s -> write ctx (AccGlobal (global ctx (GlobalString s)))
-	| Builtin s -> 
+	| Builtin s ->
 		(match s with
 		| "tnull" -> write ctx (AccInt 0)
 		| "tint" -> write ctx (AccInt 1)
@@ -293,7 +293,7 @@ let compile_constant ctx c p =
 
 let rec compile_binop ctx op e1 e2 p =
 	match op with
-	| "=" ->		
+	| "=" ->
 		(match fst e1 with
 		| EConst (Ident s) ->
 			compile ctx e2;
@@ -471,7 +471,7 @@ and compile_builtin ctx b el p =
 		if ctx.stack > l.lstack then write ctx (Pop (ctx.stack - l.lstack));
 		while ctx.stack < l.lstack do
 			write ctx Push;
-		done;		
+		done;
 		ctx.stack <- os;
 		(match l.lpos with
 		| None -> l.lwait <- jmp ctx :: l.lwait
@@ -606,7 +606,7 @@ and compile ctx (e,p) =
 		jend()
 	| EBinop ("-",(EConst (Int 0),_),(EConst (Int i),_)) ->
 		compile ctx (EConst (Int (-i)),p)
-	| EBinop (op,e1,e2) -> 
+	| EBinop (op,e1,e2) ->
 		compile_binop ctx op e1 e2 p
 	| EReturn None ->
 		write ctx AccNull;
@@ -703,7 +703,7 @@ let compile file ast =
 			write ctx (SetGlobal g);
 			List.iter (fun f ->
 				write ctx (AccGlobal g);
-				write ctx Push;		
+				write ctx Push;
 				write ctx (SetField f);
 			) fl
 		) ctx.gobjects;
diff --git a/libs/ocaml/neko/lexer.mll b/libs/ocaml/neko/lexer.mll
index 159a7df..c84aec1 100644
--- a/libs/ocaml/neko/lexer.mll
+++ b/libs/ocaml/neko/lexer.mll
@@ -1,6 +1,6 @@
 (*
  *  Neko Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -42,7 +42,7 @@ let all_lines = Hashtbl.create 0
 let lines = ref []
 let buf = Buffer.create 100
 
-let error e pos = 
+let error e pos =
 	raise (Error (e,{ pmin = pos; pmax = pos; pfile = !cur_file }))
 
 let keywords =
@@ -65,7 +65,7 @@ let save() =
 let restore file =
 	save_lines();
 	cur_file := file;
-	lines := Hashtbl.find all_lines file 
+	lines := Hashtbl.find all_lines file
 
 let newline lexbuf =
 	lines := (lexeme_end lexbuf) :: !lines
@@ -104,7 +104,7 @@ let add c = Buffer.add_string buf c
 let mk_tok t pmin pmax =
 	t , { pfile = !cur_file; pmin = pmin; pmax = pmax }
 
-let mk lexbuf t = 
+let mk lexbuf t =
 	mk_tok t (lexeme_start lexbuf) (lexeme_end lexbuf)
 
 let mk_ident lexbuf =
@@ -129,14 +129,14 @@ rule token = parse
 	| '[' { mk lexbuf BracketOpen }
 	| ']' { mk lexbuf BracketClose }
 	| "=>" { mk lexbuf Arrow }
-	| [' ' '\r' '\t']+ { token lexbuf } 
+	| [' ' '\r' '\t']+ { token lexbuf }
 	| '\n' { newline lexbuf; token lexbuf }
-	| "0x" ['0'-'9' 'a'-'f' 'A'-'F']+	
+	| "0x" ['0'-'9' 'a'-'f' 'A'-'F']+
 	| number+ { mk lexbuf (Const (Int (int_of_string (lexeme lexbuf)))) }
 	| number+ '.' number*
 	| '.' number+ { mk lexbuf (Const (Float (lexeme lexbuf))) }
 	| '$' (ident as v) { mk lexbuf (Const (Builtin v)) }
-	| "true" { mk lexbuf (Const True) } 
+	| "true" { mk lexbuf (Const True) }
 	| "false" { mk lexbuf (Const False) }
 	| "null" { mk lexbuf (Const Null) }
 	| "this" { mk lexbuf (Const This) }
@@ -152,7 +152,7 @@ rule token = parse
 			let pmin = lexeme_start lexbuf in
 			let pmax = (try comment lexbuf with Exit -> error Unclosed_comment pmin) in
 			mk_tok (Comment (contents())) pmin pmax;
-		}	
+		}
 	| "//" [^'\n']*  {
 			let s = lexeme lexbuf in
 			let n = (if s.[String.length s - 1] = '\r' then 3 else 2) in
@@ -179,7 +179,7 @@ and string = parse
 	| "\\n" { add "\n"; string lexbuf }
 	| "\\t" { add "\t"; string lexbuf }
 	| "\\r" { add "\r"; string lexbuf }
-	| '\\' ['0'-'9'] ['0'-'9'] ['0'-'9'] { 
+	| '\\' ['0'-'9'] ['0'-'9'] ['0'-'9'] {
 			let i = int_of_string (String.sub (lexeme lexbuf) 1 3) in
 			if i >= 256 then error (Invalid_escaped_character i) (lexeme_start lexbuf);
 			add (String.make 1 (char_of_int i));
@@ -188,4 +188,3 @@ and string = parse
 	| '\\' { error Invalid_escape (lexeme_start lexbuf) }
 	| '"' { lexeme_end lexbuf }
 	| [^'"' '\\' '\n']+ { store lexbuf; string lexbuf }
- 
\ No newline at end of file
diff --git a/libs/ocaml/neko/main.ml b/libs/ocaml/neko/main.ml
index db5bdf2..f358c68 100644
--- a/libs/ocaml/neko/main.ml
+++ b/libs/ocaml/neko/main.ml
@@ -1,6 +1,6 @@
 (*
  *  Neko Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
  *)
- 
+
 open Printf
 
 type p_style =
@@ -29,7 +29,7 @@ let normalize_path p =
 	let l = String.length p in
 	if l = 0 then
 		"./"
-	else match p.[l-1] with 
+	else match p.[l-1] with
 		| '\\' | '/' -> p
 		| _ -> p ^ "/"
 
@@ -64,8 +64,8 @@ let compile_exn = function
 	| e -> raise e
 
 let main() =
-	try	
-		let usage = "Neko v0.4 - (c)2005-2017 Haxe Foundation\n Usage : neko.exe [options] <files...>\n Options :" in
+	try
+		let usage = "Neko v0.4 - (c)2005-2022 Haxe Foundation\n Usage : neko.exe [options] <files...>\n Options :" in
 		let output = ref "n" in
 		let args_spec = [
 			("-msvc",Arg.Unit (fun () -> print_style := StyleMSVC),": use MSVC style errors");
@@ -73,7 +73,7 @@ let main() =
 			("-o", Arg.String (fun ext -> output := String.lowercase ext),"<file> : specify output extension");
 			("-v", Arg.Unit (fun () -> Plugin.verbose := true),": verbose mode");
 		] in
-		Arg.parse args_spec (fun file -> 
+		Arg.parse args_spec (fun file ->
 			Plugin.generate file !output
 		) usage;
 	with
diff --git a/libs/ocaml/neko/parser.ml b/libs/ocaml/neko/parser.ml
index 565a572..c0ca32e 100644
--- a/libs/ocaml/neko/parser.ml
+++ b/libs/ocaml/neko/parser.ml
@@ -1,6 +1,6 @@
 (*
  *  Neko Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
  *)
- 
+
 open Ast
 
 type error_msg =
@@ -82,7 +82,7 @@ and expr = parser
 	| [< '(Keyword Do,p1); e = expr; '(Keyword While,_); cond = expr; s >] ->
 		expr_next (EWhile (cond,e,DoWhile), punion p1 (pos cond)) s
 	| [< '(Keyword If,p1); cond = expr; e = expr; s >] ->
-		let rec loop s = 
+		let rec loop s =
 			match s with parser
 			| [< '(Keyword Else,_); e2 = expr; s >] -> expr_next (EIf (cond,e,Some e2),punion p1 (pos e2)) s
 			| [< '(Semicolon,_); s >] -> loop s
@@ -119,7 +119,7 @@ and expr_next e = parser
 		| [< >] -> error (Unclosed "[") po)
 	| [< '(Binop op,_); e2 = expr; s >] ->
 		make_binop op e e2
-	| [< >] -> 
+	| [< >] ->
 		e
 
 and block1 = parser
@@ -171,7 +171,7 @@ let parse code file =
 	let rec next_token x =
 		let t, p = Lexer.token code in
 		match t with
-		| Comment s | CommentLine s -> 
+		| Comment s | CommentLine s ->
 			next_token x
 		| _ ->
 			last := (t , p);
@@ -183,7 +183,7 @@ let parse code file =
 		EBlock l, { pmin = 0; pmax = (pos !last).pmax; pfile = file }
 	with
 		| Stream.Error _
-		| Stream.Failure -> 
+		| Stream.Failure ->
 			Lexer.restore old;
 			error (Unexpected (fst !last)) (pos !last)
 		| e ->
diff --git a/libs/ocaml/neko/plugin.ml b/libs/ocaml/neko/plugin.ml
index 60e2d15..b65aa12 100644
--- a/libs/ocaml/neko/plugin.ml
+++ b/libs/ocaml/neko/plugin.ml
@@ -1,6 +1,6 @@
 (*
  *  Neko Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -44,7 +44,7 @@ let register source dest trans exc =
 		exceptions = exc;
 	} :: !plugins
 
-let exn_infos name msg pos = 
+let exn_infos name msg pos =
 	{
 		exn_name = name;
 		exn_pos = pos;
@@ -52,8 +52,8 @@ let exn_infos name msg pos =
 	}
 
 let open_file ?(bin=false) f =
-	let rec loop = function 
-		| [] -> None 
+	let rec loop = function
+		| [] -> None
 		| path :: l ->
 			let file = path ^ f in
 			try
@@ -63,7 +63,7 @@ let open_file ?(bin=false) f =
 				_ -> loop l
 	in
 	loop (!paths)
-	
+
 let switch_ext file ext =
 	try
 		Filename.chop_extension file ^ ext
@@ -102,7 +102,7 @@ let generate_loop file ch fext ext =
 	let ftarget = switch_ext file ("." ^ ext) in
 	let genlist = (try
 		List.rev (loop fext [] (!plugins))
-	with Not_found -> 
+	with Not_found ->
 		let fbase = Filename.basename file in
 		failwith ("Don't know how to generate " ^ Filename.basename ftarget ^ " from " ^ fbase)
 	) in
@@ -114,7 +114,7 @@ let generate_loop file ch fext ext =
 	in
 	let rec loop file ch = function
 		| [] -> assert false
-		| [x] -> 
+		| [x] ->
 			let out = IO.output_channel (open_out_bin ftarget) in
 			execute x file ch out;
 			(try IO.close_in ch with IO.Input_closed -> ());
diff --git a/libs/ocaml/neko/printer.ml b/libs/ocaml/neko/printer.ml
index d12b188..e09052e 100644
--- a/libs/ocaml/neko/printer.ml
+++ b/libs/ocaml/neko/printer.ml
@@ -1,6 +1,6 @@
 (*
  *  Neko Compiler
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,7 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
  *)
- 
+
 open Ast
 
 type 'a ctx = {
@@ -117,7 +117,7 @@ let rec print_ast ?(binop=false) ctx (e,p) =
 		level_expr ~closed:(e2=None) ctx e;
 		(match e2 with
 		| None -> ()
-		| Some e -> 
+		| Some e ->
 			print ctx "else";
 			level_expr ctx e)
 	| ETry (e,id,e2) ->
@@ -136,17 +136,17 @@ let rec print_ast ?(binop=false) ctx (e,p) =
 		print_ast ~binop:true ctx e1;
 		print ctx " %s " op;
 		print_ast ~binop:true ctx e2;
-		if binop then (if tabs then print ctx ")" else print ctx "}");		
+		if binop then (if tabs then print ctx ")" else print ctx "}");
 	| EReturn None ->
 		print ctx "return;";
 	| EReturn (Some e) ->
 		print ctx "return ";
-		print_ast ctx e;		
+		print_ast ctx e;
 	| EBreak None ->
-		print ctx "break;";			
+		print ctx "break;";
 	| EBreak (Some e) ->
 		print ctx "break ";
-		print_ast ctx e;			
+		print_ast ctx e;
 	| EContinue ->
 		print ctx "continue"
 	| ENext (e1,e2) ->
@@ -180,7 +180,7 @@ let rec print_ast ?(binop=false) ctx (e,p) =
 
 and level_expr ?(closed=false) ctx (e,p) =
 	match e with
-	| EBlock _ -> 
+	| EBlock _ ->
 		if ctx.tabs then print ctx " ";
 		print_ast ctx (e,p)
 	| ENext _ ->
diff --git a/libs/ocaml/nxml.ml b/libs/ocaml/nxml.ml
index 1a61113..d05edf9 100644
--- a/libs/ocaml/nxml.ml
+++ b/libs/ocaml/nxml.ml
@@ -1,6 +1,6 @@
 (*
  *  Neko NXML for OCaml
- *  Copyright (c)2005-2017 Haxe Foundation
+ *  Copyright (c)2005-2022 Haxe Foundation
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -52,7 +52,7 @@ let rec to_xml_rec p2 ast =
 		)
 	| EBlock el ->
 		name := "b";
-		children := List.map (to_xml_rec p) el; 
+		children := List.map (to_xml_rec p) el;
 	| EParenthesis e ->
 		name := "p";
 		children := [to_xml_rec p e];
@@ -65,7 +65,7 @@ let rec to_xml_rec p2 ast =
 		children := to_xml_rec p e :: List.map (to_xml_rec p) el;
 	| EArray (a,b) ->
 		name := "a";
-		children := [to_xml_rec p a; to_xml_rec p b]; 
+		children := [to_xml_rec p a; to_xml_rec p b];
 	| EVars vl ->
 		name := "var";
 		children := List.map (fun(v,e) ->
diff --git a/libs/regexp/CMakeLists.txt b/libs/regexp/CMakeLists.txt
index 33809de..1d316a2 100644
--- a/libs/regexp/CMakeLists.txt
+++ b/libs/regexp/CMakeLists.txt
@@ -3,80 +3,71 @@
 # regexp.ndll
 
 add_library(regexp.ndll MODULE regexp.c)
-if (STATIC_PCRE)
+if (STATIC_PCRE2)
+	add_definitions(-DPCRE2_STATIC_LINK)
+	set(PCRE2_CONFIG
+		URL
+			"https://github.com/PhilipHazel/pcre2/releases/download/pcre2-10.37/pcre2-10.37.tar.gz"
+			"https://sourceforge.net/projects/pcre/files/pcre2/10.37/pcre2-10.37.tar.gz/download"
+		URL_MD5 a0b59d89828f62d2e1caac04f7c51e0b
+	)
 	if (WIN32)
-		set(PCRE_URL "https://ftp.pcre.org/pub/pcre/pcre-8.42.tar.gz")
-		if (NOT ${CMAKE_VERSION} VERSION_LESS 3.7)
-			list(APPEND PCRE_URL
-				"http://downloads.sourceforge.net/project/pcre/pcre/8.42/pcre-8.42.tar.gz"
-			)
-		endif()
-		ExternalProject_Add(PCRE
+		ExternalProject_Add(pcre2
 			${EP_CONFIGS}
-			URL ${PCRE_URL}
-			URL_MD5 fc18afa0f14a25475cf097ee102a3e4f
+			${PCRE2_CONFIG}
 			CMAKE_ARGS
 				-G ${CMAKE_GENERATOR}
 				-DCMAKE_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/libs/src/install-prefix
 				-Wno-dev
-				-DPCRE_BUILD_PCRECPP=OFF
-				-DPCRE_BUILD_PCREGREP=OFF
-				-DPCRE_BUILD_TESTS=OFF
-				-DPCRE_SUPPORT_JIT=ON
-				-DPCRE_SUPPORT_UNICODE_PROPERTIES=ON
+				-DPCRE2_BUILD_PCRE2GREP=OFF
+				-DPCRE2_BUILD_TESTS=OFF
+				-DPCRE2_SUPPORT_JIT=ON
+				-DPCRE2_SUPPORT_UNICODE=ON
 		)
-		set(PCRE_LIBRARIES
-			optimized ${CMAKE_BINARY_DIR}/libs/src/install-prefix/lib/pcre.lib
-			debug ${CMAKE_BINARY_DIR}/libs/src/install-prefix/lib/pcred.lib
+		set(PCRE2_LIBRARIES
+			optimized ${CMAKE_BINARY_DIR}/libs/src/install-prefix/lib/pcre2-8.lib
+			debug ${CMAKE_BINARY_DIR}/libs/src/install-prefix/lib/pcre2-8d.lib
 		)
 	else()
 		if (APPLE)
-			set(PCRE_CFLAGS "-w -mmacosx-version-min=${CMAKE_OSX_DEPLOYMENT_TARGET}")
+			set(PCRE2_CFLAGS "-w -mmacosx-version-min=${CMAKE_OSX_DEPLOYMENT_TARGET}")
 		else()
-			set(PCRE_CFLAGS "-w")
+			set(PCRE2_CFLAGS "-w")
 		endif()
-		set(PCRE_LIBRARIES
-			${CMAKE_BINARY_DIR}/libs/src/install-prefix/lib/libpcre.a
+		set(PCRE2_LIBRARIES
+			${CMAKE_BINARY_DIR}/libs/src/install-prefix/lib/libpcre2-8.a
 		)
-		set(PCRE_URL "https://ftp.pcre.org/pub/pcre/pcre-8.40.tar.gz")
-		if (NOT ${CMAKE_VERSION} VERSION_LESS 3.7)
-			list(APPEND PCRE_URL
-				"http://downloads.sourceforge.net/project/pcre/pcre/8.40/pcre-8.40.tar.gz"
-			)
-		endif()
-		ExternalProject_Add(PCRE
+		ExternalProject_Add(pcre2
 			${EP_CONFIGS}
-			URL ${PCRE_URL}
-			URL_MD5 890c808122bd90f398e6bc40ec862102
-			CONFIGURE_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/PCRE &&
+			${PCRE2_CONFIG}
+			CONFIGURE_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/pcre2 &&
+				autoreconf -f -i &&
 				./configure
 					--prefix=${CMAKE_BINARY_DIR}/libs/src/install-prefix
 					--with-pic
-					--enable-unicode-properties
 					--enable-silent-rules
 					--enable-jit
-					--disable-cpp
 					--enable-shared=no
 					--enable-static=yes
 					--silent
-			BUILD_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/PCRE &&
+			BUILD_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/pcre2 &&
 				make "CFLAGS=${PCRE_CFLAGS}"
-			INSTALL_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/PCRE &&
+			INSTALL_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/pcre2 &&
 				make install
-			BYPRODUCTS ${PCRE_LIBRARIES}
+			BYPRODUCTS ${PCRE2_LIBRARIES}
 		)
 	endif()
-	set_target_properties(PCRE PROPERTIES ${EP_PROPS})
-	set(PCRE_INCLUDE_DIRS ${CMAKE_BINARY_DIR}/libs/src/install-prefix/include)
-	add_dependencies(regexp.ndll PCRE)
+	set_target_properties(pcre2 PROPERTIES ${EP_PROPS})
+	set(PCRE2_INCLUDE_DIRS ${CMAKE_BINARY_DIR}/libs/src/install-prefix/include)
+	add_dependencies(regexp.ndll pcre2)
 	# Download project for fat source archive
-	add_dependencies(download_static_deps PCRE-download)
+	add_dependencies(download_deps pcre2-download)
 else()
-	find_package(PCRE REQUIRED)
+	find_package(PCRE2 REQUIRED)
 endif()
 
-target_include_directories(regexp.ndll PRIVATE ${PCRE_INCLUDE_DIRS})
-target_link_libraries(regexp.ndll libneko ${PCRE_LIBRARIES})
+target_include_directories(regexp.ndll PRIVATE ${PCRE2_INCLUDE_DIRS})
+target_link_libraries(regexp.ndll libneko ${PCRE2_LIBRARIES})
 
 set_target_properties(regexp.ndll
 	PROPERTIES
diff --git a/libs/regexp/regexp.c b/libs/regexp/regexp.c
index b0115de..d327fe1 100644
--- a/libs/regexp/regexp.c
+++ b/libs/regexp/regexp.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -21,23 +21,33 @@
  */
 #include <neko.h>
 #include <string.h>
-#define PCRE_STATIC
-#include <pcre.h>
+
+#define PCRE2_CODE_UNIT_WIDTH 8
+
+#ifdef PCRE2_STATIC_LINK
+// this must be defined before loading the pcre header
+#define PCRE2_STATIC
+#endif
+#include <pcre2.h>
 
 #define PCRE(o)		((pcredata*)val_data(o))
 
 typedef struct {
+	// The compiled regex code
+	pcre2_code *regex;
+	// Number of capture groups
+	int n_groups;
+
+	// The last string matched
 	value str;
-	pcre *r;
-	int nmatchs;
-	int *matchs;
+	// Pointer to the allocated memory for match data
+	pcre2_match_data *match_data;
 } pcredata;
 
 DEFINE_KIND(k_regexp);
 
 static field id_pos;
 static field id_len;
-static pcre_extra limit;
 
 /**
 	<doc>
@@ -48,16 +58,18 @@ static pcre_extra limit;
 	</doc>
 **/
 
-static void free_regexp( value p ) {	
-	pcre_free( PCRE(p)->r );
+static void free_regexp( value p ) {
+	pcre2_code_free( PCRE(p)->regex );
+	pcre2_match_data_free( PCRE(p)->match_data );
 }
 
-static int do_exec( pcredata *d, const char *str, int len, int pos ) {
-	int res = pcre_exec(d->r,&limit,str,len,pos,0,d->matchs,d->nmatchs * 3);
+static int do_match( pcredata *d, const char *str, int len, int pos ) {
+	int res = pcre2_match(d->regex,str,len,pos,0,d->match_data,NULL);
 	if( res >= 0 )
 		return 1;
-	if( res != PCRE_ERROR_NOMATCH )
-		val_throw(alloc_string("An error occurred while running pcre_exec"));
+	d->str = val_null; // empty string prevents trying to access the data after a failed match
+	if( res != PCRE2_ERROR_NOMATCH )
+		val_throw(alloc_string("An error occurred while running pcre2_match"));
 	return 0;
 }
 
@@ -78,53 +90,55 @@ static value regexp_new_options( value s, value opt ) {
 	val_check(opt,string);
 	{
 		value v;
-		const char *error;
-		int err_offset;
-		pcre *p;
+		int error_num;
+		size_t err_offset;
+		pcre2_code *p;
 		pcredata *pdata;
 		char *o = val_string(opt);
 		int options = 0;
 		while( *o ) {
 			switch( *o++ ) {
 			case 'i':
-				options |= PCRE_CASELESS;
+				options |= PCRE2_CASELESS;
 				break;
 			case 's':
-				options |= PCRE_DOTALL;
+				options |= PCRE2_DOTALL;
 				break;
 			case 'm':
-				options |= PCRE_MULTILINE;
+				options |= PCRE2_MULTILINE;
 				break;
 			case 'u':
-				options |= PCRE_UTF8;
+				options |= PCRE2_UTF;
 				break;
 			case 'g':
-				options |= PCRE_UNGREEDY;
+				options |= PCRE2_UNGREEDY;
 				break;
 			default:
 				neko_error();
 				break;
 			}
 		}
-		p = pcre_compile(val_string(s),options,&error,&err_offset,NULL);
+		p = pcre2_compile(val_string(s),val_strlen(s),options,&error_num,&err_offset,NULL);
 		if( p == NULL ) {
 			buffer b = alloc_buffer("Regexp compilation error : ");
-			buffer_append(b,error);
+			PCRE2_UCHAR error_buffer[256];
+			pcre2_get_error_message(error_num,error_buffer,sizeof(error_buffer));
+			buffer_append(b,error_buffer);
 			buffer_append(b," in ");
 			val_buffer(b,s);
 			bfailure(b);
 		}
 		v = alloc_abstract(k_regexp,alloc(sizeof(pcredata)));
 		pdata = PCRE(v);
-		pdata->r = p;
+		pdata->regex = p;
 		pdata->str = val_null;
-		pdata->nmatchs = 0;
-		pcre_fullinfo(p,NULL,PCRE_INFO_CAPTURECOUNT,&pdata->nmatchs);
-		pdata->nmatchs++;
-		pdata->matchs = (int*)alloc_private(sizeof(int) * 3 * pdata->nmatchs);
+		pdata->n_groups = 0;
+		pcre2_pattern_info(pdata->regex,PCRE2_INFO_CAPTURECOUNT,&pdata->n_groups);
+		pdata->n_groups++;
+		pdata->match_data = pcre2_match_data_create_from_pattern(pdata->regex,NULL);
 		val_gc(v,free_regexp);
 		return v;
-	}	
+	}
 }
 
 /**
@@ -152,7 +166,7 @@ static value regexp_match( value o, value s, value p, value len ) {
 	if( pp < 0 || ll < 0 || pp > val_strlen(s) || pp + ll > val_strlen(s) )
 		neko_error();
 	d = PCRE(o);
-	if( do_exec(d,val_string(s),ll+pp,pp) ) {
+	if( do_match(d,val_string(s),ll+pp,pp) ) {
 		d->str = s;
 		return val_true;
 	} else {
@@ -161,22 +175,25 @@ static value regexp_match( value o, value s, value p, value len ) {
 	}
 }
 
-static value do_replace( value o, value s, value s2, bool all ) {	
-	val_check_kind(o,k_regexp);	
+static value do_replace( value o, value s, value s2, bool all ) {
+	val_check_kind(o,k_regexp);
 	val_check(s,string);
-	val_check(s2,string);	
+	val_check(s2,string);
 	{
 		pcredata *d = PCRE(o);
 		buffer b = alloc_buffer(NULL);
-		int pos = 0;
-		int len = val_strlen(s);
 		const char *str = val_string(s);
 		const char *str2 = val_string(s2);
+		int len = val_strlen(s);
 		int len2 = val_strlen(s2);
-		while( do_exec(d,str,len,pos) ) {
-			buffer_append_sub(b,str+pos,d->matchs[0] - pos);
+		int pos = 0;
+		size_t *matches;
+		// TODO: Consider pcre2_substitute()
+		while( do_match(d,str,len,pos) ) {
+			matches = pcre2_get_ovector_pointer(d->match_data);
+			buffer_append_sub(b,str+pos,matches[0] - pos);
 			buffer_append_sub(b,str2,len2);
-			pos = d->matchs[1];
+			pos = matches[1];
 			if( !all )
 				break;
 		}
@@ -190,7 +207,7 @@ static value do_replace( value o, value s, value s2, bool all ) {
 	regexp_replace : 'regexp -> from:string -> by:string -> string
 	<doc>Perform a replacement using a regexp</doc>
 **/
-static value regexp_replace( value o, value s, value s2 ) {	
+static value regexp_replace( value o, value s, value s2 ) {
 	return do_replace(o,s,s2,false);
 }
 
@@ -216,11 +233,13 @@ static value regexp_replace_fun( value o, value s, value f ) {
 		int pos = 0;
 		int len = val_strlen(s);
 		const char *str = val_string(s);
+		size_t *matches;
 		d->str = s;
-		while( do_exec(d,str,len,pos) ) {
-			buffer_append_sub(b,str+pos,d->matchs[0] - pos);
+		while( do_match(d,str,len,pos) ) {
+			matches = pcre2_get_ovector_pointer(d->match_data);
+			buffer_append_sub(b,str+pos,matches[0] - pos);
 			val_buffer(b,val_call1(f,o));
-			pos = d->matchs[1];
+			pos = matches[1];
 		}
 		d->str = val_null;
 		buffer_append_sub(b,str+pos,len-pos);
@@ -230,21 +249,22 @@ static value regexp_replace_fun( value o, value s, value f ) {
 
 /**
 	regexp_matched : 'regexp -> n:int -> string?
-	<doc>Return the [n]th matched block by the regexp. If [n] is 0 then return 
+	<doc>Return the [n]th matched block by the regexp. If [n] is 0 then return
 	the whole matched substring. If the [n]th matched block was optional and not matched, returns null</doc>
 **/
 static value regexp_matched( value o, value n ) {
 	pcredata *d;
 	int m;
-	val_check_kind(o,k_regexp);	
+	val_check_kind(o,k_regexp);
 	d = PCRE(o);
 	val_check(n,int);
 	m = val_int(n);
-	if( m < 0 || m >= d->nmatchs || val_is_null(d->str) )
+	if( m < 0 || m >= d->n_groups || val_is_null(d->str) )
 		neko_error();
 	{
-		int start = d->matchs[m*2];
-		int len = d->matchs[m*2+1] - start;
+		size_t *matches = pcre2_get_ovector_pointer(d->match_data);
+		int start = matches[m*2];
+		int len = matches[m*2+1] - start;
 		value str;
 		if( start == -1 )
 			return val_null;
@@ -262,15 +282,16 @@ static value regexp_matched( value o, value n ) {
 static value regexp_matched_pos( value o, value n ) {
 	pcredata *d;
 	int m;
-	val_check_kind(o,k_regexp);	
+	val_check_kind(o,k_regexp);
 	d = PCRE(o);
 	val_check(n,int);
 	m = val_int(n);
-	if( m < 0 || m >= d->nmatchs || val_is_null(d->str) )
+	if( m < 0 || m >= d->n_groups || val_is_null(d->str) )
 		neko_error();
 	{
-		int start = d->matchs[m*2];
-		int len = d->matchs[m*2+1] - start;
+		size_t *matches = pcre2_get_ovector_pointer(d->match_data);
+		int start = matches[m*2];
+		int len = matches[m*2+1] - start;
 		value o = alloc_object(NULL);
 		alloc_field(o,id_pos,alloc_int(start));
 		alloc_field(o,id_len,alloc_int(len));
@@ -278,11 +299,23 @@ static value regexp_matched_pos( value o, value n ) {
 	}
 }
 
+/**
+	regexp_matched_num : 'regexp -> int
+	<doc>Return the total number of matched groups, or -1 if the regexp has not
+	been matched yet</doc>
+**/
+static value regexp_matched_num( value o ) {
+	pcredata *d;
+	val_check_kind(o,k_regexp);
+	d = PCRE(o);
+	if( val_is_null(d->str) )
+		return alloc_int(-1);
+	return alloc_int(d->n_groups);
+}
+
 void regexp_main() {
 	id_pos = val_id("pos");
-	id_len = val_id("len");	
-	limit.flags = PCRE_EXTRA_MATCH_LIMIT_RECURSION;
-	limit.match_limit_recursion = 3500; // adapted based on Windows 1MB stack size
+	id_len = val_id("len");
 }
 
 DEFINE_PRIM(regexp_new,1);
@@ -293,6 +326,7 @@ DEFINE_PRIM(regexp_replace_all,3);
 DEFINE_PRIM(regexp_replace_fun,3);
 DEFINE_PRIM(regexp_matched,2);
 DEFINE_PRIM(regexp_matched_pos,2);
+DEFINE_PRIM(regexp_matched_num,1);
 DEFINE_ENTRY_POINT(regexp_main);
 
 /* ************************************************************************ */
diff --git a/libs/sqlite/CMakeLists.txt b/libs/sqlite/CMakeLists.txt
index b2649e9..a34098a 100644
--- a/libs/sqlite/CMakeLists.txt
+++ b/libs/sqlite/CMakeLists.txt
@@ -24,7 +24,7 @@ if (STATIC_SQLITE3)
 	target_link_libraries(sqlite.ndll libneko)
 	target_compile_definitions(sqlite.ndll PRIVATE SQLITE_MAX_VARIABLE_NUMBER=250000 SQLITE_ENABLE_RTREE=1)
 	# Download project for fat source archive
-	add_dependencies(download_static_deps Sqlite3-download)
+	add_dependencies(download_deps Sqlite3-download)
 else()
 	add_library(sqlite.ndll MODULE sqlite.c)
 	pkg_check_modules(SQLITE3 REQUIRED sqlite3)
diff --git a/libs/sqlite/sqlite.c b/libs/sqlite/sqlite.c
index bc31842..cad7c28 100644
--- a/libs/sqlite/sqlite.c
+++ b/libs/sqlite/sqlite.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -28,7 +28,7 @@
 	<h1>SQLite</h1>
 	<p>
 	Sqlite is a small embeddable SQL database that store all its data into
-	a single file. See http://sqlite.org for more details.
+	a single file. See https://sqlite.org for more details.
 	</p>
 	</doc>
 **/
diff --git a/libs/ssl/CMakeLists.txt b/libs/ssl/CMakeLists.txt
index ac319b4..befc1d2 100644
--- a/libs/ssl/CMakeLists.txt
+++ b/libs/ssl/CMakeLists.txt
@@ -35,8 +35,8 @@ if (STATIC_MBEDTLS)
 	endif()
 	ExternalProject_Add(MbedTLS
 		${EP_CONFIGS}
-		URL https://tls.mbed.org/download/mbedtls-2.13.0-apache.tgz
-		URL_MD5 659d96bb03012ca6db414a9137fcdbd6
+		URL https://github.com/Mbed-TLS/mbedtls/archive/refs/tags/mbedtls-2.13.1.tar.gz
+		URL_MD5 e251b86046db6c05167b5803de9c6694
 		CMAKE_ARGS ${MBEDTLS_CMAKE_ARGS}
 		PATCH_COMMAND ${CMAKE_COMMAND} -Dsource=${CMAKE_SOURCE_DIR} -DMbedTLS_source=${CMAKE_BINARY_DIR}/libs/src/MbedTLS -P ${CMAKE_SOURCE_DIR}/cmake/patch_mbedtls.cmake
 		INSTALL_COMMAND echo skip install
@@ -47,7 +47,7 @@ if (STATIC_MBEDTLS)
 
 	add_dependencies(ssl.ndll MbedTLS)
 	# Download project for fat source archive
-	add_dependencies(download_static_deps MbedTLS-download)
+	add_dependencies(download_deps MbedTLS-download)
 else()
 	find_package(MbedTLS REQUIRED)
 endif()
diff --git a/libs/ssl/ssl.c b/libs/ssl/ssl.c
index c4f5854..6855566 100644
--- a/libs/ssl/ssl.c
+++ b/libs/ssl/ssl.c
@@ -16,7 +16,10 @@ typedef int SOCKET;
 #endif
 
 #ifdef NEKO_MAC
-#include <Security/Security.h>
+#include <CoreFoundation/CoreFoundation.h>
+#include <Security/SecKeychain.h>
+#include <Security/SecItem.h>
+#include <Security/SecCertificate.h>
 #endif
 
 #define SOCKET_ERROR (-1)
diff --git a/libs/std/buffer.c b/libs/std/buffer.c
index dbe7c71..f4039a1 100644
--- a/libs/std/buffer.c
+++ b/libs/std/buffer.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -61,7 +61,7 @@ static value buffer_add_char( value b, value c ) {
 	val_check_kind(b,k_buffer);
 	val_check(c,int);
 	if( val_int(c) < 0 || val_int(c) > 255 )
-		neko_error();	
+		neko_error();
 	buffer_append_char( (buffer)val_data(b), (char)(unsigned char)val_int(c) );
 	return val_true;
 }
@@ -74,7 +74,7 @@ static value buffer_add_sub( value b, value v, value p, value l ) {
 	val_check_kind(b,k_buffer);
 	val_check(v,string);
 	val_check(p,int);
-	val_check(l,int);	
+	val_check(l,int);
 	if( val_int(p) < 0 || val_int(l) < 0 )
 		neko_error();
 	if( val_strlen(v) < val_int(p) || val_strlen(v) < val_int(p) + val_int(l) )
diff --git a/libs/std/date.c b/libs/std/date.c
index 922db74..126926d 100644
--- a/libs/std/date.c
+++ b/libs/std/date.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -135,7 +135,7 @@ static value date_format( value o, value fmt ) {
 	if( localtime_r(&d,&t) == NULL )
 		neko_error();
 	if( strftime(buf,127,val_string(fmt),&t) == 0 )
-		neko_error();		
+		neko_error();
 	return alloc_string(buf);
 }
 
@@ -155,7 +155,7 @@ static value date_utc_format( value o, value fmt ) {
 	if( gmtime_r(&d,&t) == NULL )
 		neko_error();
 	if( strftime(buf,127,val_string(fmt),&t) == 0 )
-		neko_error();		
+		neko_error();
 	return alloc_string(buf);
 }
 
diff --git a/libs/std/file.c b/libs/std/file.c
index 27c7f4c..3e6c31c 100644
--- a/libs/std/file.c
+++ b/libs/std/file.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -53,7 +53,7 @@ static void file_error( const char *msg, fio *f ) {
 /**
 	file_open : f:string -> r:string -> 'file
 	<doc>
-	Call the C function [fopen] with the file path and access rights. 
+	Call the C function [fopen] with the file path and access rights.
 	Return the opened file or throw an exception if the file couldn't be open.
 	</doc>
 **/
@@ -71,9 +71,9 @@ static value file_open( value name, value r ) {
 
 /**
 	file_close : 'file -> void
-	<doc>Close an file. Any other operations on this file will fail</doc> 
+	<doc>Close an file. Any other operations on this file will fail</doc>
 **/
-static value file_close( value o ) {	
+static value file_close( value o ) {
 	fio *f;
 	val_check_kind(o,k_file);
 	f = val_file(o);
@@ -94,7 +94,7 @@ static value file_name( value o ) {
 /**
 	file_write : 'file -> s:string -> p:int -> l:int -> int
 	<doc>
-	Write up to [l] chars of string [s] starting at position [p]. 
+	Write up to [l] chars of string [s] starting at position [p].
 	Returns the number of chars written which is >= 0.
 	</doc>
 **/
@@ -281,7 +281,7 @@ static value file_contents( value name ) {
 		}
 		p += d;
 		len -= d;
-	}	
+	}
 	fclose(f.io);
 	return s;
 }
diff --git a/libs/std/init.c b/libs/std/init.c
index c79a43d..2d6bf76 100644
--- a/libs/std/init.c
+++ b/libs/std/init.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -60,7 +60,7 @@ void std_main() {
 	id_cdata = val_id("cdata");
 	id_doctype = val_id("doctype");
 	id_serialize = val_id("__serialize");
-	id_unserialize = val_id("__unserialize");	
+	id_unserialize = val_id("__unserialize");
 	kind_share(&k_file,"file");
 	kind_share(&k_socket,"socket");
 	kind_share(&k_buffer,"buffer");
diff --git a/libs/std/int32.c b/libs/std/int32.c
index 1b97101..72baa1f 100644
--- a/libs/std/int32.c
+++ b/libs/std/int32.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -57,7 +57,7 @@ static value int32_to_int( value v ) {
 	<doc>Return the float value of the integer.</doc>
 **/
 static value int32_to_float( value v ) {
-	val_check(v,any_int);	
+	val_check(v,any_int);
 	return alloc_float(val_any_int(v));
 }
 
@@ -124,62 +124,62 @@ static value int32_ushr( value v1, value v2 ) {
 	return alloc_best_int(r);
 }
 
-/** 
+/**
 	int32_add : #int32 -> #int32 -> #int32
 	<doc>Add two integers</doc>
 **/
 INT32_OP(add,+);
-/** 
+/**
 	int32_sub : #int32 -> #int32 -> #int32
 	<doc>Subtract two integers</doc>
 **/
 INT32_OP(sub,-);
-/** 
+/**
 	int32_mul : #int32 -> #int32 -> #int32
 	<doc>Multiply two integers</doc>
 **/
 INT32_OP(mul,*);
-/** 
+/**
 	int32_div : #int32 -> #int32 -> #int32
 	<doc>Divide two integers. Error on division by 0</doc>
 **/
 INT32_OP_ZERO(div,/);
-/** 
+/**
 	int32_shl : #int32 -> #int32 -> #int32
 	<doc>Perform left bit-shifting</doc>
 **/
 INT32_OP(shl,<<);
-/** 
+/**
 	int32_shr : #int32 -> #int32 -> #int32
 	<doc>Perform right bit-shifting</doc>
 **/
 INT32_OP(shr,>>);
-/** 
+/**
 	int32_mod : #int32 -> #int32 -> #int32
 	<doc>Return the modulo of one integer by the other. Error on modulo by 0</doc>
 **/
 INT32_OP_ZERO(mod,%);
-/** 
+/**
 	int32_neg : #int32 -> #int32
 	<doc>Return the negative value of an integer</doc>
 **/
 INT32_UNOP(neg,-);
-/** 
+/**
 	int32_complement : #int32 -> #int32
 	<doc>Return the one-complement bitwised integer</doc>
 **/
 INT32_UNOP(complement,~);
-/** 
+/**
 	int32_or : #int32 -> #int32 -> #int32
 	<doc>Return the bitwise or of two integers</doc>
 **/
 INT32_OP(or,|);
-/** 
+/**
 	int32_and : #int32 -> #int32 -> #int32
 	<doc>Return the bitwise and of two integers</doc>
 **/
 INT32_OP(and,&);
-/** 
+/**
 	int32_xor : #int32 -> #int32 -> #int32
 	<doc>Return the bitwise xor of two integers</doc>
 **/
@@ -188,7 +188,7 @@ INT32_OP(xor,^);
 /**
 	int32_address : any -> #int32
 	<doc>
-	Return the address of the value. 
+	Return the address of the value.
 	The address should not be considered constant. It is not unique
 	either unless you are sure you are running on a 32-bit platform.
 	</doc>
diff --git a/libs/std/math.c b/libs/std/math.c
index d4f362f..45cf3f6 100644
--- a/libs/std/math.c
+++ b/libs/std/math.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -74,7 +74,7 @@ static value math_abs( value n ) {
 	case VAL_INT32:
 		return alloc_int32( abs(val_int32(n)) );
 	case VAL_FLOAT:
-		return alloc_float( fabs(val_float(n)) ); 
+		return alloc_float( fabs(val_float(n)) );
 	default:
 		neko_error();
 	}
diff --git a/libs/std/md5.c b/libs/std/md5.c
index 85fef24..8ecfc5b 100644
--- a/libs/std/md5.c
+++ b/libs/std/md5.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -143,7 +143,7 @@ static void md5_process( md5_context *ctx, uint8 data[64] ) {
     P( B, C, D, A, 12, 20, 0x8D2A4C8A );
 
 #undef F
-    
+
 #define F(x,y,z) (x ^ y ^ z)
 
     P( A, B, C, D,  5,  4, 0xFFFA3942 );
@@ -272,16 +272,16 @@ typedef struct stack {
 // build some integers that are not neko ones (last bit at 0)
 // this reduce the possible collisions.
 // bit 0 = 0
-// bit 1-2 = 
+// bit 1-2 =
 //		00 : const (null, true, false, abstract)
 //		01 : ref
 //      10 : fun
 //		11 : array
 //
-// md5-similar objects can still be forged, in particular 
+// md5-similar objects can still be forged, in particular
 // due to the fact that no special flag is added to the string
 // digest in order to keep compatibility with standard md5
-// implementation. 
+// implementation.
 //
 // For example md5(null) == md5("\000\000\000\000")
 
diff --git a/libs/std/memory.c b/libs/std/memory.c
index 6d69b3d..868c5db 100644
--- a/libs/std/memory.c
+++ b/libs/std/memory.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/std/misc.c b/libs/std/misc.c
index dfed258..bdef7be 100644
--- a/libs/std/misc.c
+++ b/libs/std/misc.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -161,12 +161,12 @@ static value test() {
 /**
 	print_redirect : function:1? -> void
 	<doc>
-	Set a redirection function for all printed values. 
+	Set a redirection function for all printed values.
 	Setting it to null will cancel the redirection and restore previous printer.
 	</doc>
 **/
 
-static void print_callback( const char *s, int size, void *f ) {	
+static void print_callback( const char *s, int size, void *f ) {
 	val_call1(f,copy_string(s,size));
 }
 
diff --git a/libs/std/module.c b/libs/std/module.c
index 824aaab..241ce18 100644
--- a/libs/std/module.c
+++ b/libs/std/module.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/std/process.c b/libs/std/process.c
index 78063c1..3cafe5d 100644
--- a/libs/std/process.c
+++ b/libs/std/process.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -27,6 +27,7 @@
 #	include <sys/types.h>
 #	include <unistd.h>
 #	include <errno.h>
+#	include <signal.h>
 #	if !defined(NEKO_MAC)
 #		if defined(NEKO_BSD)
 #			include <sys/wait.h>
@@ -96,7 +97,7 @@ static void free_process( value vp ) {
 	<doc>
 	Start a process using a command and the specified arguments.
 	When args is not null, cmd and args will be auto-quoted/escaped.
-	If no auto-quoting/escaping is desired, you should append necessary 
+	If no auto-quoting/escaping is desired, you should append necessary
 	arguments to cmd as if it is inputted to the shell directly, and pass
 	null as args.
 	</doc>
@@ -110,8 +111,8 @@ static value process_run( value cmd, value vargs ) {
 		val_check(vargs,array);
 	}
 #	ifdef NEKO_WINDOWS
-	{		 
-		SECURITY_ATTRIBUTES sattr;		
+	{
+		SECURITY_ATTRIBUTES sattr;
 		STARTUPINFO sinf;
 		HANDLE proc = GetCurrentProcess();
 		HANDLE oread,eread,iwrite;
@@ -189,7 +190,7 @@ static value process_run( value cmd, value vargs ) {
 		CloseHandle(oread);
 		CloseHandle(eread);
 		CloseHandle(iwrite);
-		if( !CreateProcess(NULL,val_string(sargs),NULL,NULL,TRUE,0,NULL,NULL,&sinf,&p->pinf) )			
+		if( !CreateProcess(NULL,val_string(sargs),NULL,NULL,TRUE,0,NULL,NULL,&sinf,&p->pinf) )
 			neko_error();
 		// close unused pipes
 		CloseHandle(sinf.hStdOutput);
@@ -439,7 +440,7 @@ static value process_pid( value vp ) {
 	Close the process I/O.
 	</doc>
 **/
-static value process_close( value vp ) {	
+static value process_close( value vp ) {
 	val_check_kind(vp,k_process);
 	free_process(vp);
 	val_kind(vp) = NULL;
diff --git a/libs/std/random.c b/libs/std/random.c
index 932304e..23a73f4 100644
--- a/libs/std/random.c
+++ b/libs/std/random.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -52,7 +52,7 @@ struct _rnd {
 	unsigned long cur;
 };
 
-static unsigned long mag01[2]={ 
+static unsigned long mag01[2]={
 	0x0, 0x8ebfd028 // magic, don't change
 };
 
@@ -86,7 +86,7 @@ static rnd *rnd_init( void *data ) {
 	struct timeval t;
 	gettimeofday(&t,NULL);
 	time = t.tv_sec * 1000000 + t.tv_usec;
-#endif	
+#endif
 	rnd_set_seed(r,time ^ (pid | (pid << 16)));
 	return r;
 }
@@ -97,9 +97,9 @@ static unsigned int rnd_int( rnd *r ) {
     if( pos >= NSEEDS ) {
 		int kk;
 		for(kk=0;kk<NSEEDS-MAX;kk++)
-			r->seeds[kk] = r->seeds[kk+MAX] ^ (r->seeds[kk] >> 1) ^ mag01[r->seeds[kk] % 2];		
+			r->seeds[kk] = r->seeds[kk+MAX] ^ (r->seeds[kk] >> 1) ^ mag01[r->seeds[kk] % 2];
 		for(;kk<NSEEDS;kk++)
-			r->seeds[kk] = r->seeds[kk+(MAX-NSEEDS)] ^ (r->seeds[kk] >> 1) ^ mag01[r->seeds[kk] % 2];      
+			r->seeds[kk] = r->seeds[kk+(MAX-NSEEDS)] ^ (r->seeds[kk] >> 1) ^ mag01[r->seeds[kk] % 2];
 		r->cur = 1;
 		pos = 0;
 	}
@@ -111,7 +111,7 @@ static unsigned int rnd_int( rnd *r ) {
 }
 
 static double rnd_float( rnd *r ) {
-	double big = 4294967296.0;	
+	double big = 4294967296.0;
 	return ((rnd_int(r) / big + rnd_int(r)) / big + rnd_int(r)) / big;
 }
 
diff --git a/libs/std/serialize.c b/libs/std/serialize.c
index 24a37b3..ac829d1 100644
--- a/libs/std/serialize.c
+++ b/libs/std/serialize.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/std/socket.c b/libs/std/socket.c
index d5d922e..9798d97 100644
--- a/libs/std/socket.c
+++ b/libs/std/socket.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -61,7 +61,7 @@
 #	define EPOLLOUT 0x004
 #endif
 
-#if defined(NEKO_WINDOWS) || defined(NEKO_MAC)
+#ifndef MSG_NOSIGNAL
 #	define MSG_NOSIGNAL 0
 #endif
 
diff --git a/libs/std/string.c b/libs/std/string.c
index 3956538..a6296bb 100644
--- a/libs/std/string.c
+++ b/libs/std/string.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/std/sys.c b/libs/std/sys.c
index 1a7ce00..6c70028 100644
--- a/libs/std/sys.c
+++ b/libs/std/sys.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -85,20 +85,28 @@ static value get_env( value v ) {
 	<doc>Set some environment variable value</doc>
 **/
 static value put_env( value e, value v ) {
+	val_check(e,string);
+	bool is_null = val_is_null(v);
 #ifdef NEKO_WINDOWS
 	buffer b;
-	val_check(e,string);
-	val_check(v,string);
+	if( !is_null )
+		val_check(v,string);
 	b = alloc_buffer(NULL);
 	val_buffer(b,e);
 	buffer_append_sub(b,"=",1);
-	val_buffer(b,v);
+	if( !is_null )
+		val_buffer(b,v);
 	if( putenv(val_string(buffer_to_string(b))) != 0 )
 		neko_error();
 #else
-	val_check(e,string);
-	val_check(v,string);
-	if( setenv(val_string(e),val_string(v),1) != 0 )
+	int result;
+	if( is_null )
+		result = unsetenv(val_string(e));
+	else {
+		val_check(v,string);
+		result = setenv(val_string(e),val_string(v),1);
+	}
+	if( result != 0 )
 		neko_error();
 #endif
 	return val_true;
@@ -225,6 +233,32 @@ static value sys_is64() {
 #endif
 }
 
+/**
+	sys_cpu_arch : void -> string
+	<doc>
+	Returns the cpu architecture. Current possible values:
+	<ul>
+	<li>[x86_64]</li>
+	<li>[x86]</li>
+	<li>[arm64]</li>
+	<li>[arm]</li>
+	</ul>
+	</doc>
+**/
+static value sys_cpu_arch() {
+#if defined(__x86_64__) || defined(_M_AMD64)
+	return alloc_string("x86_64");
+#elif defined(__i386__) || defined(_M_IX86)
+	return alloc_string("x86");
+#elif defined(__aarch64__) || defined(_M_ARM64)
+	return alloc_string("arm64");
+#elif defined(__arm__) || defined(_M_ARM)
+	return alloc_string("arm");
+#else
+#error Unknown CPU architecture
+#endif
+}
+
 /**
 	sys_command : string -> int
 	<doc>Run the shell command and return exit code</doc>
@@ -695,6 +729,7 @@ DEFINE_PRIM(sys_command,1);
 DEFINE_PRIM(sys_exit,1);
 DEFINE_PRIM(sys_string,0);
 DEFINE_PRIM(sys_is64,0);
+DEFINE_PRIM(sys_cpu_arch,0);
 DEFINE_PRIM(sys_stat,1);
 DEFINE_PRIM(sys_time,0);
 DEFINE_PRIM(sys_cpu_time,0);
diff --git a/libs/std/thread.c b/libs/std/thread.c
index 3cd77ba..26c4091 100644
--- a/libs/std/thread.c
+++ b/libs/std/thread.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -258,7 +258,7 @@ static value thread_create( value f, value param ) {
 	p = (tparams*)alloc(sizeof(tparams));
 	p->callb = f;
 	p->callparam = param;
-	p->jit = neko_vm_jit(neko_vm_current(),-1);	
+	p->jit = neko_vm_jit(neko_vm_current(),-1);
 	if( !neko_thread_create(thread_init,thread_loop,p,&p->handle) )
 		neko_error();
 	return p->t->v;
@@ -566,7 +566,7 @@ static value mutex_acquire( value m ) {
 **/
 static value mutex_try( value m ) {
 	val_check_kind(m,k_mutex);
-	return alloc_bool( neko_lock_try(val_mutex(m)) );	
+	return alloc_bool( neko_lock_try(val_mutex(m)) );
 }
 
 /**
@@ -582,7 +582,7 @@ static value mutex_release( value m ) {
 	return val_null;
 }
 
-static void free_deque( value v ) {	
+static void free_deque( value v ) {
 	_deque_destroy(val_deque(v));
 }
 
diff --git a/libs/std/unicode.c b/libs/std/unicode.c
index e327172..ad43bfe 100644
--- a/libs/std/unicode.c
+++ b/libs/std/unicode.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -26,8 +26,8 @@
 	<doc>
 	<h1>Unicode</h1>
 	<p>
-	Operations on Unicode strings. 
-	Most of the operations are optimized for speed so they might still 
+	Operations on Unicode strings.
+	Most of the operations are optimized for speed so they might still
 	succeed on some malformed Unicode string. The only function that completely
 	check the Unicode format is [unicode_validate]. Other functions might raise
 	some exception or not depending on the malformed data.
@@ -362,7 +362,7 @@ static void unicode_buf_resize( uni_buf *b ) {
 	if( size2 - len < 10 ) size2 = 10 + len;
 	s = alloc_empty_string(size2);
 	memcpy(val_string(s),val_string(b->buf),len);
-	b->buf = s;	
+	b->buf = s;
 }
 
 
@@ -392,7 +392,7 @@ static value unicode_buf_add( value buf, value uc ) {
 	<doc>
 	Return the current content of the buffer.
 	This is not a copy of the buffer but the shared content.
-	Retreiving content and then continuing to add chars is 
+	Retreiving content and then continuing to add chars is
 	possible but not very efficient.
 	</doc>
 **/
@@ -455,10 +455,10 @@ static value unicode_validate( value str, value encoding ) {
 		return alloc_bool((l & 1) == 0);
 	case UTF32_LE:
 		if( l >= 4 && s[0] == 0 && s[1] == 0 && s[2] == 0xFE && s[3] == 0xFF ) return val_false; // BOM fail
-		return alloc_bool((l & 3) == 0);	
+		return alloc_bool((l & 3) == 0);
 	case UTF32_BE:
 		if( l >= 4 && s[0] == 0xFF && s[1] == 0xFE && s[2] == 0 && s[3] == 0 ) return val_false; // BOM fail
-		return alloc_bool((l & 3) == 0);	
+		return alloc_bool((l & 3) == 0);
 	case UTF16_LE:
 		if( s[0] == 0xFE && s[1] == 0xFF ) return val_false; // BOM fail
 		{
@@ -468,7 +468,7 @@ static value unicode_validate( value str, value encoding ) {
 			unsigned short c = *(unsigned short*)s;
 			if( ((c >> dec) & 0xFC) == 0xD8 ) {
 				if( s + 3 >= end ) return val_false;
-				if( ((((unsigned short*)s)[1] >> dec) & 0xFC) != 0xDC ) return val_false;			
+				if( ((((unsigned short*)s)[1] >> dec) & 0xFC) != 0xDC ) return val_false;
 				s += 4;
 			} else
 				s += 2;
@@ -600,7 +600,7 @@ static value unicode_sub( value str, value enc, value vpos, value vlen ) {
 
 /**
 	unicode_get : string -> encoding:int -> n:int -> int
-	<doc>Returns the [n]th char in an Unicode string. 
+	<doc>Returns the [n]th char in an Unicode string.
 	This might be inefficient if [n] is big and the string has variable length per char.</doc>
 **/
 static value unicode_get( value str, value enc, value pos ) {
@@ -798,7 +798,7 @@ static value unicode_convert( value str, value encoding, value to_encoding ) {
 	if( e == e_to )
 		return str;
 	// try to allocate enough space at first guess
-	switch( e ) {	
+	switch( e ) {
 	case ISO_LATIN1:
 	case UTF8:
 	case ASCII:
diff --git a/libs/std/utf8.c b/libs/std/utf8.c
index 5d44f3d..944a4b7 100644
--- a/libs/std/utf8.c
+++ b/libs/std/utf8.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -27,8 +27,8 @@
 	<doc>
 	<h1>UTF8</h1>
 	<p>
-	Operations on UTF8 strings. 
-	Most of the operations are optimized for speed so they might still 
+	Operations on UTF8 strings.
+	Most of the operations are optimized for speed so they might still
 	succeed on some malformed UTF8 string. The only function that completely
 	check the UTF8 format is [utf8_validate]. Other functions might raise
 	some exception or not depending on the malformed data.
@@ -71,7 +71,7 @@ static void utf8_buf_resize( ubuf *b ) {
 		nbytes = 10;
 	s = alloc_empty_string(len+nbytes);
 	memcpy(val_string(s),val_string(b->buf),len);
-	b->buf = s;	
+	b->buf = s;
 }
 
 
@@ -92,7 +92,7 @@ static value utf8_buf_add( value buf, value uchar ) {
 			utf8_buf_resize(b);
 		val_string(b->buf)[b->pos++] = (char)c;
 		return val_true;
-	}	
+	}
 	if( b->pos + 4 > val_strlen(b->buf) )
 		utf8_buf_resize(b);
 	s = (unsigned char*)val_string(b->buf);
@@ -121,7 +121,7 @@ static value utf8_buf_add( value buf, value uchar ) {
 	<doc>
 	Return the current content of the buffer.
 	This is not a copy of the buffer but the shared content.
-	Retreiving content and then continuing to add chars is 
+	Retreiving content and then continuing to add chars is
 	possible but not very efficient.
 	</doc>
 **/
@@ -298,7 +298,7 @@ static value utf8_sub( value str, value pos, value len ) {
 
 /**
 	utf8_get : string -> n:int -> int
-	<doc>Returns the [n]th char in an UTF8 string. 
+	<doc>Returns the [n]th char in an UTF8 string.
 	This might be inefficient if [n] is big.</doc>
 **/
 static value utf8_get( value str, value pos ) {
diff --git a/libs/std/xml.c b/libs/std/xml.c
index 24c8d7f..4637010 100644
--- a/libs/std/xml.c
+++ b/libs/std/xml.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/libs/ui/CMakeLists.txt b/libs/ui/CMakeLists.txt
index 72b37ba..e53b77c 100644
--- a/libs/ui/CMakeLists.txt
+++ b/libs/ui/CMakeLists.txt
@@ -11,12 +11,12 @@ if(APPLE)
 	find_library(CARBON_LIBRARY Carbon REQUIRED)
 	target_link_libraries(ui.ndll ${CARBON_LIBRARY})
 elseif(UNIX)
-	pkg_check_modules(GTK2 REQUIRED gtk+-2.0)
+	pkg_check_modules(GTK3 REQUIRED gtk+-3.0)
 	target_include_directories(ui.ndll PRIVATE
-		${GTK2_INCLUDEDIR}
-		${GTK2_INCLUDE_DIRS}
+		${GTK3_INCLUDEDIR}
+		${GTK3_INCLUDE_DIRS}
 	)
-	target_link_libraries(ui.ndll ${GTK2_LIBRARIES})
+	target_link_libraries(ui.ndll ${GTK3_LIBRARIES})
 endif()
 
 set_target_properties(ui.ndll
diff --git a/libs/ui/ui.c b/libs/ui/ui.c
index 334567e..a39e090 100644
--- a/libs/ui/ui.c
+++ b/libs/ui/ui.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -36,6 +36,8 @@
 #	define UIEvent		0xFFFFAA00
 #	define eCall		0x0
 enum { pFunc = 'func' };
+extern void RunApplicationEventLoop(void);
+extern void QuitApplicationEventLoop(void);
 #else
 #	include <gtk/gtk.h>
 #	include <glib.h>
@@ -48,7 +50,7 @@ enum { pFunc = 'func' };
 	<h1>UI</h1>
 	<p>
 	Core native User Interface support. This API uses native WIN32 API on Windows,
-	Carbon API on OSX, and GTK2 on Linux.
+	Carbon API on OSX, and GTK3 on Linux.
 	</p>
 	</doc>
 **/
@@ -248,7 +250,7 @@ static value ui_sync( value f ) {
 	// however the GTK lock mechanism is a LOT slower than
 	// using a pthread_mutex
 	pthread_mutex_lock(&data.lock);
-	gtk_timeout_add( 0, onSyncCall, (gpointer)r );
+	gdk_threads_add_timeout( 0, onSyncCall, (gpointer)r );
 	pthread_mutex_unlock(&data.lock);
 #	endif
 	return val_null;
diff --git a/libs/zlib/CMakeLists.txt b/libs/zlib/CMakeLists.txt
index c95e969..5ec0252 100644
--- a/libs/zlib/CMakeLists.txt
+++ b/libs/zlib/CMakeLists.txt
@@ -39,8 +39,10 @@ if (STATIC_ZLIB)
 
 	ExternalProject_Add(Zlib
 		${EP_CONFIGS}
-		URL http://zlib.net/zlib-1.2.11.tar.gz
-		URL_MD5 1c9f62f0778697a09d36121ead88e08e
+		URL
+			https://zlib.net/fossils/zlib-1.2.13.tar.gz
+			https://github.com/madler/zlib/releases/download/v1.2.13/zlib-1.2.13.tar.gz
+		URL_MD5 9b8aa094c4e5765dabf4da391f00d15c
 		CMAKE_ARGS ${ZLIB_CMAKE_ARGS}
 		INSTALL_COMMAND cd ${CMAKE_BINARY_DIR}/libs/src/Zlib-build &&
 			${CMAKE_COMMAND} --build . --target install --config ${config}
@@ -51,7 +53,7 @@ if (STATIC_ZLIB)
 	add_dependencies(zlib.ndll Zlib)
 	target_include_directories(zlib.ndll PRIVATE ${ZLIB_INCLUDE_DIRS})
 	# Download project for fat source archive
-	add_dependencies(download_static_deps Zlib-download)
+	add_dependencies(download_deps Zlib-download)
 else()
 	pkg_check_modules(ZLIB REQUIRED zlib)
 	target_include_directories(zlib.ndll PRIVATE ${ZLIB_INCLUDEDIR} ${ZLIB_INCLUDE_DIRS})
diff --git a/libs/zlib/zlib.c b/libs/zlib/zlib.c
index afab36d..1ab06bd 100644
--- a/libs/zlib/zlib.c
+++ b/libs/zlib/zlib.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Args.nml b/src/core/Args.nml
index 1734516..b90bc28 100644
--- a/src/core/Args.nml
+++ b/src/core/Args.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Array.nml b/src/core/Array.nml
index 67ef2ad..f8a43a9 100644
--- a/src/core/Array.nml
+++ b/src/core/Array.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Buffer.nml b/src/core/Buffer.nml
index 220a909..ad8fb67 100644
--- a/src/core/Buffer.nml
+++ b/src/core/Buffer.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Core.nml b/src/core/Core.nml
index 2eb4407..a111cd6 100644
--- a/src/core/Core.nml
+++ b/src/core/Core.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Hashtbl.nml b/src/core/Hashtbl.nml
index 2abab8e..439564c 100644
--- a/src/core/Hashtbl.nml
+++ b/src/core/Hashtbl.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/IO.nml b/src/core/IO.nml
index 31cc83d..04bd063 100644
--- a/src/core/IO.nml
+++ b/src/core/IO.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/LexEngine.nml b/src/core/LexEngine.nml
index 3294e81..ce61279 100644
--- a/src/core/LexEngine.nml
+++ b/src/core/LexEngine.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Lexer.nml b/src/core/Lexer.nml
index c588d89..26e690e 100644
--- a/src/core/Lexer.nml
+++ b/src/core/Lexer.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/List.nml b/src/core/List.nml
index e6ac8b1..affbb0d 100644
--- a/src/core/List.nml
+++ b/src/core/List.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Map.nml b/src/core/Map.nml
index a69336c..400d1e2 100644
--- a/src/core/Map.nml
+++ b/src/core/Map.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Math.nml b/src/core/Math.nml
index 00c1541..de364ac 100644
--- a/src/core/Math.nml
+++ b/src/core/Math.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Net.nml b/src/core/Net.nml
index 76125b5..2416625 100644
--- a/src/core/Net.nml
+++ b/src/core/Net.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -69,9 +69,9 @@ function socket_select( read : socket array, write : socket array, others : sock
 }
 
 function socket_io(s) {
-	(IO.create_in 
-		(function() { 
-			try socket_recv_char s 
+	(IO.create_in
+		(function() {
+			try socket_recv_char s
 			catch { e -> throw IO.Eof }
 		})
 		(function(b,p,l) {
diff --git a/src/core/Reflect.nml b/src/core/Reflect.nml
index dd4cac9..f6802b3 100644
--- a/src/core/Reflect.nml
+++ b/src/core/Reflect.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Regexp.nml b/src/core/Regexp.nml
index f546c40..e7d4eff 100644
--- a/src/core/Regexp.nml
+++ b/src/core/Regexp.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Set.nml b/src/core/Set.nml
index 91c3390..bc25ad1 100644
--- a/src/core/Set.nml
+++ b/src/core/Set.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Stack.nml b/src/core/Stack.nml
index 7b95ddc..e21033a 100644
--- a/src/core/Stack.nml
+++ b/src/core/Stack.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/String.nml b/src/core/String.nml
index c633b39..a1cdd17 100644
--- a/src/core/String.nml
+++ b/src/core/String.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Sys.nml b/src/core/Sys.nml
index 683f1ef..43a97be 100644
--- a/src/core/Sys.nml
+++ b/src/core/Sys.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Xml.nml b/src/core/Xml.nml
index 16a6fac..83fbc75 100644
--- a/src/core/Xml.nml
+++ b/src/core/Xml.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/core/Zip.nml b/src/core/Zip.nml
index ff50fa1..43e825e 100644
--- a/src/core/Zip.nml
+++ b/src/core/Zip.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/mtypes/std.neko b/src/mtypes/std.neko
index 6851d1c..f9841c3 100644
--- a/src/mtypes/std.neko
+++ b/src/mtypes/std.neko
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/neko/Ast.nml b/src/neko/Ast.nml
index 8cb50b7..abd2f3b 100644
--- a/src/neko/Ast.nml
+++ b/src/neko/Ast.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/neko/Binast.nml b/src/neko/Binast.nml
index df0e4f6..efb68bb 100644
--- a/src/neko/Binast.nml
+++ b/src/neko/Binast.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -19,7 +19,7 @@
  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
  * DEALINGS IN THE SOFTWARE.
  */
- 
+
 open Lexer;
 open Neko.Ast;
 
diff --git a/src/neko/Bytecode.nml b/src/neko/Bytecode.nml
index 28717de..8f9d536 100644
--- a/src/neko/Bytecode.nml
+++ b/src/neko/Bytecode.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/neko/Compile.nml b/src/neko/Compile.nml
index 13cbdba..ecba715 100644
--- a/src/neko/Compile.nml
+++ b/src/neko/Compile.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -19,7 +19,7 @@
  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
  * DEALINGS IN THE SOFTWARE.
  */
- 
+
 open Lexer;
 open Neko.Ast;
 open Neko.Bytecode;
diff --git a/src/neko/Console.nml b/src/neko/Console.nml
index 453bbcb..621b35e 100644
--- a/src/neko/Console.nml
+++ b/src/neko/Console.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/neko/Doc.nml b/src/neko/Doc.nml
index 974dc99..c9eb1d9 100644
--- a/src/neko/Doc.nml
+++ b/src/neko/Doc.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/neko/Lexer.nml b/src/neko/Lexer.nml
index 897cddf..296c5a3 100644
--- a/src/neko/Lexer.nml
+++ b/src/neko/Lexer.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -19,7 +19,7 @@
  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
  * DEALINGS IN THE SOFTWARE.
  */
- 
+
 open Neko.Ast;
 
 type error_msg {
diff --git a/src/neko/Linker.nml b/src/neko/Linker.nml
index f76d126..7ff0a14 100644
--- a/src/neko/Linker.nml
+++ b/src/neko/Linker.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -19,7 +19,7 @@
  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
  * DEALINGS IN THE SOFTWARE.
  */
- 
+
 open Neko.Bytecode;
 
 type context {
@@ -104,7 +104,7 @@ function rec do_link(ctx,module) {
 	Hashtbl.add ctx.loaded module None;
 	var nops = Array.length opcodes;
 	var opmap = Array.make nops (-1);
-	var debug = match *debug { 
+	var debug = match *debug {
 		| None -> Array.make (nops*2) (module_fid,0)
 		| Some(files,inf) ->
 			var fmap = Array.map (function(f) {
diff --git a/src/neko/Main.nml b/src/neko/Main.nml
index a46b860..79da88b 100644
--- a/src/neko/Main.nml
+++ b/src/neko/Main.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -135,7 +135,8 @@ function complete(dir) {
 
 try {
 	var v = Sys.version;
-	var head = "Neko Compiler v" + v.maj + "." + v.min + "." + v.build + " - (c)2005-2017 Haxe Foundation\n Usage : neko [options] files...";
+	var year : int = neko "$neko_build_year()";
+	var head = "Neko Compiler v" + v.maj + "." + v.min + "." + v.build + " - (c)2005-" + year + " Haxe Foundation\n Usage : nekoc [options] files...";
 	var link = &None;
 	var links = &[];
 	var version = &0;
diff --git a/src/neko/Parser.nml b/src/neko/Parser.nml
index ea8101a..556cb5c 100644
--- a/src/neko/Parser.nml
+++ b/src/neko/Parser.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -19,7 +19,7 @@
  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
  * DEALINGS IN THE SOFTWARE.
  */
- 
+
 open Lexer;
 open Neko.Ast;
 
diff --git a/src/neko/Printer.nml b/src/neko/Printer.nml
index 41dd276..3d67b95 100644
--- a/src/neko/Printer.nml
+++ b/src/neko/Printer.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/neko/Xml.nml b/src/neko/Xml.nml
index 8e6822e..1ed02f0 100644
--- a/src/neko/Xml.nml
+++ b/src/neko/Xml.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -19,7 +19,7 @@
  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
  * DEALINGS IN THE SOFTWARE.
  */
- 
+
 open Lexer;
 open Neko.Ast;
 open Xml;
diff --git a/src/nekoml/Ast.nml b/src/nekoml/Ast.nml
index e7e7021..efaf3f0 100644
--- a/src/nekoml/Ast.nml
+++ b/src/nekoml/Ast.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/nekoml/Lexer.nml b/src/nekoml/Lexer.nml
index eaae44b..0457454 100644
--- a/src/nekoml/Lexer.nml
+++ b/src/nekoml/Lexer.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/nekoml/Main.nml b/src/nekoml/Main.nml
index c786870..c6062b2 100644
--- a/src/nekoml/Main.nml
+++ b/src/nekoml/Main.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -77,7 +77,8 @@ exception FileNotFound : string;
 
 try {
 	var v = Sys.version;
-	var head = "NekoML Compiler v" + v.maj + "." + v.min + "." + v.build + " - (c)2005-2017 Haxe Foundation\n Usage : nekoml [options] files...";
+	var year : int = neko "$neko_build_year()";
+	var head = "NekoML Compiler v" + v.maj + "." + v.min + "." + v.build + " - (c)2005-" + year + " Haxe Foundation\n Usage : nekoml [options] files...";
 	var path = &[""];
 	var files = &[];
 	var neko = &false;
diff --git a/src/nekoml/Match.nml b/src/nekoml/Match.nml
index 8da40f7..5096af4 100644
--- a/src/nekoml/Match.nml
+++ b/src/nekoml/Match.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -23,10 +23,10 @@
 /* -----
 	We're using the same algorithm and source code as described in
 	chapter 5.2.4 of "The Zinc experiment" by X. Leroy
-	( http://citeseer.ist.psu.edu/leroy90zinc.html )
+	( https://citeseer.ist.psu.edu/viewdoc/summary?doi=10.1.1.43.6772 )
 	also described in "The Implementation of Functional Programming Languages"
 	by Simon Peyton Jones, in the Chapter 5 by Philip Wadler
-	( http://research.microsoft.com/Users/simonpj/Papers/slpj-book-1987/ )
+	( https://www.microsoft.com/en-us/research/publication/the-implementation-of-functional-programming-languages/ )
 */
 
 open Nekoml.Ast;
diff --git a/src/nekoml/Neko.nml b/src/nekoml/Neko.nml
index 2523556..e674dd5 100644
--- a/src/nekoml/Neko.nml
+++ b/src/nekoml/Neko.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/nekoml/Parser.nml b/src/nekoml/Parser.nml
index f4099a9..8c67737 100644
--- a/src/nekoml/Parser.nml
+++ b/src/nekoml/Parser.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/nekoml/Type.nml b/src/nekoml/Type.nml
index 8b84e06..0d76fa0 100644
--- a/src/nekoml/Type.nml
+++ b/src/nekoml/Type.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/nekoml/Typer.nml b/src/nekoml/Typer.nml
index c38c11e..39a879d 100644
--- a/src/nekoml/Typer.nml
+++ b/src/nekoml/Typer.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/src/tools/Tools.nml b/src/tools/Tools.nml
index f2c5fb8..fd6f1e0 100644
--- a/src/tools/Tools.nml
+++ b/src/tools/Tools.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -30,18 +30,22 @@ function invalid_arg(f) {
 }
 
 try {
-	var head = "Neko Tools v1.0 - (c)2005-2017 Haxe Foundation\nUsage : nekotools [options]";
+	var year : int = neko "$neko_build_year()";
+	var head = "Neko Tools v1.0 - (c)2005-" + year + " Haxe Foundation\nUsage : nekotools [options]";
 	var decl = [
 		("server", Args.Void (function() {
 			erase_argument();
 			WebServer.init();
 			throw Done
 		}) , " : start a neko web server");
+		("boot", Args.String (function(_) {
+			// separated from boot -c only for help message
+		}) , "<file.n> : build a standalone executable");
 		("boot", Args.String (function(_) {
 			erase_argument();
 			neko "$loader.loadmodule('tools/nekoboot',$loader)";
 			throw Done;
-		}) , "<file.n> : build an standalone executable");
+		}) , "-c <file.n> : build a standalone c program");
 	];
 	Args.parse head decl invalid_arg;
 } catch {
diff --git a/src/tools/WebServer.nml b/src/tools/WebServer.nml
index 60a3824..63cda16 100644
--- a/src/tools/WebServer.nml
+++ b/src/tools/WebServer.nml
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -19,7 +19,7 @@
  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
  * DEALINGS IN THE SOFTWARE.
  */
- 
+
 type main_function;
 
 type client {
@@ -56,7 +56,7 @@ function sys_is_file(file) {
 	neko "$loader.loadprim('std@sys_file_type',1)(file)" == "file"
 }
 
-function page_404(url) {
+function default_page_404(url) {
 "<HTML><HEAD>
 <TITLE>404 Not Found</TITLE>
 </HEAD><BODY>
@@ -551,6 +551,28 @@ function config(c,r) {
 	do_print page_config()
 }
 
+function write_page(c,file,ext,code) {
+	IO.write c.out (sprintf "HTTP/1.1 %d %s\r\n" code);
+	var ctype = try { List.assoc ext mime } catch { Not_found -> "unknown/unknown" };
+	var file_size : int = neko "$loader.loadprim('std@sys_stat',1)(file).size";
+	IO.write c.out ("Content-Type: " + ctype + "\r\n");
+	IO.write c.out ("Content-Length: " + file_size + "\r\n");
+	IO.write c.out "\r\n";
+	var fin = IO.read_file file true;
+	var bufsize = 100000;
+	var n = &(file_size / bufsize);
+	try {
+		while *n > 0 {
+			IO.write c.out IO.read(fin,bufsize);
+			n := *n - 1;
+		}
+		IO.write c.out IO.read(fin,file_size % bufsize);
+	} catch {
+		e -> IO.close_in fin; throw e
+	}
+	IO.close_in fin
+}
+
 function client_msg(c) {
 	var r = parse_http_request c;
 	cur_client := Some c;
@@ -558,8 +580,21 @@ function client_msg(c) {
 		config(c,r)
 	else match find_url_file r.res true {
 	| None ->
-		c.return_code := (404,"Not Found");
-		do_print page_404(r.res);
+		function rec loop(l) {
+			match l {
+			| [] ->
+				c.return_code := (404, "Not Found");
+				do_print default_page_404(r.res);
+			| f :: l ->
+				match find_url_file f false {
+				| Some page_404 ->
+					var ext = String.lowercase (Sys.extension page_404);
+					write_page c page_404 ext (404, "Not Found")
+				| None -> loop(l)
+				}
+			}
+		}
+		loop ["404.html"; "404.htm"];
 	| Some file ->
 		var ext = String.lowercase (Sys.extension file);
 		if ext == "n" then {
@@ -570,25 +605,7 @@ function client_msg(c) {
 			mod_neko c r file
 		} else {
 			// directly send the file content
-			IO.write c.out "HTTP/1.1 200 OK\r\n";
-			var ctype = try { List.assoc ext mime } catch { Not_found -> "unknown/unknown" };
-			var file_size : int = neko "$loader.loadprim('std@sys_stat',1)(file).size";
-			IO.write c.out ("Content-Type: " + ctype + "\r\n");
-			IO.write c.out ("Content-Length: " + file_size + "\r\n");
-			IO.write c.out "\r\n";
-			var fin = IO.read_file file true;
-			var bufsize = 100000;
-			var n = &(file_size / bufsize);
-			try {
-				while *n > 0 {
-					IO.write c.out IO.read(fin,bufsize);
-					n := *n - 1;
-				}
-				IO.write c.out IO.read(fin,file_size % bufsize);
-			} catch {
-				e -> IO.close_in fin; throw e
-			}
-			IO.close_in fin
+			write_page c file ext (200, "OK");
 		}
 	}
 }
@@ -607,7 +624,7 @@ function client_msg_safe(c) {
 }
 
 function init() {
-	var head = "Neko Web Server v1.0 - (c)2005-2017 Haxe Foundation";
+	var head = "Neko Web Server v1.0 - (c)2005-2022 Haxe Foundation";
 	var port = &2000;
 	var host = &"localhost";
 	var decl = [
@@ -626,4 +643,3 @@ function init() {
 	log "Starting Neko Server on %s:%d" (*host,*port);
 	Net.start_server Net.host_resolve(*host) (*port) init_client client_msg_safe;
 }
-
diff --git a/src/tools/makedoc.neko b/src/tools/makedoc.neko
index ca8b90a..e13c3ff 100644
--- a/src/tools/makedoc.neko
+++ b/src/tools/makedoc.neko
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -19,7 +19,7 @@
  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
  * DEALINGS IN THE SOFTWARE.
  */
- 
+
 readdir = $loader.loadprim("std@sys_read_dir",1);
 command = $loader.loadprim("std@sys_command",1);
 
diff --git a/src/tools/nekoboot.neko b/src/tools/nekoboot.neko
index 00296ec..dfbf3b7 100644
--- a/src/tools/nekoboot.neko
+++ b/src/tools/nekoboot.neko
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/alloc.c b/vm/alloc.c
index 3da78cb..8a3986a 100644
--- a/vm/alloc.c
+++ b/vm/alloc.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/builtins.c b/vm/builtins.c
index e7e3141..5d73112 100644
--- a/vm/builtins.c
+++ b/vm/builtins.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -22,6 +22,7 @@
 #include <string.h>
 #include <stdlib.h>
 #include <math.h>
+#include <ctype.h>
 #include "neko.h"
 #include "objtable.h"
 #include "vm.h"
@@ -969,6 +970,12 @@ static value builtin_isinfinite( value f ) {
 	return alloc_bool( h == 0x7FF00000 && l == 0 );
 }
 
+static inline bool has_hex_prefix( const char *c, int len, bool is_signed ) {
+	if (is_signed)
+		return len >= 3 && c[1] == '0' && (c[2] == 'x' || c[2] == 'X');
+	return len >= 2 && c[0] == '0' && (c[1] == 'x' || c[1] == 'X');
+}
+
 /**
 	$int : any -> int?
 	<doc>Convert the value to the corresponding integer or return [null]</doc>
@@ -986,9 +993,13 @@ static value builtin_int( value f ) {
 	case VAL_STRING: {
 		char *c = val_string(f), *end;
 		int h;
-		if( val_strlen(f) >= 2 && c[0] == '0' && (c[1] == 'x' || c[1] == 'X') ) {
+		// skip trailing whitespace for hex check
+		while( isspace(*c) ) ++c;
+		char sign = c[0];
+		bool is_signed = sign == '-' || sign == '+';
+		if( has_hex_prefix(c,val_strlen(f),is_signed) ) {
 			h = 0;
-			c += 2;
+			c += is_signed ? 3 : 2;
 			while( *c ) {
 				char k = *c++;
 				if( k >= '0' && k <= '9' )
@@ -998,12 +1009,15 @@ static value builtin_int( value f ) {
 				else if( k >= 'a' && k <= 'f' )
 					h = (h << 4) | ((k - 'a') + 10);
 				else
-					return val_null;
+					break;
 			}
-			return alloc_best_int(h);
+			if( sign == '-' ) h = -h;
+		} else {
+			h = strtol(c,&end,10);
+			if( c == end )
+				return val_null;
 		}
-		h = strtol(c,&end,10);
-		return ( c == end ) ? val_null : alloc_best_int(h);
+		return alloc_best_int(h);
 		}
 	case VAL_INT:
 	case VAL_INT32:
@@ -1493,6 +1507,14 @@ static value builtin_version() {
 	return alloc_int(NEKO_VERSION);
 }
 
+/**
+	$neko_build_year : void -> int
+	<doc>Return the year that Neko was compiled.</doc>
+**/
+static value builtin_neko_build_year() {
+	return alloc_int(NEKO_BUILD_YEAR);
+}
+
 /**
 	$setresolver : function:2? -> void
 	<doc>Set a function to callback with object and field id when an object field is not found.</doc>
@@ -1604,6 +1626,7 @@ void neko_init_builtins() {
 	BUILTIN(excstack,0);
 	BUILTIN(callstack,0);
 	BUILTIN(version,0);
+	BUILTIN(neko_build_year,0);
 	BUILTIN(setresolver,1);
 }
 
diff --git a/vm/callback.c b/vm/callback.c
index 7196f0e..23cb023 100644
--- a/vm/callback.c
+++ b/vm/callback.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -93,16 +93,16 @@ EXTERN value val_callEx( value vthis, value f, value *args, int nargs, value *ex
 		} else if( ((vfunction*)f)->nargs == -1 )
 			ret = (value)((c_primN)((vfunction*)f)->addr)(args,nargs);
 		else
-			val_throw(alloc_string("Invalid call"));		
+			val_throw(alloc_string("Invalid call"));
 		if( ret == NULL )
-			val_throw( (value)((vfunction*)f)->module );		
+			val_throw( (value)((vfunction*)f)->module );
 	} else if( val_short_tag(f) == VAL_FUNCTION ) {
 		if( nargs == ((vfunction*)f)->nargs )  {
 			int n;
 			if( vm->csp + 4 >= vm->sp - nargs && !neko_stack_expand(vm->sp,vm->csp,vm) ) {
 				if( exc ) {
 					neko_process_trap(vm);
-					memcpy(&vm->start,&oldjmp,sizeof(jmp_buf));	
+					memcpy(&vm->start,&oldjmp,sizeof(jmp_buf));
 				}
 				failure("Stack Overflow");
 			} else {
@@ -117,7 +117,7 @@ EXTERN value val_callEx( value vthis, value f, value *args, int nargs, value *ex
 					ret = neko_interp(vm,((vfunction*)f)->module,(int_val)val_null,(int_val*)((vfunction*)f)->addr);
 				} else {
 					neko_module *m = (neko_module*)((vfunction*)f)->module;
-					ret = ((jit_prim)jit_boot_seq)(vm,((vfunction*)f)->addr,val_null,m);			
+					ret = ((jit_prim)jit_boot_seq)(vm,((vfunction*)f)->addr,val_null,m);
 				}
 			}
 		}
@@ -127,7 +127,7 @@ EXTERN value val_callEx( value vthis, value f, value *args, int nargs, value *ex
 		val_throw(alloc_string("Invalid call"));
 	if( exc ) {
 		neko_process_trap(vm);
-		memcpy(&vm->start,&oldjmp,sizeof(jmp_buf));	
+		memcpy(&vm->start,&oldjmp,sizeof(jmp_buf));
 	}
 	vm->vthis = old_this;
 	vm->env = old_env;
diff --git a/vm/hash.c b/vm/hash.c
index 9d33958..2b1daf7 100644
--- a/vm/hash.c
+++ b/vm/hash.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -49,7 +49,7 @@ static void hash_rec( value v, int *h, vlist *l ) {
 		HSMALL(0);
 		break;
 	case VAL_FLOAT:
-		{ 
+		{
 			int k = sizeof(tfloat);
 			while( k )
 				HSMALL(val_string(v)[--k]);
diff --git a/vm/interp.c b/vm/interp.c
index f11ca03..c4292c7 100644
--- a/vm/interp.c
+++ b/vm/interp.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/jit_x86.c b/vm/jit_x86.c
index 3b01df2..abc13f2 100644
--- a/vm/jit_x86.c
+++ b/vm/jit_x86.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -1323,7 +1323,7 @@ static void jit_number_op( jit_ctx *ctx, enum Operation op ) {
 	XMov_rp(TMP2,TMP,FIELD(0));
 	XCmp_rb(TMP2,VAL_FLOAT);
 	XJump(JNeq,jnot_float2);
-	
+
 	// load floats
 	XAdd_rc(ACC,4);
 	XFLd_i(ACC);
@@ -1358,7 +1358,7 @@ static void jit_number_op( jit_ctx *ctx, enum Operation op ) {
 	}
 	if( op != OP_MOD ) {
 		stack_push(Esp,2);
-	}	
+	}
 	XFStp_i(Esp);
 	XCall_m(alloc_float);
 	stack_pop(Esp,2);
@@ -1371,7 +1371,7 @@ static void jit_number_op( jit_ctx *ctx, enum Operation op ) {
 	PATCH_JUMP(jnot_int2);
 
 	begin_call();
-	XPush_c(GET_PC());	
+	XPush_c(GET_PC());
 	XPush_r(ACC);
 	XPush_r(TMP);
 	XPush_r(VM);
@@ -1477,7 +1477,7 @@ static void jit_int_op( jit_ctx *ctx, enum IOperation op ) {
 	}
 	stack_pop(Esp,4);
 	end_call();
-	
+
 	PATCH_JUMP(jend);
 	pop(1);
 
diff --git a/vm/load.c b/vm/load.c
index 85002c4..ab95af5 100644
--- a/vm/load.c
+++ b/vm/load.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/main.c b/vm/main.c
index f129d60..5dfc666 100644
--- a/vm/main.c
+++ b/vm/main.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -302,7 +302,7 @@ int main( int argc, char *argv[] ) {
 #			ifdef NEKO_STANDALONE
 			report(vm,alloc_string("No embedded module in this executable"),0);
 #			else
-			printf("NekoVM %d.%d.%d (c)2005-2017 Haxe Foundation\n  Usage : neko <file>\n",NEKO_VERSION_MAJOR,NEKO_VERSION_MINOR,NEKO_VERSION_PATCH);
+			printf("NekoVM %d.%d.%d (c)2005-%d Haxe Foundation\n  Usage : neko <file>\n",NEKO_VERSION_MAJOR,NEKO_VERSION_MINOR,NEKO_VERSION_PATCH,NEKO_BUILD_YEAR);
 #			endif
 			mload = NULL;
 			r = 1;
diff --git a/vm/module.c b/vm/module.c
index e2ed389..78198f7 100644
--- a/vm/module.c
+++ b/vm/module.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/neko.h.in b/vm/neko.h.in
index 4734505..d211880 100644
--- a/vm/neko.h.in
+++ b/vm/neko.h.in
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -74,7 +74,7 @@
 #	define NEKO_PPC
 #endif
 
-#if defined(_64BITS) || defined(__x86_64__)
+#if defined(_64BITS) || defined(__x86_64__) || defined(_M_AMD64)
 #	define NEKO_64BITS
 #endif
 
@@ -116,6 +116,8 @@
 #define NEKO_VERSION_PATCH	@NEKO_VERSION_PATCH@
 #define NEKO_VERSION		@NEKO_VERSION_MAJOR@@NEKO_VERSION_MINOR@@NEKO_VERSION_PATCH@
 
+#define NEKO_BUILD_YEAR		@NEKO_BUILD_YEAR@
+
 #define NEKO_MODULE_PATH	"@NEKO_MODULE_PATH@"
 
 typedef intptr_t int_val;
diff --git a/vm/neko_mod.h b/vm/neko_mod.h
index e3cfd9e..a6e6c94 100644
--- a/vm/neko_mod.h
+++ b/vm/neko_mod.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/neko_vm.h b/vm/neko_vm.h
index 455f1cf..689725d 100644
--- a/vm/neko_vm.h
+++ b/vm/neko_vm.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/objtable.c b/vm/objtable.c
index 977bb10..fe13e0c 100644
--- a/vm/objtable.c
+++ b/vm/objtable.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/objtable.h b/vm/objtable.h
index 19e904a..c3a343c 100644
--- a/vm/objtable.h
+++ b/vm/objtable.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/opcodes.h b/vm/opcodes.h
index 99ddd83..4b8ac79 100644
--- a/vm/opcodes.h
+++ b/vm/opcodes.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/others.c b/vm/others.c
index a1352e2..415a2df 100644
--- a/vm/others.c
+++ b/vm/others.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/stats.c b/vm/stats.c
index 2a6f79e..1d5bf06 100644
--- a/vm/stats.c
+++ b/vm/stats.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
@@ -103,7 +103,7 @@ void neko_stats_measure( neko_vm *vm, const char *kind, int start ) {
 		// add to stack
 		s->ncalls++;
 		s->stack = stack;
-		stack = s;		
+		stack = s;
 		s->starttime = time;
 	} else {
 		// lookup on stack
@@ -156,11 +156,11 @@ static statinfos *sort( statinfos *list ) {
 			qsize = insize;
 			while (psize > 0 || (qsize > 0 && q)) {
 				if( psize == 0 ) {
-					e = q; q = q->next; qsize--;					
+					e = q; q = q->next; qsize--;
 				} else if( qsize == 0 || !q ) {
-					e = p; p = p->next; psize--;					
+					e = p; p = p->next; psize--;
 				} else if( cmp(p,q) <= 0 ) {
-					e = p; p = p->next; psize--;					
+					e = p; p = p->next; psize--;
 				} else {
 					e = q; q = q->next; qsize--;
 				}
@@ -174,7 +174,7 @@ static statinfos *sort( statinfos *list ) {
 		}
 		tail->next = NULL;
 		if( nmerges <= 1 )
-            return list;        
+            return list;
         insize *= 2;
     }
 	return NULL;
diff --git a/vm/threads.c b/vm/threads.c
index 7ca34b2..524d9ac 100644
--- a/vm/threads.c
+++ b/vm/threads.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
diff --git a/vm/vm.h b/vm/vm.h
index 5571e1f..149b553 100644
--- a/vm/vm.h
+++ b/vm/vm.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C)2005-2017 Haxe Foundation
+ * Copyright (C)2005-2022 Haxe Foundation
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the "Software"),
